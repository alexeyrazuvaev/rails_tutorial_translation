<div id="top"></div>


<h1 class="chapter"><a id="sec-9" href="updating-showing-and-deleting-users#top" class="heading"><span class="number">Глава 9</span> Обновление, демонстрация и удаление пользователей</a></h1>


<p>В этой главе мы завершим REST действия для ресурса Users (<a class="ref" href="sign-up#table-RESTful_users">Таблица&nbsp;7.1</a>) добавив <code>edit</code>, <code>update</code>, <code>index</code>, и <code>destroy</code> действия. Мы начнем с того, что дадим пользователям возможность обновлять свои профили, что также обеспечит естественную возможность для обеспечения модели безопасности (стало возможным, благодаря аутентификационному коду из <a class="ref" href="sign-in-sign-out#top">Главы&nbsp;8</a>). Затем мы сделаем список всех пользователей (также требует авторизации), что будет поводом для внедрения образцов данных и постраничного вывода (пагинации). Наконец, мы также добавим возможность удалять пользователей, стиранием их в базе данных. Так как мы не можем позволить любому пользователю обладать такими опасными возможностями, мы позаботимся о создании привилегированного класса административных пользователей (администраторов), авторизованных для удаления других пользователей.</p>

<p>Мы начнем с создания отдельной ветки <code>updating-users</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b updating-users
</pre></div>
</div>


<div class="label" id="sec-updating_users"></div>


<h2><a id="sec-9_1" href="updating-showing-and-deleting-users#sec-updating_users" class="heading"><span class="number">9.1</span> Обновление пользователей</a></h2>


<p>Основная идея редактирования информации о пользователе тесно параллельна созданию новых пользователей (<a class="ref" href="sign-up#top">Глава&nbsp;7</a>). Вместо <code>new</code> действия визуализирующего представление для нового пользователя, мы имеем <code>edit</code> действие, отображающее представление для редактирования пользователей; вместо <code>create</code> отвечающего на запрос <tt>POST</tt>, мы имеем <code>update</code> действие, отвечающее на запрос <tt>PUT</tt> (<a class="ref" href="static-pages#sidebar-get_etc">Блок&nbsp;3.2</a>). Основное отличие заключается в том, что зарегистрироваться может любой человек, но только текущий пользователь должен иметь возможность обновлять свою информацию. Это означает, что нам необходимо обеспечить контроль доступа таким образом, чтобы только авторизированные пользователи могли редактировать и обновлять информацию; аутентификационный механизм из <a class="ref" href="sign-in-sign-out#top">Главы&nbsp;8</a> позволит нам использовать <em>предфильтр</em> для обеспечения этого вида контроля.</p>

<div class="label" id="sec-edit_form"></div>


<h3><a id="sec-9_1_1" href="updating-showing-and-deleting-users#sec-edit_form" class="heading"><span class="number">9.1.1</span> Форма для редактирования</a></h3>


<p>Мы начнем с формы редактирования, набросок которой представлен на <a class="ref" href="updating-showing-and-deleting-users#fig-edit_user_mockup">Рис.&nbsp;9.1</a>.<sup class="footnote" id="fnref-9_1"><a href="#fn-9_1">1</a></sup> Как обычно, мы начнем с тестов. Во-первых, обратите внимание на ссылку для смены изображения Gravatar; если вы зайдете на сайт Gravatar, вы увидите, что страница для добавления или редактирования изображений находится по адресу <a href="http://gravatar.com/emails">http://gravatar.com/emails</a>, и мы протестируем наличие на странице <code>edit</code> этого URI.<sup class="footnote" id="fnref-9_2"><a href="#fn-9_2">2</a></sup></p>

<div class="label" id="fig-edit_user_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_user_mockup_bootstrap.png" alt="edit_user_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.1: </span><span class="description">Набросок страницы для редактирования пользователя.&nbsp;<a href="http://railstutorial.org/images/figures/edit_user_mockup_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Тесты для формы редактирования пользователя аналогичны тестам для формы создания нового пользователя в <a class="ref" href="sign-up#code-error_messages_test">Листинге&nbsp;7.31</a> из упражнений <a class="ref" href="sign-up#top">Главы&nbsp;7</a>, которые добавляют тест для сообщения об ошибке при отправке неверных данных. Результат представлен в <a class="ref" href="updating-showing-and-deleting-users#code-user_edit_specs">Листинге&nbsp;9.1</a>.</p>

<div class="label" id="code-user_edit_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.1.</span> <span class="description">Тесты для страницы редактирования пользователя. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;page&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s2">&quot;Update your profile&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="s1">&#39;http://gravatar.com/emails&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Save changes&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для того чтобы написать код приложения, нам необходимо заполнить действие <code>edit</code> контоллера Users. <a class="ref" href="sign-up#table-RESTful_users">Таблица&nbsp;7.1</a> указывает на то, что правильным URI для страницы редактирования пользователя является /users/1/edit (предполагается что id пользователя равен&nbsp;<tt>1</tt>). Вспомните что id пользователя доступен в переменной <code>params[:id]</code>, а это означает что мы можем найти пользователя с помощью кода в  <a class="ref" href="updating-showing-and-deleting-users#code-initial_edit_action">Листинг&nbsp;9.2</a>.</p>

<div class="label" id="code-initial_edit_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.2.</span> <span class="description">Действие <code>edit</code> контроллера Users. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для прохождения этих тестов требуется создание соответствующего (edit) представления, показанного в <a class="ref" href="updating-showing-and-deleting-users#code-user_edit_view">Листинге&nbsp;9.3</a>. Обратите внимание, как сильно оно походит на представление new user из <a class="ref" href="sign-up#code-signup_form">Листинга&nbsp;7.17</a>; большое перекрытие предполагает факторинг повторяющгося кода в партиал, который мы оставим в качестве упражнения (<a class="ref" href="updating-showing-and-deleting-users#sec-updating_deleting_exercises">Раздел&nbsp;9.6</a>).</p>

<div class="label" id="code-user_edit_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.3.</span> <span class="description">Представление user edit. <br /> <code>app/views/users/edit.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirm Password&quot;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Save changes&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Здесь мы повторно использовали общедоступный партиал <code>error_messages</code>, введеный в <a class="ref" href="sign-up#sec-signup_error_messages">Разделе&nbsp;7.3.2</a>.</p>

<p>С переменной экземпляра <code>@user</code> из <a class="ref" href="updating-showing-and-deleting-users#code-initial_edit_action">Листинга&nbsp;9.2</a>, тесты для страницы редактирования из <a class="ref" href="updating-showing-and-deleting-users#code-user_edit_specs">Листинга&nbsp;9.1</a> должны пройти:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;edit page&quot;</span>
</pre></div>
</div>


<p>Соответствующая страниц показана на <a class="ref" href="updating-showing-and-deleting-users#fig-edit_page">Рис.&nbsp;9.2</a>, который показывает, как Rails автоматически предзаполняет Name и Email поля используя аттрибуты переменной <code>@user</code>.</p>

<div class="label" id="fig-edit_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_page_bootstrap.png" alt="edit_page_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.2: </span><span class="description">Начальная страница редактирования пользователя с предзаполненными полями Name &amp; Email.&nbsp;<a href="http://railstutorial.org/images/figures/edit_page_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Посмотрев на исходный HTML для <a class="ref" href="updating-showing-and-deleting-users#fig-edit_page">Рис.&nbsp;9.2</a>, как и ожидалось, мы видим тег формы (<a class="ref" href="updating-showing-and-deleting-users#code-edit_form_html">Листинг&nbsp;9.4</a>).</p>

<div class="label" id="code-edit_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.4.</span> <span class="description">HTML для формы редактирования определенной в <a class="ref" href="updating-showing-and-deleting-users#code-user_edit_view">Листинге&nbsp;9.3</a> и показанной на <a class="ref" href="updating-showing-and-deleting-users#fig-edit_page">Рис.&nbsp;9.2</a>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users/1&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_user&quot;</span> <span class="na">id=</span><span class="s">&quot;edit_user_1&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>Обратите внимание на скрытое поле ввода</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Поскольку веб-браузеры сами по себе не могут отправлять <tt>PUT</tt> запросы (как это требует от них  REST конвенция из <a class="ref" href="sign-up#table-RESTful_users">Таблицы&nbsp;7.1</a>), Rails подделывает иx с помощью <tt>POST</tt> запроса и скрытого поля <code>input</code>.<sup class="footnote" id="fnref-9_3"><a href="#fn-9_3">3</a></sup></p>

<p>Стоит также упомянуть здесь еще одну тонкость: код <code>form_for(@user)</code> в <a class="ref" href="updating-showing-and-deleting-users#code-user_edit_view">Листинге&nbsp;9.3</a> <em>абсолютно</em> совпадает с кодом в <a class="ref" href="sign-up#code-signup_form">Листинге&nbsp;7.17</a> &mdash; так как же Rails узнает, что нужно использовать <tt>POST</tt> запрос для новых пользователей и  <tt>PUT</tt> для редактирования уже существующих? Ответ кроется в возможности определения того, что мы имеем дело с новым или уже существующим в базе данных пользователем, посредством булевого метода <code>new_record?</code> библиотеки Active Record:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>При построении формы с помощью <code>form_for(@user)</code>, Rails использует <tt>POST</tt> если <code>@user.new_record?</code> это <code>true</code> и <tt>PUT</tt> если это является <code>false</code>.</p>

<p>В качестве финального штриха мы добавим URI к ссылке на настройки пользователя в навигации сайта. Поскольку она зависит от статуса вошедшего, тест для ссылки &ldquo;Settings&rdquo; относится к остальным тестам аутентификации, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-settings_link_test">Листинге&nbsp;9.5</a>. (Было бы неплохо иметь дополнительные тесты которые проверяли бы что подобные ссылки <em>не</em> видны невошедшим пользователям; написание этих тестов остается в качестве упражнения (<a class="ref" href="updating-showing-and-deleting-users#sec-updating_deleting_exercises">Раздел&nbsp;9.6</a>).)</p>

<div class="label" id="code-settings_link_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.5.</span> <span class="description">Добавление теста для ссылки &ldquo;Settings&rdquo;. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span>  <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Settings&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для удобства, код в <a class="ref" href="updating-showing-and-deleting-users#code-settings_link_test">Листинге&nbsp;9.5</a> использует хелпер для входа пользователя внутри тестов. Методика заключается в посещении страницы и отправке валидной информации, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-sign_in_helper">Листинге&nbsp;9.6</a>.</p>

<div class="label" id="code-sign_in_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.6.</span> <span class="description">Тестовый хелпер для входа пользователей. <br /> <code>spec/support/utilities.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
  <span class="c1"># Вход без Capybara.</span>
  <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Как было отмечено в комментарии, заполнение формы не работает без Capybara, так что, для того чтобы покрыть этот случай мы также добавляем пользовательский remember token в куки:</p>

<div class="code"><div class="highlight"><pre><span class="c1"># Вход без Capybara.</span>
<span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</pre></div>
</div>


<p>Это необходимо при непосредственном использовании одного из методов HTTP запросов (<code>get</code>, <code>post</code>, <code>put</code> или <code>delete</code>), как мы увидим в <a class="ref" href="updating-showing-and-deleting-users#code-delete_destroy_test">Листинге&nbsp;9.47</a>. (Обратите внимание, что тестовый объект <code>cookies</code> это далеко не идеальная симуляция реального объекта куки; в частности, метод <code>cookies.permanent</code> виденный нами в <a class="ref" href="sign-in-sign-out#code-sign_in_function">Листинге&nbsp;8.19</a> не работает внутри тестов.) Как вы можете ожидать, метод <code>sign_in</code> может пригодиться и в будущих тестах, и, фактически, он уже может быть использован для устранения некоторых случаев дублирования (<a class="ref" href="updating-showing-and-deleting-users#sec-updating_deleting_exercises">Раздел&nbsp;9.6</a>).</p>

<p>Код для добавления URI к ссылке &ldquo;Settings&rdquo; прост: мы просто применим именованный маршрут <code>edit_user_path</code> из <a class="ref" href="sign-up#table-RESTful_users">Таблицы&nbsp;7.1</a>, совместно с удобным вспомогательным методом <code>current_user</code> определенным в <a class="ref" href="sign-in-sign-out#code-current_user_working">Листинге&nbsp;8.22</a>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Полный код приложения представлен в <a class="ref" href="updating-showing-and-deleting-users#code-settings_link">Листинге&nbsp;9.7</a>).</p>

<div class="label" id="code-settings_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.7.</span> <span class="description">Добавление ссылки &ldquo;Settings&rdquo;. <br /> <code>app/views/layouts/_header.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec-unsuccessful_edits"></div>


<h3><a id="sec-9_1_2" href="updating-showing-and-deleting-users#sec-unsuccessful_edits" class="heading"><span class="number">9.1.2</span> Провальное редактирование</a></h3>


<p>В этом разделе мы обработаем случай провального редактирования и получим прохождение теста сообщения об ошибке <a class="ref" href="updating-showing-and-deleting-users#code-user_edit_specs">Листинг&nbsp;9.1</a>. Код приложения создает действие <code>update</code> которое использует <code>update_attributes</code> (<a class="ref" href="modeling-users#sec-updating_user_objects">Раздел&nbsp;6.1.5</a>) для обновления пользователя на основе отправленного хэша <code>params</code>, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-user_update_action_unsuccessful">Листинге&nbsp;9.8</a>. С невалидной информацией, попытка обновления вернет <code>false</code> и ветка <code>else</code> заново отрендерит страницу редактирования. Мы видели этот способ ранее; структура очень похожа на первую версию действия <code>create</code> (<a class="ref" href="sign-up#code-first_create_action">Листинг&nbsp;7.21</a>).</p>

<div class="label" id="code-user_update_action_unsuccessful"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.8.</span> <span class="description">Начальное действие <code>update</code> контроллера Users. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Handle a successful update.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Получившееся в результате сообщение об ошибке (<a class="ref" href="updating-showing-and-deleting-users#fig-edit_with_invalid_information">Рис.&nbsp;9.3</a>) - именно то что нам нужно для прохождения теста, что вам следует проверить запустив набор тестов:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<div class="label" id="fig-edit_with_invalid_information"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_with_invalid_information_bootstrap.png" alt="edit_with_invalid_information_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.3: </span><span class="description">Сообщение об ошибке после отправления формы обновления.&nbsp;<a href="http://railstutorial.org/images/figures/edit_with_invalid_information_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec-successful_edits"></div>


<h3><a id="sec-9_1_3" href="updating-showing-and-deleting-users#sec-successful_edits" class="heading"><span class="number">9.1.3</span> Успешное редактирование</a></h3>


<p>Теперь пришло время заставить работать форму редактирования. Редактирование профильных изображений уже работает поскольку мы переложили загрузку изображений на Gravatar; мы можем отредактировать граватар, кликнув по ссылке &ldquo;change&rdquo;, показанной на <a class="ref" href="updating-showing-and-deleting-users#fig-edit_page">Рис.&nbsp;9.2</a>, как это показано на <a class="ref" href="updating-showing-and-deleting-users#fig-gravatar_cropper">Рис.&nbsp;9.4</a>. Давайте заставим работать остальной функционал редактирования пользователя.</p>

<div class="label" id="fig-gravatar_cropper"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/gravatar_cropper.png" alt="gravatar_cropper" /></span></div><div class="caption"><span class="header">Рисунок 9.4: </span><span class="description">Интерфейс обрезки изображений  <a href="http://gravatar.com/">Gravatar</a> с фоткой какого-то <a href="http://michaelhartl.com/">чувака</a>.</span></div></div>


<p>Тесты для <code>update</code> действия похожи на аналогичные для <code>create</code> действия. <a class="ref" href="updating-showing-and-deleting-users#code-user_update_specs">Листинг&nbsp;9.9</a> показывает как использовать Capybara для заполнения полей формы валидной информацией, а затем тестирует, что результирующее поведение корректно. Это большой кусок кода; посмотрим, сможете ли вы проработать его, опираясь на тесты из <a class="ref" href="sign-up#top">Главы&nbsp;7</a>.</p>

<div class="label" id="code-user_update_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.9.</span> <span class="description">Тесты для <code>update</code> действия контроллера Users. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_name</span><span class="p">)</span>  <span class="p">{</span> <span class="s2">&quot;New Name&quot;</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;new@example.com&quot;</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>             <span class="ss">with:</span> <span class="n">new_name</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>            <span class="ss">with:</span> <span class="n">new_email</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirm Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Save changes&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">new_name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-success&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="n">new_name</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_email</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Единственной новинкой в <a class="ref" href="updating-showing-and-deleting-users#code-user_update_specs">Листинге&nbsp;9.9</a> является метод <code>reload</code>, который появляется в тесте для изменения атрибутов пользователя:</p>

<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="n">new_name</span> <span class="p">}</span>
<span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_email</span> <span class="p">}</span>
</pre></div>
</div>


<p>Этот код перезагружает <code>user</code> переменную из (тестовой) базы данных используя <code>user.reload</code>, а затем проверяет, что новые имя пользователя и email совпадают с новыми значениями.</p>

<p>Действие <code>update</code>, необходимое для прохождения тестов в <a class="ref" href="updating-showing-and-deleting-users#code-user_update_specs">Листинге&nbsp;9.9</a> аналогично финальной форме <code>create</code> действия (<a class="ref" href="sign-in-sign-out#code-signin_upon_signup">Листинг&nbsp;8.27</a>), как видно в <a class="ref" href="updating-showing-and-deleting-users#code-user_update_action">Листинге&nbsp;9.10</a>. Единственное что он делает, это добавляет</p>

<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
<span class="n">sign_in</span> <span class="vi">@user</span>
<span class="n">redirect_to</span> <span class="vi">@user</span>
</pre></div>
</div>


<p>к коду в <a class="ref" href="updating-showing-and-deleting-users#code-user_update_action_unsuccessful">Листинге&nbsp;9.8</a>. Обратите внимание, что мы "входим" пользователя для успешного обновления его информации; это связано с тем, что remember token сбрасывается при сохранении пользователя (<a class="ref" href="sign-in-sign-out#code-before_save_create_remember_token">Листинг&nbsp;8.18</a>), что делает невалидной сессию пользователя (<a class="ref" href="sign-in-sign-out#code-current_user_working">Листинг&nbsp;8.22</a>). Это хорошая фича безопасности, поскольку это означает, что любая украденная сессия автоматически истечет при изменении пользовательской информации.</p>

<div class="label" id="code-user_update_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.10.</span> <span class="description">Дейcтвие <code>update</code> контроллера Users. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание, что сейчас каждое редактирование требует от пользователя повторного подтверждения пароля (как следует из пустого текстового поля подтверждения на <a class="ref" href="updating-showing-and-deleting-users#fig-edit_page">Рис.&nbsp;9.2</a>), что делает обновление более безопасным, но вызывающим незначительное раздражение.</p>

<p>С кодом из этого раздела, страница редактирования пользователя должна работать, что вы можете проверить, перезапустив набор тестов, который в данный момент должен быть полностью зеленым:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-authorization"></div>


<h2><a id="sec-9_2" href="updating-showing-and-deleting-users#sec-authorization" class="heading"><span class="number">9.2</span> Авторизация</a></h2>


<p>Одним из приятных эффектов построения механизма аутентификации в <a class="ref" href="sign-in-sign-out#top">Главе&nbsp;8</a> является то, что мы теперь готовы к реализации авторизации: <em>аутентификация</em> позволяет нам идентифицировать пользователей нашего сайта, а <em>авторизация</em> позволяет нам контролировать предоставляемые им возможности.</p>

<p>Хотя edit и update действия из <a class="ref" href="updating-showing-and-deleting-users#sec-updating_users">Раздела&nbsp;9.1</a> функционально завершены, они страдают от нелепой бреши в безопасности: они позволяют любым (даже незарегистрированным)  пользователям иметь доступ к любому действию, и любой зарегистрированный пользователь может изменять информацию любого другого пользователя. В этом разделе мы реализуем модель безопасности, которая будет требовать от пользователей входа в систему и будет предотвращать обновление любой информации, кроме их собственной. Незарегистрированные пользователи, пытающиеся получить доступ к защищенным страницам будут перенаправлены на страницу входа с полезным сообщением, как это показано на <a class="ref" href="updating-showing-and-deleting-users#fig-signin_page_protected_mockup">Рис.&nbsp;9.5</a>.</p>

<div class="label" id="fig-signin_page_protected_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_page_protected_mockup_bootstrap.png" alt="signin_page_protected_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.5: </span><span class="description">Набросок результата посещения защищенной страницы&nbsp;<a href="http://railstutorial.org/images/figures/signin_page_protected_mockup_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec-requiring_signed_in_users"></div>


<h3><a id="sec-9_2_1" href="updating-showing-and-deleting-users#sec-requiring_signed_in_users" class="heading"><span class="number">9.2.1</span> Требование входа пользователей</a></h3>


<p>Поскольку ограничения безопасности для <code>edit</code> и <code>update</code> действий идентичны, мы будем обрабатывать их в одном  RSpec <code>describe</code> блоке. Начав с требования входа, наши первоначальные тесты затем проверяют, что не вошедшие пользователи, пытающиеся получить доступ к какому либо из действий, просто перенаправляеются на страницу входа, как показано в <a class="ref" href="updating-showing-and-deleting-users#code-protected_edit_update_tests">Листинге&nbsp;9.11</a>.</p>

<div class="label" id="code-protected_edit_update_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.11.</span> <span class="description">Тестирование того, что  <code>edit</code> и <code>update</code> действия защищены. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">&quot;visiting the edit page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the update action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Код в <a class="ref" href="updating-showing-and-deleting-users#code-protected_edit_update_tests">Листинге&nbsp;9.11</a> вводит второй способ, отличающийся от метода <code>visit</code> предоставляемого Capybara, для доступа к действию контроллера: выдавая соответствующий HTTP запрос непосредственно, в данном случае, с помощью метода <code>put</code> для выдачи запроса <tt>PUT</tt>:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;submitting to the update action&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Это выдает запрос <tt>PUT</tt> непосредственно к <code>/users/1</code>, который направляет к <code>update</code> действию контроллера Users (<a class="ref" href="sign-up#table-RESTful_users">Таблица&nbsp;7.1</a>). Это необходимо из-за того, что браузер не может посетить непосредственно само действие <code>update</code>  &mdash; он может лишь попасть туда через отправку формы редактирования &mdash; так что Capybara тоже не может этого сделать. Но посещение страницы редактирования тестирует только авторизацию для действия <code>edit</code>, но не для <code>update</code>. В результате, единственный способ как следует протестировать авторизацию для самого действия <code>update</code> это выдать непосредственный запрос. (Как вы можете догадаться, в дополнение к <code>put</code> Rails тесты поддерживают также <code>get</code>, <code>post</code>, и <code>delete</code>.)</p>

<p>При использовании одного из способов непосредственной выдачи HTTP запросов, мы получаем доступ к низкоуровневому объекту <code>response</code>. В отличие от объекта Capybara <code>page</code>, <code>response</code> позволяет нам тестировать сам ответ сервера, в данном случае, проверяя что действие <code>update</code> отвечает переадресацией на страницу входа:</p>

<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>Авторизационный код приложения использует <em>предфильтр</em>, который указывает конкретному методу быть вызванным до данных действий. Для того чтобы требовать от пользователей входа, мы определяем <code>signed_in_user</code> метод и вызываем его с помощью <code>before_filter :signed_in_user</code>, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-authorize_before_filter">Листинге&nbsp;9.12</a>.</p>

<div class="label" id="code-authorize_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.12.</span> <span class="description">Добавление предфильтра <code>signed_in_user</code>. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>По умолчанию, предфильтры применяются ко <em>всем</em> действиям контроллера, поэтому мы ограничиваем действие фильтра только <code>:edit</code> и <code>:update</code> действиями, посредством передачи соответствующего хэша опций <code>:only</code>.</p>

<p>Обратите внимание, что <a class="ref" href="updating-showing-and-deleting-users#code-authorize_before_filter">Листинг&nbsp;9.12</a> использует сокращение для установки <code>flash[:notice]</code> передавая хэш опций в функцию <code>redirect_to</code>. Код в <a class="ref" href="updating-showing-and-deleting-users#code-authorize_before_filter">Листинге&nbsp;9.12</a> эквивалентен более многословному</p>

<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Please sign in.&quot;</span>
<span class="n">redirect_to</span> <span class="n">signin_url</span>
</pre></div>
</div>


<p>(Аналогичная конструкция работает для ключа <code>:error</code>, но не для <code>:success</code>.)</p>

<p>Совместно с <code>:success</code> и <code>:error</code>, ключ <code>:notice</code> завершает наш триумвират отстиленных <code>flash</code>, поддерживаемых Bootstrap CSS фреймворком. Выйдя из сайта и попытавшись получить доступ к странице редактирования пользователя <a href="http://localhost:3000/users/1/edit">/users/1/edit</a>, мы можем увидеть результирующий желтый блок &ldquo;notice&rdquo;, как это показано на <a class="ref" href="updating-showing-and-deleting-users#fig-protected_sign_in">Рис.&nbsp;9.6</a>.</p>

<div class="label" id="fig-protected_sign_in"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/protected_sign_in_bootstrap.png" alt="protected_sign_in_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.6: </span><span class="description">Форма входа после попытки получить доступ к защищенной странице.&nbsp;<a href="http://railstutorial.org/images/figures/protected_sign_in_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>К сожалению, в процессе написания кода приложения необходимого для прохождения тестов авторизации из <a class="ref" href="updating-showing-and-deleting-users#code-protected_edit_update_tests">Листинга&nbsp;9.11</a>, мы сломали тесты из <a class="ref" href="updating-showing-and-deleting-users#code-user_edit_specs">Листинга&nbsp;9.1</a>. Код вроде</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>более не работает, поскольку для посещения пути редактирования пользователя пользователь должен быть вошедшим. Решение заключается во "входе" пользователя с помощью служебного метода <code>sign_in</code> из <a class="ref" href="updating-showing-and-deleting-users#code-sign_in_helper">Листинга&nbsp;9.6</a>, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-edit_update_tests_with_signin">Листинге&nbsp;9.13</a>.</p>

<div class="label" id="code-edit_update_tests_with_signin"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.13.</span> <span class="description">Добавление шага входа пользователя в тесты редактирования и обновления пользователя. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>В этой точке наш набор тестов должен решительно позеленеть:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-requiring_the_right_user"></div>


<h3><a id="sec-9_2_2" href="updating-showing-and-deleting-users#sec-requiring_the_right_user" class="heading"><span class="number">9.2.2</span> Требование правильного пользователя</a></h3>


<p>Конечно, требования входа пользователей недостаточно; пользователи должны иметь доступ к редактированию <em>только</em> своей информации. Мы можем протестировать это, вначале войдя как неправильный пользователь, а затем обратившись к <code>edit</code> и <code>update</code> действиям (<a class="ref" href="updating-showing-and-deleting-users#code-edit_update_wrong_user_tests">Листинг&nbsp;9.14</a>). Обратите внимание, что, так как пользователи никогда не должны даже <em>пытаться</em> изменить профиль другого пользователя, мы сделаем переадресацию не на страницу входа, а на корневой URL.</p>

<div class="label" id="code-edit_update_wrong_user_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.14.</span> <span class="description">Тестирование того, что действия <code>edit</code> и <code>update</code> требуют правильного пользователя. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;as wrong user&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:wrong_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;wrong@example.com&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;visiting Users#edit page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Edit user&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;submitting a PUT request to the Users#update action&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание на то, что фабрика может принимать опцию:</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;wrong@example.com&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Это создает пользователя с адресом электронной почты, отличающимся от дефолтного. Тесты описывают что этот пользователь не должен иметь доступа к действиям <code>edit</code> или <code>update</code> оригинального пользователя.</p>

<p>Код приложения добавляет второй предфильтр для вызова метода <code>correct_user</code>, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-correct_user_before_filter">Листинге&nbsp;9.15</a>.</p>

<div class="label" id="code-correct_user_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.15.</span> <span class="description">Предфильтр <code>correct_user</code> для защиты edit/update pages. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Фильтр <code>correct_user</code> использует булевый метод <code>current_user?</code>, который мы определили в хелпере Sessions (<a class="ref" href="updating-showing-and-deleting-users#code-current_user_p">Листинг&nbsp;9.16</a>).</p>

<div class="label" id="code-current_user_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.16.</span> <span class="description">Метод <code>current_user?</code>. <br /> <code>app/helpers/sessions_helper.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="updating-showing-and-deleting-users#code-correct_user_before_filter">Листинг&nbsp;9.15</a> также показывает обновленные <code>edit</code> и <code>update</code> действия. Ранее, в <a class="ref" href="updating-showing-and-deleting-users#code-initial_edit_action">Листинге&nbsp;9.2</a> мы имели</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>и аналогично для <code>update</code>. Но теперь, когда предфильтр <code>correct_user</code> определяет <code>@user</code>, мы можем опустить это для обоих действий.</p>

<p>Прежде чем двигаться дальше, вам следует проверить что набор тестов проходит:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-friendly_forwarding"></div>


<h3><a id="sec-9_2_3" href="updating-showing-and-deleting-users#sec-friendly_forwarding" class="heading"><span class="number">9.2.3</span> Дружелюбная переадресация</a></h3>


<p>Защита наших страниц закончена, как и было написано, но есть один небольшой недостаток: когда пользователи пытаются получить доступ к защищенной странице, они перенаправляются к странице профиля, независимо от того, куда они пытались попасть. Другими словами, если не залогинившийся пользователь пытается посетить страницу редактирования, после входа пользователь будет перенаправлен на <tt>/users/1</tt> вместо <tt>/users/1/edit</tt>. Было бы намного более доброжелательно, по отношению к пользователям, все же перенаправлять их на запрашиваемую страницу вместо этого .</p>

<p>Для того чтобы протестировать такую &ldquo;дружелюбную переадресацию&rdquo;, мы вначале посещаем страницу редактирования пользователя, которая перенаправит нас на страницу входа. Затем мы введем валидную информацию для входа и кликнем по кнопке &ldquo;Sign in&rdquo;. Результирующей страницей, которой по дефолту является профиль пользователя, в данном случае должна быть страница &ldquo;Edit user&rdquo;. Тест для этой последовательности представлен в <a class="ref" href="updating-showing-and-deleting-users#code-friendly_forwarding_test">Листинге&nbsp;9.17</a>.</p>

<div class="label" id="code-friendly_forwarding_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.17.</span> <span class="description">Тест для дружелюбной переадресации. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;when attempting to visit a protected page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;after signing in&quot;</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">&quot;should render the desired protected page&quot;</span> <span class="k">do</span>
            <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Edit user&#39;</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Теперь реализация.<sup class="footnote" id="fnref-9_4"><a href="#fn-9_4">4</a></sup> Для того чтобы перенаправить пользователей к запрашиваемой ими странице, нам нужно где-то сохранить запрашиваемую страницу, а затем переадресовать к ней. Мы добьемся этого с помощью пары методов, <code>store_location</code> и <code>redirect_back_or</code>, определенных в хелпере Sessions (<a class="ref" href="updating-showing-and-deleting-users#code-friendly_forwarding_code">Листинг&nbsp;9.18</a>).</p>


<div class="label" id="code-friendly_forwarding_code"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.18.</span> <span class="description">Код реализующий дружественную переадресацию. <br /> <code>app/helpers/sessions_helper.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:return_to</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">store_location</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Механизм хранения это возможность <code>session</code> предоставляемая Rails, о которой вы можете думать как об экземпляре переменной <code>cookies</code> из <a class="ref" href="sign-in-sign-out#sec-remember_me">Раздела&nbsp;8.2.1</a> которая автоматически истекает при закрытии браузера. Мы также используем объект <code>request</code> для получения <code>url</code>, т.e. URI/URL запрашиваемой страницы. Метод <code>store_location</code> помещает запрашиваемый URI в переменную <code>session</code> под ключом <code>:return_to</code>.</p>

<p>Для того чтобы использовать <code>store_location</code>, нам необходимо добавить ее в предфильтр <code>signed_in_user</code>, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-add_store_location">Листинге&nbsp;9.19</a>.</p>

<div class="label" id="code-add_store_location"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.19.</span> <span class="description">Добавление <code>store_location</code> в предфильтр <code>:signed_in_user</code>. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="k">unless</span> <span class="n">signed_in?</span>
        <span class="n">store_location</span>
        <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для того чтобы реализовать саму переадресацию, мы используем метод <code>redirect_back_or</code> для перенаправления на запрашиваемый URI если он существует или на какой-либо дефолтный URI в противном случае, который мы добавим в действие <code>create</code> контроллера Sessions для переадресации после успешного входа (<a class="ref" href="updating-showing-and-deleting-users#code-friendly_session_create">Листинг&nbsp;9.20</a>). Метод <code>redirect_back_or</code> использует оператор "или"&nbsp;<code>||</code></p>

<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span>
</pre></div>
</div>


<p>Этот код оценивает <code>session[:return_to]</code> и до тех пор, пока оно не является <code>nil</code>, в противном случае он оценивает заданный дефолтный URI. Обратите внимание, что <a class="ref" href="updating-showing-and-deleting-users#code-friendly_forwarding_code">Листинг&nbsp;9.18</a> заботится об удалении URI перенаправления; в противном случае, последующие попытки входа перенаправлялись бы на защищенную страницу до тех пор, пока пользователь не закроет браузер. (Тестирование этого поведения оставлено в качестве упражнения (<a class="ref" href="updating-showing-and-deleting-users#sec-updating_deleting_exercises">Раздел&nbsp;9.6</a>.)</p>

<div class="label" id="code-friendly_session_create"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.20.</span> <span class="description">Действие <code>create</code> контроллера Sessions с дружелюбной переадресацией. <br /> <code>app/controllers/sessions_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_back_or</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>(Если вы выполнили первое упражнение в <a class="ref" href="sign-in-sign-out#top">Главае&nbsp;8</a>, убедитесь в том что вы используете правильный хэш <code>params</code> в <a class="ref" href="updating-showing-and-deleting-users#code-friendly_session_create">Листинге&nbsp;9.20</a>.)</p>

<p>С этим интеграционные тесты дружелюбной переадресации из <a class="ref" href="updating-showing-and-deleting-users#code-friendly_forwarding_test">Листинга&nbsp;9.17</a> должны пройти и базовая аутентификация и защита страниц могут считаться законченными. Как обычно, прежде чем продолжать, хорошо бы проверить что набор тестов зеленый:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-showing_all_users"></div>


<h2><a id="sec-9_3" href="updating-showing-and-deleting-users#sec-showing_all_users" class="heading"><span class="number">9.3</span> Отображение всех пользователей</a></h2>


<p>В этом разделе мы добавим предпоследнее действие пользователя, действие <code>index</code>, которое предназначено для отображения <em>всех</em> пользователей вместо одного единственного. По дороге мы узнаем о заполнении базы данных образцами ползователей и <em>пагинации</em> вывода пользователей с тем, чтобы страница со списком пользователей могла масштабироваться для отображения потенциально большого количества пользователей. Набросок результата &mdash; пользователи, пагинационные ссылки и навигационная ссылка &ldquo;Users&rdquo; &mdash; представлена на <a class="ref" href="updating-showing-and-deleting-users#fig-user_index_mockup">Рис.&nbsp;9.7</a>.<sup class="footnote" id="fnref-9_5"><a href="#fn-9_5">5</a></sup> В <a class="ref" href="updating-showing-and-deleting-users#sec-destroying_users">Разделе&nbsp;9.4</a>, мы добавим административный интерфейс к списку пользователей для того чтобы (предположительно проблемные) могли быть удалены.</p>

<div class="label" id="fig-user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_mockup_bootstrap.png" alt="user_index_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.7: </span><span class="description">Набросок списка пользователей с пагинацией и навигационной ссылкой &ldquo;Users&rdquo;.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_mockup_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec-user_index"></div>


<h3><a id="sec-9_3_1" href="updating-showing-and-deleting-users#sec-user_index" class="heading"><span class="number">9.3.1</span> Список пользователей</a></h3>


<p>Хотя мы сохраним страницы <code>show</code> отдельных пользователей видимыми для всех посетителей сайта, для страницы user <code>index</code> будет реализовано ограничение, отображающее ее только для зарегистрированных пользователей, также будет реализовано ограничение того, сколько зарегистрированных пользователей будет отображаться на каждой странице списка. Мы начнем с тестирования того, что действие <code>index</code> защищено, посетив <code>users_path</code> (<a class="ref" href="sign-up#table-RESTful_users">Таблица&nbsp;7.1</a>) и проверив что мы перенаправлены на страницу входа. Как и с остальными тестами авторизации, мы поместим этот пример в интеграционные тест авторизации, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-protected_index_test">Листинге&nbsp;9.21</a>.</p>

<div class="label" id="code-protected_index_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.21.</span> <span class="description">Тестирование того, что действие <code>index</code> защищено. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">&quot;visiting the user index&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">users_path</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Соответствующий код приложения просто добавляет <code>index</code> в список действий защищенных предфильтром <code>signed_in_user</code>, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-signed_in_user_index">Листинге&nbsp;9.22</a>.</p>

<div class="label" id="code-signed_in_user_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.22.</span> <span class="description">Требование входа пользователя для действия <code>index</code>. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Следующий набор тестов убеждается, что, для вошедших пользователей, страница списка пользователей имеет правильные заголовок браузера/заголовок первого уровня и список всех пользователей сайта. Методика заключается в создании трех фабричных пользователей (вошедшим будет первый из них) и проверке того, что страница со списком пользователей имеет тег элемента списка (<code>li</code>) для имени каждого из них. Обратите внимание, что мы позаботились о том, чтобы дать пользователям разные имена, так что каждый элемент в списке пользователей  имеет уникальную запись, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-user_index_tests">Листинге&nbsp;9.23</a>.</p>

<div class="label" id="code-user_index_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.23.</span> <span class="description">Тесты для страницы со списком пользователей. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Ben&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;ben@example.com&quot;</span><span class="p">)</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">&quot;should list each user&quot;</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Как вы можете вспомнить из соответствующего действия demo app (<a class="ref" href="a-demo-app#code-demo_index_action">Листинг&nbsp;2.4</a>), код приложения использует <code>User.all</code> для вытягивания всех пользователей из базы данных, присваивая их переменной экземпляра <code>@users</code>  для использования в представлении, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-user_index">Листинге&nbsp;9.24</a>. (Если отображение всех пользователей за раз кажется вам плохой идеей, вы правы и мы избавимся от этого недостатка в <a class="ref" href="updating-showing-and-deleting-users#sec-pagination">Разделе&nbsp;9.3.3</a>.)</p>

<div class="label" id="code-user_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.24.</span> <span class="description">Действие <code>index</code> контроллера Users. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для того, чтобы на самом деле создать страницу, нам необходимо создать представление, которое перебирает всех пользователей и обертывает каждого из них в тег&nbsp;<code>li</code>. Мы сделаем это с помощью метода <code>each</code>, отображающего Gravatar и имя каждого пользователя, в то время как сам он будет завернут в тег ненумерованного списка (<code>ul</code>) (<a class="ref" href="updating-showing-and-deleting-users#code-user_index_view">Листинг&nbsp;9.25</a>). Код в <a class="ref" href="updating-showing-and-deleting-users#code-user_index_view">Листинге&nbsp;9.25</a> использует результат  <a class="ref" href="sign-up#code-gravatar_option">Листинга&nbsp;7.29</a> из <a class="ref" href="sign-up#sec-signup_exercises">Раздела&nbsp;7.6</a>, который позволяет нам передать опцию, определяющую размер отличный от дефолтного, в хелпер Gravatar. Если вы не выполнили это упражнение, обновите ваш файл хелпера Users с содержимым <a class="ref" href="sign-up#code-gravatar_option">Листинга&nbsp;7.29</a> прежде чем продолжать.</p>

<div class="label" id="code-user_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.25.</span> <span class="description">Представление для страницы со списком пользователей. <br /> <code>app/views/users/index.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div></div>


<p>Давайте также добавим немного CSS (или, скорее, SCSS) для придания стиля (<a class="ref" href="updating-showing-and-deleting-users#code-user_index_css">Листинг&nbsp;9.26</a>).</p>

<div class="label" id="code-user_index_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.26.</span> <span class="description">CSS для страницы со списком пользователей. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">users</span> <span class="nt">index</span> <span class="o">*/</span>

<span class="nc">.users</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:last-child</span> <span class="p">{</span>
      <span class="na">border-bottom</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>Наконец, мы добавим URI в ссылку на список пользователей в навигационном меню шапки сайта с помощью <code>users_path</code>, тем самым применив последний из неиспользованных именованных маршрутов <a class="ref" href="sign-up#table-RESTful_users">Таблицы&nbsp;7.1</a>. Тест (<a class="ref" href="updating-showing-and-deleting-users#code-users_link_test">Листинг&nbsp;9.27</a>) и код приложения (<a class="ref" href="updating-showing-and-deleting-users#code-users_link">Листинг&nbsp;9.28</a>) довольно просты.</p>

<div class="label" id="code-users_link_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.27.</span> <span class="description">Тест для URI ссылки &ldquo;Users&rdquo;. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span>    <span class="ss">href:</span> <span class="n">users_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span>  <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Settings&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-users_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.28.</span> <span class="description">Добавление URI к ссылке на список пользователей. <br /> <code>app/views/layouts/_header.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>С этим кодом список пользователей стал полностью функциональным, и все тесты должны проходить:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Но с другой стороны, как это видно на <a class="ref" href="updating-showing-and-deleting-users#fig-user_index_only_one">Рис.&nbsp;9.8</a>, он выглядит несколько безлюдно. Давайте исправим эту печальную ситуацию.</p>

<div class="label" id="fig-user_index_only_one"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_only_one_bootstrap.png" alt="user_index_only_one_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.8: </span><span class="description">Страница списка пользователей  <a href="http://localhost:3000/users">/users</a> с одним пользователем.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_only_one_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec-sample_users"></div>


<h3><a id="sec-9_3_2" href="updating-showing-and-deleting-users#sec-sample_users" class="heading"><span class="number">9.3.2</span> Образцы пользователей</a></h3>


<p>В этом разделе мы дадим нашему одинокому образцу пользователя небольшую компанию. Конечно, чтобы создать достаточное количество пользователей, мы <em>могли бы</em>, использовать наш веб-браузер, для посещения страницы регистрации и создания новых пользователей по одному, но куда более продвинутым решением является использование Ruby (и Rake), чтобы сделать пользователей для нас.</p>

<p>Во-первых, мы добавим <a  href="http://lingvo.yandex.ru/faker/">Faker</a> гем в <code>Gemfile</code>, который позволит нам делать образцы пользователей с полу-реалистичными именами и адресами электронной почты (<a class="ref" href="updating-showing-and-deleting-users#code-faker_gemfile">Листинг&nbsp;9.29</a>).</p>

<div class="label" id="code-faker_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.29.</span> <span class="description">Добавление Faker гема в <code>Gemfile</code>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Затем установите как обычно:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Далее мы добавим Rake-задачу для создания образцов пользователей. Rake задачи живут в <code>lib/tasks</code>, и определяются с помощью  <em>пространства имен</em> (в даном случае, <code>:db</code>), как видно в <a class="ref" href="updating-showing-and-deleting-users#code-db_populate">Листинге&nbsp;9.30</a>. (Это довольно продвинутый материал, так что не особо заморачивайтесь деталями.)</p>

<div class="label" id="code-db_populate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.30.</span> <span class="description">Rake задача для заполнения базы данных образцами пользователей. <br /> <code>lib/tasks/sample_data.rake</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                 <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                 <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker::Name</span><span class="o">.</span><span class="n">name</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org&quot;</span>
      <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
      <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
                   <span class="ss">email:</span> <span class="n">email</span><span class="p">,</span>
                   <span class="ss">password:</span> <span class="n">password</span><span class="p">,</span>
                   <span class="ss">password_confirmation:</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Этот код определяет задачу <code>db:populate</code> которая создает образец пользователя с именем и адресом электронной почты, делая реплику нашего предыдущего пользователя, после чего делает еще 99 экземпляров. Строка</p>

<div class="code"><div class="highlight"><pre><span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
</pre></div>
</div>


<p>обеспечивает Rake задаче доступ к локальному Rails окружению, включая модель User (и, следовательно, к <code>User.create!</code>). Здесь <code>create!</code> это метод очень похожий на <code>create</code>, за той лишь разницей, что он вызывает исключение (<a class="ref" href="modeling-users#sec-finding_user_objects">Раздел&nbsp;6.1.4</a>) при неудачном создании, вместо того чтобы тихо возвращать <code>false</code>. Эта крикливая конструкция упрощает отладку, помогая избежать тихих ошибок.</p>

<p>С пространством имен <code>:db</code> как в <a class="ref" href="updating-showing-and-deleting-users#code-db_populate">Листинге&nbsp;9.30</a>, мы можем вызвать Rake задачу следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>После запуска Rake задачи, наше приложениее имеет 100 примеров пользователей, как это видно на <a class="ref" href="updating-showing-and-deleting-users#fig-user_index_all">Рис.&nbsp;9.9</a>. (Я взял на себя смелость связать первые несколько образцов адресов  с фотографиями так что не все изображения являются дефолтными картинками Gravatar.)</p>

<div class="label" id="fig-user_index_all"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_all_bootstrap.png" alt="user_index_all_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.9: </span><span class="description">Страница списка пользователей <a href="http://localhost:3000/users">/users</a> с 100 образцов пользователей.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_all_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec-pagination"></div>


<h3><a id="sec-9_3_3" href="updating-showing-and-deleting-users#sec-pagination" class="heading"><span class="number">9.3.3</span> Пагинация</a></h3>


<p>Наш оригинальный пользователь более не страдает от одиночества, но теперь у нас появилась другая проблема: у нашего пользователя <em>слишком большая</em> компания, и вся она расположилась на одной странице. Сейчас это сотня, что уже является довольно большим числом, а на реальном сайте это могут быть и тысячи. Решение заключается в <em>пагинации (разбиении на страницы, постраничном выводе)</em> пользователей, так, чтобы (например) показывать только 30 на каждой странице одновременно.</p>

<p>В Rails есть несколько способов разбиения на страницы, мы будем использовать один из самых простых и надежных, он называется <a href="http://wiki.github.com/mislav/will_paginate/">will_paginate</a>. Для того, чтобы использовать его нам необходимо включить сам гем <tt>will_paginate</tt>, а также гем <tt>bootstrap-will_paginate</tt>, который конфигурирует will_paginate для использования пагинационных стилей предоставляемых  Bootstrap. Обновленный <code>Gemfile</code> представлен в <a class="ref" href="updating-showing-and-deleting-users#code-will_paginate_gem">Листинге&nbsp;9.31</a>.</p>

<div class="label" id="code-will_paginate_gem"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.31.</span> <span class="description">Включение <tt>will_paginate</tt> в <code>Gemfile</code>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.6&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Затем запустите <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Вам также следует перезагрузить веб-сервер для того чтобы убедиться, что новые гемы были загружены как следует.</p>

<p>Поскольку гем <tt>will_paginate</tt> широко распространен, нам нет необходимости тестировать его, так что мы можем применить несколько облегченный подход. Во-первых, мы протестируем наличие <code>div</code> с CSS классом &ldquo;pagination&rdquo;, который выводится гемом <tt>will_paginate</tt>. Затем мы проверим что на первой странице результатов представлены правильные пользователи. Для этого нам потребуется использовать метод <code>paginate</code>, о котором мы вскоре узнаем подробнее.</p>

<p>Как и прежде, мы будем использовать Factory Girl для имитации пользователей, но мы тут же натыкаемся на проблему: адреса электронной почты пользователей должны быть уникальными, что, как представляется, требует создания более чем 30 пользователей вручную&nbsp;&mdash;&nbsp;ужасно муторная работа. К тому же, при тестировании выводимого списка пользователей было бы удобно, если бы у них были разные имена. К счастью, Factory Girl предвидела этот вопрос, и обеспечила <em>последовательность (цикл)</em> для ее решения. Наша оригинальная фабрика (<a class="ref" href="sign-up#code-user_factory">Листинг&nbsp;7.8</a>) хард-кодила имя и адрес электронной почты:</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">&quot;Michael Hartl&quot;</span>
    <span class="n">email</span>    <span class="s2">&quot;michael@example.com&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Вместо этого мы можем организовать последовательность имен и адресов электронной почты с помощью метода <code>sequence</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>Здесь <code>sequence</code> принимает символ соответствующий выбранному атрибуту (такому как <code>:name</code>) и блок с одной переменной, которую мы назвали&nbsp;<code>n</code>. При последующих вызовах <code>FactoryGirl</code> метод,</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div>
</div>


<p>Переменная блока <code>n</code> автоматически увеличивается, таким образом, именем первого пользователя будет &ldquo;Person&nbsp;1&rdquo;, а адресом электронной почты -  &ldquo;person_1@example.com&rdquo;, второй пользователь получит имя &ldquo;Person&nbsp;2&rdquo; и адрес электронной почты &ldquo;person_2@example.com&rdquo;, и т.д.. Полный код представлен в <a class="ref" href="updating-showing-and-deleting-users#code-factory_sequence">Листинге&nbsp;9.32</a>.</p>

<div class="label" id="code-factory_sequence"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.32.</span> <span class="description">Определение последовательности (цикла) Factory Girl. <br /> <code>spec/factories.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Применив идею фабричных последовательностей, мы можем сделать 30 пользователей в наших тестах, чего (как мы увидим) будет достаточно для вызова пагинации:</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>
</pre></div>
</div>


<p>Обратите здесь внимание на применение <code>before(:all)</code>, который гарантирует создание образцовых пользователей <em>единожды</em> перед всеми тестами блока. Это оптимизирует скорость прохождения тестов, поскольку создание 30 пользователей может быть медленным на некоторых системах. Мы используем тесно связанный метод <code>after(:all)</code> для удаления прользователей по завершении.</p>

<p>Тесты на появление пагинационного <code>div</code> и наличие правильных пользователей представлены в <a class="ref" href="updating-showing-and-deleting-users#code-will_paginate_test">Листинге&nbsp;9.33</a>. Обратите внимание на замену массива <code>User.all</code> из <a class="ref" href="updating-showing-and-deleting-users#code-user_index_tests">Листинга&nbsp;9.23</a> на <code>User.paginate(page: 1)</code>, который (как мы вскоре увидим) вытягивает первую страницу пользователей из базы данных. Обратите также внимание на то, что <a class="ref" href="updating-showing-and-deleting-users#code-will_paginate_test">Листинг&nbsp;9.33</a> использует <code>before(:each)</code> для того чтобы подчеркнуть контраст с <code>before(:all)</code>.</p>

<div class="label" id="code-will_paginate_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.33.</span> <span class="description">Тесты для пагинации. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;pagination&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
      <span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.pagination&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">&quot;should list each user&quot;</span> <span class="k">do</span>
        <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для того чтобы подключить пагинацию нам нужно добавить немного кода сообщающего Rails о необходимости пагинировать пользователей в представление index и нам необходимо заменить <code>User.all</code> в <code>index</code> действии на объект который знает о пагинации. Мы начнем с добавления специального метода <code>will_paginate</code> в представление (<a class="ref" href="updating-showing-and-deleting-users#code-will_paginate_index_view">Листинг&nbsp;9.34</a>); мы вскоре увидим почему код был добавлен сверху и снизу списка пользователей.</p>

<div class="label" id="code-will_paginate_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.34.</span> <span class="description">Страница списка пользователей с пагинацией. <br /> <code>app/views/users/index.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Метод <code>will_paginate</code> немного волшебный; внутри представления <code>users</code>, он автоматически ищет объект <code>@users</code>, а затем отображает пагинационные ссылки для доступа к остальным страницам. Представление в <a class="ref" href="updating-showing-and-deleting-users#code-will_paginate_index_view">Листинге&nbsp;9.34</a> пока не работает, из-за того что на данный момент <code>@users</code> содержит результаты <code>User.all</code> (<a class="ref" href="updating-showing-and-deleting-users#code-user_index">Листинг&nbsp;9.24</a>) , которые принадлежат классу <code>Array</code>, в то время как <code>will_paginate</code> ожидает объект класса <code>ActiveRecord::Relation</code>. К счастью, это всего лишь вид объекта, возвращаемого методом <code>paginate</code> добавляемого гемом <tt>will_paginate</tt> ко всем объектам Active Record:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Array</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; ActiveRecord::Relation</span>
</pre></div>
</div>


<p>Обратите внимание, что <code>paginate</code> принимает в качестве аргумента хэш с ключом <code>:page</code> и значением, равным запрашиваемой странице. <code>User.paginate</code> вытягивает пользователей из базы данных по одному куску за раз (30 по умолчанию), основываясь на параметре <code>:page</code>. Так, например, стр.&nbsp;1 содержит пользователей с 1 по 30, стр.&nbsp;2 это пользователи 31&ndash;60, и т.д.. Если страница является <code>nil</code>, <code>paginate</code> просто возвращает первую страницу.</p>

<p>Мы можем разбить список пользователей на страницы в примере приложения, используя <code>paginate</code> вместо <code>all</code> в <code>index</code> действии (<a class="ref" href="updating-showing-and-deleting-users#code-will_paginate_index_action">Листинг&nbsp;9.35</a>). Здесь <code>:page</code> параметр приходит из <code>params[:page]</code>, который <code>will_paginate</code> сгенерировал автоматически.</p>

<div class="label" id="code-will_paginate_index_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.35.</span> <span class="description">Пагинация пользователей в <code>index</code> действии. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Страница списка пользователей теперь должна работать так как это показано на <a class="ref" href="updating-showing-and-deleting-users#fig-user_index_pagination_rails_3">Рис.&nbsp;9.10</a>. (На некоторых системах в этой точке может потребоваться перезапуск Rails сервера.) Так как мы включили <code>will_paginate</code> сверху и снизу списка пользователей, ссылки на страницы появились в обоих местах.</p>

<div class="label" id="fig-user_index_pagination_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_pagination_rails_3_bootstrap.png" alt="user_index_pagination_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.10: </span><span class="description">Страница списка пользователей <a href="http://localhost:3000/users">/users</a> с пагинацией.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_pagination_rails_3_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Если теперь кликнуть по любой&nbsp;<a href="http://localhost:3000/users?page=2">2</a> или <a href="http://localhost:3000/users?page=2">Next</a> ссылке, вы получите вторую страницу с результатами, как это показано на <a class="ref" href="updating-showing-and-deleting-users#fig-user_index_page_two_rails_3">Рис.&nbsp;9.11</a>.</p>

<div class="label" id="fig-user_index_page_two_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_page_two_rails_3_bootstrap.png" alt="user_index_page_two_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.11: </span><span class="description">Страница 2 списка пользователей (<a href="http://localhost:3000/users?page=2">/users?page=2</a>).&nbsp;<a href="http://railstutorial.org/images/figures/user_index_page_two_rails_3_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Вам также следует проверить что тесты проходят:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-partial_refactoring"></div>


<h3><a id="sec-9_3_4" href="updating-showing-and-deleting-users#sec-partial_refactoring" class="heading"><span class="number">9.3.4</span> Частичный рефакторинг</a></h3>


<p>Разбитый на страницы список пользователей теперь закончен, но есть одно улучшение, от которого я не могу удержаться: Rails имеет несколько невероятно ловких инструментов для создания компактных представлений, и в этом разделе мы займемся рефакторингом страницы со списком пользователей, используя эти инструменты. Так как наш код хорошо протестирован, мы можем с уверенностью приступить к рефакторингу, будучи уверенными в том, что мы вряд ли нарушим функциональность сайта.</p>

<p>Первым шагом нашего рефакторинга будет замена пользовательского&nbsp;<code>li</code> из <a class="ref" href="updating-showing-and-deleting-users#code-will_paginate_index_view">Листинга&nbsp;9.34</a> на вызов <code>render</code> (<a class="ref" href="updating-showing-and-deleting-users#code-index_view_first_refactoring">Листинг&nbsp;9.36</a>).</p>

<div class="label" id="code-index_view_first_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.36.</span> <span class="description">Первая попытка рефакторинга в index представлении. <br /> <code>app/views/users/index.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Здесь мы вызываем  <code>render</code> не на строку с именем партиала, а на перемнную <code>user</code> класса <code>User</code>;<sup class="footnote" id="fnref-9_6"><a href="#fn-9_6">6</a></sup> в этом контексте, Rails автоматически ищет партиал с названием <code>_user.html.erb</code>, который мы должны создать (<a class="ref" href="updating-showing-and-deleting-users#code-user_partial">Листинг&nbsp;9.37</a>).</p>

<div class="label" id="code-user_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.37.</span> <span class="description">Партиал для отображения отдельно взятого пользователя. <br /> <code>app/views/users/_user.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>Это явное улучшение, но мы можем сделать еще лучше: мы можем вызвать <code>render</code> <em>непосредственно</em> на переменную  <code>@users</code> (<a class="ref" href="updating-showing-and-deleting-users#code-index_final_refactoring">Листинг&nbsp;9.38</a>).</p>

<div class="label" id="code-index_final_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.38.</span> <span class="description">Полностью реорганизованный список пользователей. <br /> <code>app/views/users/index.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Здесь Rails делает вывод, что <code>@users</code> это список объектов <code>User</code>; кроме того, при вызове с коллекцией пользователей, Rails автоматически перебирает их и отображает каждого из них с помощью партиала <code>_user.html.erb</code>. Результатом служит впечатляюще компактный код <a class="ref" href="updating-showing-and-deleting-users#code-index_final_refactoring">Листинга&nbsp;9.38</a>. Как и при любом рефакторинге, вам следует проверить что набор тестов по-прежнему зеленый, несмотря на изменившийся код приложения:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-destroying_users"></div>


<h2><a id="sec-9_4" href="updating-showing-and-deleting-users#sec-destroying_users" class="heading"><span class="number">9.4</span> Уничтожение пользователей</a></h2>


<p>Теперь, когда список пользователей завершен, осталось лишь одно каноничное REST действие: <code>destroy</code>. В этом разделе мы добавим ссылки для удаления пользователей, как это показано на <a class="ref" href="updating-showing-and-deleting-users#fig-user_index_delete_links_mockup">Рис.&nbsp;9.12</a>, и определим <code>destroy</code> действие необходимое для выполнения удаления. Но мы начнем с создания класса уполномоченных на это административных пользователей.</p>

<div class="label" id="fig-user_index_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_delete_links_mockup_bootstrap.png" alt="user_index_delete_links_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.12: </span><span class="description">Набросок списка пользователей с удаляющими ссылками.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_delete_links_mockup_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec-administrative_users"></div>


<h3><a id="sec-9_4_1" href="updating-showing-and-deleting-users#sec-administrative_users" class="heading"><span class="number">9.4.1</span> Административные пользователи</a></h3>


<p>Мы будем идентифицировать привилегированных пользователей с правами администратора посредством булевого атрибута <code>admin</code> в модели User, что, как мы увидим, автоматически приведет нас к методу <code>admin?</code> для проверки административного статуса. Мы можем написать тесты для этого атрибута, как в <a class="ref" href="updating-showing-and-deleting-users#code-admin_specs">Листинге&nbsp;9.39</a>.</p>

<div class="label" id="code-admin_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.39.</span> <span class="description">Тесты для атрибута <code>admin</code>. <br /> <code>spec/models/user_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_admin</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;with admin attribute set to &#39;true&#39;&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save!</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Здесь мы использовали метод <code>toggle!</code> для изменения атрибута <code>admin</code> от <code>false</code> к <code>true</code>. Отметим также, что строка</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
</pre></div>
</div>


<p>подразумевает (через булеву конвенцию RSpec), что пользователь должен иметь булев метод <code>admin?</code>.</p>

<p>Мы добавим атрибут <code>admin</code> как обычно, посредством миграции, указав тип <code>boolean</code> в командной строке:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div>
</div>


<p>Миграция просто добавляет столбец <code>admin</code> к таблице <code>users</code> (<a class="ref" href="updating-showing-and-deleting-users#code-admin_migration">Листинг&nbsp;9.40</a>), приводя к модели данных показанной на <a class="ref" href="updating-showing-and-deleting-users#fig-user_model_admin">Рис.&nbsp;9.13</a>.</p>

<div class="label" id="code-admin_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.40.</span> <span class="description">Миграция для добавления булевого атрибута <code>admin</code> к пользователям. <br /> <code>db/migrate/[timestamp]_add_admin_to_users.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default:</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание на то, что мы добавили аргумент <code>default: false</code> к <code>add_column</code> в <a class="ref" href="updating-showing-and-deleting-users#code-admin_migration">Листинге&nbsp;9.40</a>, что означает, что пользователи <em>не являются</em> администраторами по умолчанию. (Без аргумента <code>default: false</code>, <code>admin</code> был бы по умолчанию <code>nil</code>, что все же является <code>false</code>, так что этот шаг не является строго обязательным. Однако это более явно и четко сообщает о наших  намерениях, и Rails, и читателям нашего кода.)</p>

<div class="label" id="fig-user_model_admin"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_admin_31.png" alt="user_model_admin_31" /></span></div><div class="caption"><span class="header">Рисунок 9.13: </span><span class="description">Модель User с добавленным булевым атрибутом  <code>admin</code>.</span></div></div>


<p>Наконец, мы мигрируем базу данных разработки и подготавливаем тестовую бд:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>Как и ожидалось, Rails догадывается о булевом характере атрибута <code>admin</code> и автоматически добавляет метод со знаком вопроса <code>admin?</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>В результате, тесты для admin должны пройти:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<p>В качестве последнего шага, давайте обновим наш заполнитель образцов данных для того, чтобы сделать первого пользователя администратором (<a class="ref" href="updating-showing-and-deleting-users#code-populator_with_admin">Листинг&nbsp;9.41</a>).</p>

<div class="label" id="code-populator_with_admin"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.41.</span> <span class="description">Код заполнителя образцов данных для создания административного пользователя. <br /> <code>lib/tasks/sample_data.rake</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                         <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                         <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                         <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Наконец, перезапустим заполнитель для перезагрузки базы данных и последующей перестройки ее с нуля:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<div class="label" id="sec-revisiting_attr_accessible"></div>


<h4><a id="sec-9_4_1_1" href="updating-showing-and-deleting-users#sec-revisiting_attr_accessible" class="heading">Возвращение к <tt>attr_accessible</tt></a></h4>


<p>Вы могли заметить, что <a class="ref" href="updating-showing-and-deleting-users#code-populator_with_admin">Листинг&nbsp;9.41</a> делает пользователя администратором с помощью <code>toggle!(:admin)</code>, но почему бы просто не добавить <code>admin: true</code> к хэшу инициализации? Ответ прост&nbsp;&mdash;&nbsp;это не будет работать, и это является его особенностью: только <code>attr_accessible</code> атрибуты могут быть назначены через массовое назначение (то есть, используя инициализационный хэш как в <code>User.new(name: "Foo", ...)</code>, а атрибут <code>admin</code> не является доступным. <a class="ref" href="updating-showing-and-deleting-users#code-attr_accessible_review">Листинг&nbsp;9.42</a> воспроизводит последний список <code>attr_accessible</code> атрибутов&nbsp;&mdash;&nbsp;обратите внимание на то, что <code>:admin</code> <em>не присутствует</em> в списке.</p>

<div class="label" id="code-attr_accessible_review"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.42.</span> <span class="description"><code>attr_accessible</code> атрибуты модели User <em>без</em> атрибута <code>:admin</code>.  <br /> <code>app/models/user.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Явное определение доступных атрибутов имеет решающее значение для хорошей безопасности сайта. Если бы мы опустили список <code>attr_accessible</code> в модели User (или безрассудно добавили бы в список <code>:admin</code>), злоумышленник мог бы послать запрос <tt>PUT</tt> следующим образом:<sup class="footnote" id="fnref-9_7"><a href="#fn-9_7">7</a></sup></p>

<div class="code"><div class="highlight"><pre>put /users/17?admin=1
</pre></div>
</div>


<p>Этот запрос сделал бы администратором пользователя 17, что могло бы стать потенциально серьезной брешью в безопасности, если не сказать больше.  Из-за этой опасности, хорошей практикой является определение <code>attr_accessible</code> для каждой модели. Фактически, хорошо бы писать тест для каждого атрибута, который <em>не является</em> доступным; написание такого теста для атрибута <code>admin</code> оставлено в качестве упражнения (<a class="ref" href="updating-showing-and-deleting-users#sec-updating_deleting_exercises">Раздел&nbsp;9.6</a>).</p>

<div class="label" id="sec-the_destroy_action"></div>


<h3><a id="sec-9_4_2" href="updating-showing-and-deleting-users#sec-the_destroy_action" class="heading"><span class="number">9.4.2</span> <code>Destroy</code> действие</a></h3>


<p>Последний шаг, необходимый для завершения ресурса Users, заключается в добавлении удаляющих ссылок и <code>destroy</code> действия. Мы начнем с добавления удаляющей ссылки для каждого пользователя на страницу со списком пользователей, при этом ограничив доступ к ним.</p>

<p>Для написания тестов для удаляющего функционала нам пригодится фабрика создающая администраторов. Мы можем достигнуть этого, добавив блок <code>:admin</code> к нашим фабрикам как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-admin_factory">Листинг&nbsp;9.43</a>.</p>

<div class="label" id="code-admin_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.43.</span> <span class="description">Добавление фабрики для административных пользователей. <br /> <code>spec/factories.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>С кодом в <a class="ref" href="updating-showing-and-deleting-users#code-admin_factory">Листинге&nbsp;9.43</a>, мы теперь можем использовать <code>FactoryGirl.create(:admin)</code> для создания административных пользователей в наших тестах.</p>

<p>Наша политика безопасности требует запретить обычным пользователям видеть удаляющие ссылки:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>Но административные пользователи должны видеть такие ссылки и мы ожидаем, что админ, кликнув по удаляющей ссылке удалит пользователя, т.e., изменит количество <code>User</code> на&nbsp;<code>-1</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="s2">&quot;should be able to delete another user&quot;</span> <span class="k">do</span>
  <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>Обратите внимание на то, что мы должны добавить тест для проверки того, что админ не видит ссылки на удаление самого себя. Полный набор тестов для удаляющих ссылок представлен в <a class="ref" href="updating-showing-and-deleting-users#code-delete_link_tests">Листинге&nbsp;9.44</a>.</p>

<div class="label" id="code-delete_link_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.44.</span> <span class="description">Тесты для удаляющих ссылок. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;pagination&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;delete links&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;as an admin user&quot;</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">sign_in</span> <span class="n">admin</span>
          <span class="n">visit</span> <span class="n">users_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="s2">&quot;should be able to delete another user&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Код приложения показывает ссылку на удаление только если текущий пользователь является админом (<a class="ref" href="updating-showing-and-deleting-users#code-delete_links">Листинг&nbsp;9.45</a>). Обратите внимание на аргумент <code>method: :delete</code>, который организует выдачу ссылками необходимого запроса <tt>DELETE</tt>. Мы также обернули каждую ссылку в&nbsp;<code>if</code> выражение, таким образом они видны только администраторам. Результат, видимый нашим административным пользователям, представлен на <a class="ref" href="updating-showing-and-deleting-users#fig-index_delete_links_rails_3">Рис.&nbsp;9.14</a>.</p>

<div class="label" id="code-delete_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.45.</span> <span class="description">Ссылки удаляющие пользователей (видны только администраторам). <br /> <code>app/views/users/_user.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                  <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">}</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>Изначально, веб браузеры не могут отправлять <tt>DELETE</tt> запросы, и  Rails подделывает их с помощью JavaScript. Это означает, что удаляющие ссылки не будут работать если у пользователя отключен JavaScript. Если вы обязаны поддерживать браузеры с отключенным JavaScript, вы можете подделать запрос <tt>DELETE</tt> с помощью формы и запроса <tt>POST</tt>, что будет работать даже без JavaScript; более подробно об этом см. RailsCast о &ldquo;<a href="http://railscasts.com/episodes/77-destroy-without-javascript">Destroy Without JavaScript</a>&rdquo;.</p>

<div class="label" id="fig-index_delete_links_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/index_delete_links_rails_3_bootstrap.png" alt="index_delete_links_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Рисунок 9.14: </span><span class="description">Страница списка пользователей <a href="http://localhost:3000/users">/users</a> с удаляющими ссылками.&nbsp;<a href="http://railstutorial.org/images/figures/index_delete_links_rails_3_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Для того чтобы получить рабочие удаляющие ссылки, нам необходимо добавить действие <code>destroy</code> (<a class="ref" href="sign-up#table-RESTful_users">Таблица&nbsp;7.1</a>), которое будет находить соответствующего пользователя и удалять его с помощью метода Active Record <code>destroy</code>, по завершении перенаправляя пользователя на страницу списка пользователей, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-destroy_action">Листинге&nbsp;9.46</a>. Обратите внимание, что мы также добавили <code>:destroy</code> в предфильтр <code>signed_in_user</code>.</p>

<div class="label" id="code-destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.46.</span> <span class="description">Добавление рабочего действия <code>destroy</code>. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;User destroyed.&quot;</span>
    <span class="n">redirect_to</span> <span class="n">users_url</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание на то, что действие <code>destroy</code> использует сцепление методов для того, чтобы скомбинировать <code>find</code> и <code>destroy</code> в одну строку:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>


<p>Даже несмотря на то, что только администраторы могут видеть ссылки на удаление, есть еще одна страшная дыра в безопасности: любой достаточно опытный злоумышленник может просто выдать запрос <tt>DELETE</tt> из командной строки и удалить любого пользователя на сайте. Для того, чтобы обеспечить безопасность сайта, мы также нуждаемся в контроле доступа, и наши тесты должны проверить не только то, что администраторы  <em>могут</em> удалять пользователей, но также и то, что другие пользователи <em>не могут</em> этого делать. Результаты представлены в <a class="ref" href="updating-showing-and-deleting-users#code-delete_destroy_test">Листинге&nbsp;9.47</a>. Обратите внимание на то, что, по аналогии с методом <code>put</code> из <a class="ref" href="updating-showing-and-deleting-users#code-protected_edit_update_tests">Листинга&nbsp;9.11</a>, мы используем <code>delete</code> для непосредственной выдачи <tt>DELETE</tt> к указанному URI (в данном случае, путь к пользователю, как того требует <a class="ref" href="sign-up#table-RESTful_users">Таблица&nbsp;7.1</a>).</p>

<div class="label" id="code-delete_destroy_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.47.</span> <span class="description">Тест для защиты действия <code>destroy</code>. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;as non-admin user&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:non_admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">non_admin</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;submitting a DELETE request to the Users#destroy action&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>В принципе, у нас осталась еще одна незначительная брешь в безопасности, которая заключается в том, что админ может удалить сам себя выдав запрос <tt>DELETE</tt>. Можно, конечно, сказать что такой админ Сам Себе Злой Буратино, но было бы неплохо предотвратить подобные случаи, что остается в качестве упражнения (<a class="ref" href="updating-showing-and-deleting-users#sec-updating_deleting_exercises">Раздел&nbsp;9.6</a>).</p>

<p>Как вы можете догадаться, реализация использует предфильтр, в этот раз для ограничения доступа к <code>destroy</code> действию всем пользователям кроме администраторов. Получившийся в результате предфильтр <code>admin_user</code> представлен в <a class="ref" href="updating-showing-and-deleting-users#code-admin_destroy_before_filter">Листинге&nbsp;9.48</a>.</p>

<div class="label" id="code-admin_destroy_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.48.</span> <span class="description">Предфильтр открывающий доступ к действию <code>destroy</code> только админам. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:admin_user</span><span class="p">,</span>     <span class="ss">only:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>В этой точке все тесты должны проходить и ресурс Users &mdash; со своим контроллером, моделью и представлениями &mdash; функционально завершен.</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-updating_and_deleting_users_conclusion"></div>


<h2><a id="sec-9_5" href="updating-showing-and-deleting-users#sec-updating_and_deleting_users_conclusion" class="heading"><span class="number">9.5</span> Заключение</a></h2>


<p>Мы прошли долгий путь с момента введения контроллера Users в <a class="ref" href="filling-in-the-layout#sec-user_signup">Разделе&nbsp;5.4</a>. Те пользователи, даже не могли зарегистрироваться; теперь же пользователи могут зарегистрироваться, войти в систему, выйти, просматривать свои профили, редактировать их параметры, и видеть список всех пользователей, а некоторые из них могут даже удалять других пользователей.</p>

<p>Остальная часть этой книги будет опираться на ресурс Users (и связанную с ним аутентификационную систему) чтобы сделать сайт с  Twitter-подобными микросообщениями (<a class="ref" href="user-microposts#top">Глава&nbsp;10</a>) и потоком сообщений пользователей за которыми следит данный пользователь (<a class="ref" href="following-users#top">Глава&nbsp;11</a>). Эти главы представят некоторые из наиболее мощных возможностей Rails, включая моделирование данных с <code>has_many</code> и <code>has_many through</code>.</p>

<p>Прежде чем двигаться дальше, убедитесь, что объединили все изменения в мастер ветку:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish user edit, update, index, and destroy actions&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
</pre></div>
</div>


<p>Вы также можете задеплоить приложение и даже заполнить продакшен базу данных образцами пользователей (применив задачу <code>pg:reset</code> для сброса продакшен базы данных):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<p>Вам возможно придется повторно задеплоить приложение на Heroku для того чтобы сделать рестарт приложения. Вот как выглядит хак который принуждает Heroku рестартовать приложение:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> touch foo
<span class="gp">$</span> git add foo
<span class="gp">$</span> git commit -m <span class="s2">&quot;foo&quot;</span>
<span class="gp">$</span> git push heroku
</pre></div>
</div>

<p>Стоит также отметить, что в этой главе мы в последний раз имели необходимость в установке гема. Для справки, окончательный вариант <code>Gemfile</code> показан в <a class="ref" href="updating-showing-and-deleting-users#code-final_gemfile">Листинге&nbsp;9.49</a>. (Необязательные гемы которые могут оказаться системозависимыми закомментированы. Вы можете раскомментировать их для того чтобы посмотреть работают ли они на вашей системе.)</p>

<div class="label" id="code-final_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.49.</span> <span class="description">Окончательный вариант <code>Gemfile</code> для примера приложения.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.6&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.11.0&#39;</span>
  <span class="c1"># gem &#39;guard-rspec&#39;, &#39;1.2.1&#39;</span>
  <span class="c1"># gem &#39;guard-spork&#39;, &#39;1.2.0&#39;  </span>
  <span class="c1"># gem &#39;spork&#39;, &#39;0.9.2&#39;</span>
<span class="k">end</span>

<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;4.1.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.1&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;database_cleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.0&#39;</span>
  <span class="c1"># gem &#39;launchy&#39;, &#39;2.1.0&#39;</span>
  <span class="c1"># gem &#39;rb-fsevent&#39;, &#39;0.9.1&#39;, :require =&gt; false</span>
  <span class="c1"># gem &#39;growl&#39;, &#39;1.0.3&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-updating_deleting_exercises"></div>


<h2><a id="sec-9_6" href="updating-showing-and-deleting-users#sec-updating_deleting_exercises" class="heading"><span class="number">9.6</span> Упражнения</a></h2>




<ol>

<li>Следуя модели в <a class="ref" href="user-microposts#code-micropost_belongs_to_user_spec">Листинге&nbsp;10.8</a>, добавьте тест для проверки того что  User <code>admin</code> атрибут не является доступным. Для уверенности вначале получите Красный тест и лишь затем Зеленый. (<em>Подсказка</em>: Вашим первым шагом должно быть <em>добавление</em> <code>admin</code> в список доступных атрибутов.)</li>

<li>Организуйте открытие Gravatar ссылки &ldquo;change&rdquo; из <a class="ref" href="updating-showing-and-deleting-users#code-user_edit_view">Листинга&nbsp;9.3</a> в новом окне (или вкладке). <em>Подсказка:</em> Ищите в сети; вы должны найти один простой и надежный метод с участием так называмого <code>_blank</code>. </li>

<li>Текущий тест аутентификации проверяет что навигационные ссылки, такие как &ldquo;Profile&rdquo; и &ldquo;Settings&rdquo; появляются когда пользователь входит. Добавьте тест проверяющий что эти ссылки <em>не</em> видны невошедшим пользователям.</li>

<li>Примените тестовый хелпер <code>sign_in</code> из <a class="ref" href="updating-showing-and-deleting-users#code-sign_in_helper">Листинга&nbsp;9.6</a> в как можно большем количестве мест.</li>

<li>Удалите дублирующийся код формы рефакторингом <code>new.html.erb</code> и <code>edit.html.erb</code> представлений, используя партиал из <a class="ref" href="updating-showing-and-deleting-users#code-new_edit_partial">Листинга&nbsp;9.50</a>. Обратите внимание, на то, что вам придется передать пременную формы&nbsp;<code>f</code> в виде явной локальной переменной, как это показано в <a class="ref" href="updating-showing-and-deleting-users#code-new_user_with_partial">Листинге&nbsp;9.51</a>. Вам также понадобится обновить тесты, поскольку формы не останутся <em>в точности</em> такими же; найдите небольшую разницу между ними и обновите тесты соответствующим образом.</li>

<li>Зарегистрированным пользователям совершенно незачем иметь доступ к <code>new</code> и <code>create</code> действиям контроллера Users. Организуйте  для таких пользователей переадресацию  в корневой URL, при попытке обратиться к этим страницам.</li>

<li>Изучите объект <code>request</code> вставляя некоторые методы перечисленные в <a href="http://api.rubyonrails.org/v3.2.0/classes/ActionDispatch/Request.html">Rails API</a><sup class="footnote" id="fnref-9_8"><a href="#fn-9_8">8</a></sup> в шаблон сайта. (Обращайтесь к <a class="ref" href="sign-up#code-rails_debug">Листингу&nbsp;7.1</a> если застрянете.)</li>

<li>Напишите тест для проверки того, что дружелюбная переадресация направляет к данному URI только в первый раз. На последующие попытки входа, адрес перенаправления должени меняться на дефолтный (т.e., страницу профиля). См. подсказку в <a class="ref" href="updating-showing-and-deleting-users#code-friendly_forgetting_test">Листинге&nbsp;9.52</a> (и подсказкой я, в данном случае, называю решение).</li>

<li>Модифицируйте действие <code>destroy</code> так, чтобы предотвратить уничтожение административными пользователями самих себя. (Начните с написания теста.)</li>

</ol>




<div class="label" id="code-new_edit_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.50.</span> <span class="description">Партиал для полей форм new и edit. <br /> <code>app/views/users/_fields.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirm Password&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-new_user_with_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.51.</span> <span class="description">Представление для создания нового пользователя с партиалом. <br /> <code>app/views/users/new.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="ss">f:</span> <span class="n">f</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Create my account&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-friendly_forgetting_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 9.52.</span> <span class="description">Тест для перенаправления на дефолтную страницу после дружелюбной переадресации. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;when attempting to visit a protected page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;after signing in&quot;</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">&quot;should render the desired protected page&quot;</span> <span class="k">do</span>
            <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Edit user&#39;</span><span class="p">)</span>
          <span class="k">end</span>

          <span class="n">describe</span> <span class="s2">&quot;when signing in again&quot;</span> <span class="k">do</span>
            <span class="n">before</span> <span class="k">do</span>
              <span class="n">delete</span> <span class="n">signout_path</span>
              <span class="n">visit</span> <span class="n">signin_path</span>
              <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
              <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
              <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
            <span class="k">end</span>

            <span class="n">it</span> <span class="s2">&quot;should render the default (profile) page&quot;</span> <span class="k">do</span>
              <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="sign-in-sign-out#top">
    &laquo;&nbsp;<span class="number">Глава 8</span> Войти, выйти
  </a>
  <a class="next_page" href="user-microposts#top">
    <span class="number">Глава 10</span> Микросообщения пользователей&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn-9_1">Изображение взято на <a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a>.&nbsp;<a class="arrow" href="#fnref-9_1">&uarr;</a></li>
<li id="fn-9_2">Сайт Gravatar на самом деле переадресует на <a href="http://en.gravatar.com/emails">http://en.gravatar.com/emails</a>, предназначенную для англоговорящих пользователей, но я опустил <tt>en</tt> часть для возможного использования других языков.&nbsp;<a class="arrow" href="#fnref-9_2">&uarr;</a></li>
<li id="fn-9_3">Не беспокойтесь о том, как это работает, детали представляют интерес для разработчиков самого фреймворка Rails, но, по замыслу, не имеют значения для разработчиков Rails приложений.&nbsp;<a class="arrow" href="#fnref-9_3">&uarr;</a></li>
<li id="fn-9_4">Код в этом разделе это адаптация (переделка) гема <a href="http://github.com/thoughtbot/clearance">Clearance</a> команды разработчиков <a href="http://thoughtbot.com/">thoughtbot</a>.&nbsp;<a class="arrow" href="#fnref-9_4">&uarr;</a></li>
<li id="fn-9_5">Фотография ребенка из <a href="http://www.flickr.com/photos/glasgows/338937124/">http://www.flickr.com/photos/glasgows/338937124/</a>.&nbsp;<a class="arrow" href="#fnref-9_5">&uarr;</a></li>
<li id="fn-9_6">Имя <code>user</code> непринципиально&nbsp;&mdash;&nbsp;мы могли бы написать <code>@users.each do |foobar|</code>, а затем использовать <code>render foobar</code>. Ключом является <em>класс</em> объекта&nbsp;&mdash;&nbsp;в данном случае, <code>User</code>.&nbsp;<a class="arrow" href="#fnref-9_6">&uarr;</a></li>
<li id="fn-9_7">Инструменты командной строки, такие как <tt>curl</tt> могут выдавать <tt>PUT</tt> запросы этой формы.&nbsp;<a class="arrow" href="#fnref-9_7">&uarr;</a></li>
<li id="fn-9_8">http://api.rubyonrails.org/v3.2.0/classes/ActionDispatch/Request.html&nbsp;<a class="arrow" href="#fnref-9_8">&uarr;</a></li>
</ol>
</div>
