<div id="top"></div>


<h1 class="chapter"><a id="sec:7" href="sign-up#top" class="heading"><span class="number">Глава 7</span> Регистрация</a></h1>


<p>Теперь, когда у нас есть рабочая модель User, пришло время добавить возможность без которой некоторые сайты просто жить не могут: позволить пользователям регистрироваться на сайте. Мы будем использовать HTML <em>форму</em> для предоставления пользователями регистрационной информации нашему приложению в <a class="ref" href="sign-up#sec:signup_form">Разделе&nbsp;7.2</a>, , которая затем будет использована для создания нового пользователя и сохранения его атрибутов в базе данных в <a class="ref" href="sign-up#sec:signup_success">Разделе&nbsp;7.4</a>. В конце процесса регистрации, важно отобразить страницу профиля информацией о новом созданном пользователе, так что мы начнем с создания страницы для <em>демонстрации</em> пользователей, которая будет для нас первым шагом на пути реализации  REST архитектуры для пользователей (<a class="ref" href="a-demo-app#sec:mvc_in_action">Раздел&nbsp;2.2.2</a>). Как обычно, мы будем писать тесты по мере разработки, расширяя наши познания о применении  RSpec и Capybara для написания кратких и выразительных интеграционных тестов.</p>

<p>Для того, чтобы создать страницу профиля пользователя, нам необходимо иметь пользователя в базе данных, что представлеяет проблему яйца и курицы: как сайт может иметь пользователя до появления рабочей страницы регистрации? К счастью, эта проблема уже решена: в <a class="ref" href="modeling-users#sec:creating_a_user">Разделе&nbsp;6.3.5</a>, мы создавали запись User вручную с помощью Rails консоли. Если вы пропустили этот раздел, вам следует вернуться и закончить его перед продолжением.</p>

<p>Если вы используете управление версиями, создайте тему ветки, как обычно:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b sign-up
</pre></div>
</div>


<div class="label" id="sec:showing_users"></div>


<h2><a id="sec:7.1" href="sign-up#sec:showing_users" class="heading"><span class="number">7.1</span> Демонстрация пользователей</a></h2>


<p>В этом разделе мы сделаем первый шаг на пути к конечной странице пользователя, создав страницу для отображения имени и фотографии пользователя, на что указывает набросок страницы на <a class="ref" href="sign-up#fig:profile_mockup_profile_name">Рис.&nbsp;7.1</a>.<sup class="footnote" id="fnref:7.1"><a href="#fn:7.1">1</a></sup> Нашей конечной целью для страниц профиля пользователя является отображение фотографии пользователя, основных данныз пользователя и списка микросообщений, как показано на наброске в <a class="ref" href="sign-up#fig:profile_mockup">Рис.&nbsp;7.2</a>.<sup class="footnote" id="fnref:7.2"><a href="#fn:7.2">2</a></sup> (на <a class="ref" href="sign-up#fig:profile_mockup">Рис.&nbsp;7.2</a> показан наш первый пример <em>lorem ipsum</em> текста, который имеет <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">захватывающую историю</a> вам решительто стоит прочитать на досуге.) Мы закончим эту задачу, а вместе с ней и пример приложения, в  <a class="ref" href="following-users#top">Главе&nbsp;11</a>.</p>

<div class="label" id="fig:profile_mockup_profile_name"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup_profile_name_bootstrap.png" alt="profile_mockup_profile_name_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.1: </span><span class="description">Набросок страницы профиля пользователя которая будет сделана в этом разделе.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup_profile_name_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="fig:profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup_bootstrap.png" alt="profile_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.2: </span><span class="description">Набросок наших лучших ожиданий от конечной страницы профиля.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:rails_environments"></div>


<h3><a id="sec:7.1.1" href="sign-up#sec:rails_environments" class="heading"><span class="number">7.1.1</span> Отладка и окружения Rails</a></h3>


<p>Профили в этом разделе будут первыми по-настоящему динамическими страницами в нашем приложении. Хотя представление будет существовать как одна страница кода, каждый профиль будет кастомизирован с использованием информации получаемой из базы данных сайта. В качестве подготовки к добавлению динамических страниц в наш пример приложения, сейчас хорошее время, чтобы добавить некоторую отладочную информацию к шаблону нашего сайта (<a class="ref" href="sign-up#code:rails_debug">Листинг&nbsp;7.1</a>). Это отображает некоторую полезную информацию о каждой странице с помощью встроенного <code>debug</code> метода и <code>params</code> переменной (о которой мы узнаем больше в <a class="ref" href="sign-up#sec:a_users_resource">Разделе&nbsp;7.1.2</a>).</p>

<div class="label" id="code:rails_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.1.</span> <span class="description">Добавление отладочной информации к шаблону сайта. <br /> <code>app/views/layouts/application.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Для того, чтобы вывод отладочной информации приятно выглядел, мы добавим несколько правил к кастомной таблице стилей созданной в <a class="ref" href="filling-in-the-layout#top">Главе&nbsp;5</a>, как это показано в <a class="ref" href="sign-up#code:mixin_and_debug">Листинге&nbsp;7.2</a>.</p>

<div class="label" id="code:mixin_and_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.2.</span> <span class="description">Добавление кода для красивого блока с отладочной информацией, включая примесь Sass. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="k">@mixin</span><span class="nf"> box_sizing</span> <span class="p">{</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">miscellaneous</span> <span class="o">*/</span>

<span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">clear</span><span class="o">:</span> <span class="no">both</span><span class="p">;</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>Этот код вводит новую для нас возможность Sass -  <em>примесь</em>, в данном случае названную <code>box_sizing</code>. Примесь позволяет группировать  CSS правила с тем чтобы они могли использоваться для нескольких элементов, конвертируя</p>

<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="o">@</span><span class="nt">include</span> <span class="nt">box_sizing</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>в</p>

<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>Мы еще раз применим эту примесь в <a class="ref" href="sign-up#sec:using_form_for">Разделе&nbsp;7.2.2</a>. Результат ее применения в контексте блока с отладочной информацией показан на  <a class="ref" href="sign-up#fig:home_page_with_debug_2nd_ed">Рис.&nbsp;7.3</a>.</p>

<div class="label" id="fig:home_page_with_debug_2nd_ed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_debug_2nd_ed.png" alt="home_page_with_debug_2nd_ed" /></span></div><div class="caption"><span class="header">Рис. 7.3: </span><span class="description">Home страница примера приложения (<a href="http://localhost:3000/">/</a>) с отладочной информацией.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_debug_2nd_ed-full.png">(полный размер)</a></span></div></div>


<p>Вывод отладочной информации на <a class="ref" href="sign-up#fig:home_page_with_debug_2nd_ed">Рис.&nbsp;7.3</a> дает потенциально полезную информацию о странице:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static_pages</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">home</span>
</pre></div>
</div>


<p>Это YAML<sup class="footnote" id="fnref:7.3"><a href="#fn:7.3">3</a></sup> представление <code>params</code>, который по сути является хэшем и в данном случае указывает на контроллер и действие страницы. Мы увидим еще один пример в <a class="ref" href="sign-up#sec:a_users_resource">Разделе&nbsp;7.1.2</a></p>

<p>Поскольку мы не хотим показывать отладочную информацию пользователям развернутого приложения, <a class="ref" href="sign-up#code:rails_debug">Листинг&nbsp;7.1</a> использует</p>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div>
</div>


<p>для того чтобы показывать отладочную информацию только  в <em>среде разработки</em>, которая является одной из трех сред, определенных по умолчанию в Rails (<a class="ref" href="sign-up#sidebar:rails_environments">Блок&nbsp;7.1</a>).<sup class="footnote" id="fnref:7.4"><a href="#fn:7.4">4</a></sup> В частности, <code>Rails.env.development?</code> является <code>true</code> только в среде разработки, так что Embedded Ruby</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>не будет вставлен в развернутое приложение или тесты. (Вставка отладочной информации в тесты возможно не навредит, но скорее всего и не сделает ничего хорошего, так что лучше ограничиться ее отображением только в среде разработки.)</p>

<div class="label" id="sidebar:rails_environments"></div>


<div class="sidebar"><span class="title"><span class="header">Блок 7.1.</span><span class="description">Окружения Rails</span></span>
<p>Rails поставляется с тремя окружениями: <tt>test</tt>, <tt>development</tt> и <tt>production</tt>. Дефолтным окружением для Rails консоли является <tt>development</tt>:</p>

<pre class="verbatim">  $ rails console
  Loading development environment
  &gt;&gt; Rails.env
  =&gt; &quot;development&quot;
  &gt;&gt; Rails.env.development?
  =&gt; true
  &gt;&gt; Rails.env.test?
  =&gt; false</pre>


<p>Как вы можете видеть, Rails обеспечивает объект <tt>Rails</tt> атрибутом <tt>env</tt> и связанными с ним булевыми методами окружения, таким образом, например, <tt>Rails.env.test?</tt> возвращает <tt>true</tt> в тестовом окружении и  <tt>false</tt> во всех остальных.</p>

<p>Если вам когда либо понадобится запустить консоль в окружении, отличном от дефолтного (для отладки теста, например), вы можете предать окружение в качестве параметра к <tt>console</tt> скрипту:</p>

<pre class="verbatim">  $ rails console test
  Loading test environment
  &gt;&gt; Rails.env
  =&gt; &quot;test&quot;
  &gt;&gt; Rails.env.test?
  =&gt; true</pre>


<p>Как и в случае с консолью, <tt>development</tt> является дефолтным окружением для локального  Rails сервера, но вы также можете запустить его в другом окружении:</p>

<pre class="verbatim">  $ rails server --environment production</pre>


<p>Если вы попробуете посмотреть на свое приложение запущенное в production, оно не будет работать без production базы данных, которую мы можем создать запустив <tt>rake db:migrate</tt> в production:</p>

<pre class="verbatim">  $ bundle exec rake db:migrate RAILS_ENV=production</pre>


<p>(Я считаю запутывающим, когда консоль, сервер и команды миграций устанавливают не дефолтные окружения тремя взаимно исключающими способами, поэтому я дал себе труд показать все три.)</p>

<p>Кстати, если вы развернули свое приложение на Heroku, вы можете посмотреть его окружение с помощью команды <tt>heroku</tt>, которая обеспечивает его собственную (удаленную) консоль:</p>

<pre class="verbatim">  $ heroku run console
  Ruby console for yourapp.herokuapp.com
  &gt;&gt; Rails.env
  =&gt; &quot;production&quot;
  &gt;&gt; Rails.env.production?
  =&gt; true</pre>


<p>Вполне естественно, что, поскольку Heroku является платформой для production сайтов, он запускает каждое приложение в  production окружении.</p>
</div>




<div class="label" id="sec:a_users_resource"></div>


<h3><a id="sec:7.1.2" href="sign-up#sec:a_users_resource" class="heading"><span class="number">7.1.2</span> Ресурс Users</a></h3>


<p>В конце <a class="ref" href="modeling-users#top">Главы&nbsp;6</a>, мы создали нового пользователя в базе данных. Как показано в <a class="ref" href="modeling-users#sec:creating_a_user">Разделе&nbsp;6.3.5</a>, этот пользователь имеет id&nbsp;<code>1</code> и наша цель теперь заключается в создании страницы для отображения информации этого пользователя. Мы будем следовать соглашениям REST архитектуры предпочитаемой  в Rails приложениях (<a class="ref" href="a-demo-app#sidebar:REST">Блок&nbsp;2.2</a>), что означает представление данных в качестве <em>ресурсов</em> которые могут быть созданы, показаны, обновлены, или уничтожены &mdash; четыре действия, соответствующие четырем фундаментальным операциям <tt>POST</tt>, <tt>GET</tt>, <tt>PUT</tt> и <tt>DELETE</tt> определенным <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">стандартом HTTP</a> (<a class="ref" href="static-pages#sidebar:get_etc">Блок&nbsp;3.1</a>).</p>

<p>Следуя принципам REST, на ресурсы обычно ссылаются, используя имя ресурса и уникальный идентификатор. Что это означает в контексте пользователей &mdash; о которых мы теперь думаем, как о <em>ресурсе</em> Users&mdash;то, что мы должны показать пользователя с id&nbsp;<code>1</code> выдав <tt>GET</tt> запрос к URL <tt>/users/1</tt>. Здесь <code>show</code> действие <em>неявно</em> в типе запроса &mdash;к огда Rails&rsquo; функции REST активированы, <tt>GET</tt> запросы автоматически обрабатываются <code>show</code> действием.</p>

<p>Мы видели в <a class="ref" href="a-demo-app#sec:a_user_tour">Разделе&nbsp;2.2.1</a>, что страница для пользователя с id&nbsp;<code>1</code> имеет URI /users/1. К сожалению, сейчас посещение этой страницы лишь выдает ошибку (<a class="ref" href="sign-up#fig:profile_routing_error">Рис.&nbsp;7.4</a>).</p>

<div class="label" id="fig:profile_routing_error"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_routing_error.png" alt="profile_routing_error" /></span></div><div class="caption"><span class="header">Рис. 7.4: </span><span class="description">Страница ошибки для /users/1.&nbsp;<a href="http://railstutorial.org/images/figures/profile_routing_error-full.png">(полный размер)</a></span></div></div>


<p>Мы можем заполучить REST-style Users URL на работу, добавив одну-единственную строку в наш файл маршрутов (<code>config/routes.rb</code>):</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span>
</pre></div>
</div>


<p>Результат представлен в <a class="ref" href="sign-up#code:users_resource">Листинге&nbsp;7.3</a>.</p>

<div class="label" id="code:users_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.3.</span> <span class="description">Добавление ресурса Users в файл маршрутов. <br /> <code>config/routes.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>

  <span class="n">root</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Вы возможно заметили, что <a class="ref" href="sign-up#code:users_resource">листинг&nbsp;7.3</a> удаляет строку</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>
</pre></div>
</div>


<p>последний раз замеченную в <a class="ref" href="filling-in-the-layout#code:signup_route">Листинге&nbsp;5.32</a>. Это связано с тем, что <code>resources :users</code> не просто добавляет работающий /users/1 URI; она обеспечивает наш пример приложения всеми действиями, необходимыми для RESTful (полностью REST) ресурса Users,<sup class="footnote" id="fnref:7.5"><a href="#fn:7.5">5</a></sup> наряду с большим количеством именованных маршрутов (<a class="ref" href="filling-in-the-layout#sec:named_routes">Раздел&nbsp;5.3.3</a>) для генерации URIs пользователя. Получившееся  соответствие URIs, действий и именованных маршрутов показано в <a class="ref" href="sign-up#table:RESTful_users">Таблице&nbsp;7.1</a>. (Сравните с <a class="ref" href="a-demo-app#table:demo_RESTful_users">Таблицей&nbsp;2.2</a>.) В течение следующих трех глав, мы охватим остальные записи в <a class="ref" href="sign-up#table:RESTful_users">Таблице&nbsp;7.1</a> поскольку мы заполним все действия, необходимые, для того, чтобы сделать Users RESTful ресурсом.</p>

<div class="label" id="table:RESTful_users"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP запрос</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Действие</strong></th><th class="align_left"><strong>Именованный маршрут</strong></th><th class="align_left"><strong>Назначение</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users</td><td class="align_left"><code>index</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">страница показывающая список пользователей</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>show</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">страница показывающая пользователя с id <code>1</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/new</td><td class="align_left"><code>new</code></td><td class="align_left"><code>new_user_path</code></td><td class="align_left">страница для создания нового пользователя (signup)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/users</td><td class="align_left"><code>create</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">создание нового пользователя</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/edit</td><td class="align_left"><code>edit</code></td><td class="align_left"><code>edit_user_path(user)</code></td><td class="align_left">страница для редактирования пользователя с id <code>1</code></td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>update</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">обновление пользователя с id <code>1</code></td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>destroy</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">dудаление пользователя с id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Таблица 7.1: </span><span class="description">RESTful маршруты, обеспеченные ресурсом Users в <a class="ref" href="sign-up#code:users_resource">Листинге&nbsp;7.3</a>.</span></div></div>


<p>С кодом в <a class="ref" href="sign-up#code:users_resource">Листинге&nbsp;7.3</a>, маршруты работают, но страница по-прежнему не существует (<a class="ref" href="sign-up#fig:user_show_unknown_action_31">Рис.&nbsp;7.5</a>). Для того чтобы исправить это, мы начнем с минималистичной версии страницы профиля, которую мы откормим в <a class="ref" href="sign-up#sec:a_gravatar_image">Разделе&nbsp;7.1.4</a>.</p>

<div class="label" id="fig:user_show_unknown_action_31"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_unknown_action_31.png" alt="user_show_unknown_action_31" /></span></div><div class="caption"><span class="header">Рис. 7.5: </span><span class="description"> URI /users/1 с маршрутом, но без страницы.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_unknown_action_31-full.png">(полный размер)</a></span></div></div>


<p>Мы будем использовать стандартное Rails размещение для представления показывающего пользователя, которым является <code>app/views/users/show.html.erb</code>. В отличие от представления <code>new.html.erb</code>, которое мы создали с помощью генератора в <a class="ref" href="filling-in-the-layout#code:generate_users_controller">Листинге&nbsp;5.28</a>, файл <code>show.html.erb</code> в данный момент не существует, так что нам необходимо создать его вручную и заполнить его содержимым  <a class="ref" href="sign-up#code:stub_user_view">Листинга&nbsp;7.4</a>.</p>

<div class="label" id="code:stub_user_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.4.</span> <span class="description">Представление-заглушка для отображения информации пользователя. <br /> <code>app/views/users/show.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Это представление использует Embedded Ruby для отображения имени и адреса электронной почты пользователя, предполагая наличие переменной экземпляра  <code>@user</code>. Конечно же, в итоге реальная страница пользователя будет выглядеть совершенно иначе и не будет публично демонстрировать адрес электронной почты.</p>

<p>Для того чтобы заставить представление user show работать, нам необходимо определить переменную <code>@user</code> в соответствующем <code>show</code> действии контроллера Users. Как вы и ожидали, мы используем метод <code>find</code> на модели User (<a class="ref" href="modeling-users#sec:finding_user_objects">Раздел&nbsp;6.1.4</a>) для получения пользователя из базы данных, как это показано в <a class="ref" href="sign-up#code:user_show_action">Листинге&nbsp;7.5</a>.</p>

<div class="label" id="code:user_show_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.5.</span> <span class="description">Контроллер Users с действием <code>show</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Здесь мы использовали <code>params</code> для получения id&nbsp;пользователя. Когда мы сделаем соответствующий запрос в контроллер Users, <code>params[:id]</code> будет пользовательким id&nbsp;<tt>1</tt>, так что эфект тот же что и с методом <code>find</code></p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>который мы видели в <a class="ref" href="modeling-users#sec:finding_user_objects">Разделе&nbsp;6.1.4</a>. (Технически, <code>params[:id]</code> являестя строкой&nbsp;<code>"1"</code>, но <code>find</code> достаточно умен, чтобы преобразовать это в целое число.)</p>

<p>С представлением и определенным действием, URI <a href="http://localhost:3000/users/1">/users/1</a> работает замечательно (<a class="ref" href="sign-up#fig:user_show_rails_3">Рис.&nbsp;7.6</a>). Обратите внимание что отладочная информация в <a class="ref" href="sign-up#fig:user_show_rails_3">Рис.&nbsp;7.6</a> подтверждает значение <code>params[:id]</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&#39;1&#39;</span>
</pre></div>
</div>


<p>Вот почему код</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>в <a class="ref" href="sign-up#code:user_show_action">Листинге&nbsp;7.5</a> находит пользователя с id&nbsp;<tt>1</tt>.</p>

<div class="label" id="fig:user_show_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_bootstrap.png" alt="user_show_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.6: </span><span class="description">Страница показывающая пользователя на <a href="http://localhost:3000/users/1">/users/1</a> после добавления ресурса Users.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:tests_with_factories"></div>


<h3><a id="sec:7.1.3" href="sign-up#sec:tests_with_factories" class="heading"><span class="number">7.1.3</span> Тестирование страницы показывающей пользователя (с фабриками)</a></h3>


<p>Теперь, когда у нас есть минимально рабочий профиль, пришло время поработать над версией из наброска на <a class="ref" href="sign-up#fig:profile_mockup_profile_name">Рис.&nbsp;7.1</a>. Как и в случае с созданием статических страниц (<a class="ref" href="static-pages#top">Глава&nbsp;3</a>) и моделью User (<a class="ref" href="modeling-users#top">Глава&nbsp;6</a>), мы сделаем это используя разработку через тестирование.</p>

<p>Вспомните из <a class="ref" href="filling-in-the-layout#sec:signup_url">Раздела&nbsp;5.4.2</a> что мы избрали интеграционные тесты для страниц связанных с ресурсом Users. В случае со страницей регистрации, наш тест вначале посещает <code>signup_path</code> а затем проверяет правильность <code>h1</code> и <code>title</code> тегов, как это показано в <a class="ref" href="filling-in-the-layout#code:user_pages_spec">Листинге&nbsp;5.31</a> и повторено в <a class="ref" href="sign-up#code:initial_signup_test">Листинге&nbsp;7.6</a>. (Обратите внимание, что мы опустили <code>full_title</code> хелпер из <a class="ref" href="filling-in-the-layout#sec:pretty_rspec">Раздела&nbsp;5.3.4</a> поскольку полный заголовок уже адекватно протестирован.)</p>

<div class="label" id="code:initial_signup_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.6.</span> <span class="description">Резюме начального спека страниц пользователя. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signup page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для того чтобы протестировать страницу показывающую пользователя, нам необходим объект модели User для того чтобы коду в действии <code>show</code> (<a class="ref" href="sign-up#code:user_show_action">Листинг&nbsp;7.5</a>) было что искать:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
  <span class="c1"># Code to make a user variable</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>где нам нужно заполнить коментарий соответствующим кодом. Здесь используется именованный маршрут <code>user_path</code> (<a class="ref" href="sign-up#table:RESTful_users">Таблица&nbsp;7.1</a>) для генерации пути к странице показывающей данного пользователя. Затем мы тестируем что <code>h1</code> и <code>title</code> теги содержат имя пользователя.</p>

<p>Для того чтобы создать необходимый объект модели User, мы можем использовать Active Record для создания пользователя посредством <code>User.create</code>, но практика показывает, что пользовательские <em>фабрики</em> являются более удобным способом определения вставки в базу данных объектов user. Мы будем использовать фабрики генерируемые <a href="http://github.com/thoughtbot/factory_girl">Factory Girl</a>,<sup class="footnote" id="fnref:7.6"><a href="#fn:7.6">6</a></sup>  - Ruby гемом сделанным хорошими людьми из <a href="http://thoughtbot.com/">thoughtbot</a>. Как и RSpec, Factory Girl определяет предметно-ориентированный язык в Ruby, в данном случае предназначенный для определения объектов Active Record. Синтаксис прост, опирается на  Ruby блоки и кастомные методы для определения атрибутов описываемого объекта. Для случаев вроде тех что мы увидим в этой главе, преимущество над Active Record иожет быть неочевидным, на мы будем использовать более продвинутые техники фабрик в последующих главах. Например, в <a class="ref" href="updating-showing-and-deleting-users#sec:pagination">Разделе&nbsp;9.3.3</a> нам понадобится создать набор пользователей с уникальными адресами электронной почты и фабрики позволят нам проделать это с легкостью.</p>

<p>Как и с другими Ruby гемами, мы можем установить Factory Girl добавив строку в <code>Gemfile</code> используемый Bundler-ом (<a class="ref" href="sign-up#code:gemfile_factory_girl">Listing&nbsp;7.7</a>). (Поскольку Factory Girl нужна только в тестах, мы поместили ее в группу <code>:test</code>.)</p>

<div class="label" id="code:gemfile_factory_girl"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.7.</span> <span class="description">Добавление Factory Girl в <code>Gemfile</code>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.4.0&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Затем устанавливаем как обычно:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Мы поместим все наши фабрики Factory Girl в файл <code>spec/factories.rb</code>, который автоматически будет загружен RSpec-ом. Код необходимый для создания фабрики User представлен в <a class="ref" href="sign-up#code:user_factory">Листинге&nbsp;7.8</a>.</p>

<div class="label" id="code:user_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.8.</span> <span class="description">Фабрика для симуляции объектов модели User. <br /> <code>spec/factories.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">&quot;Michael Hartl&quot;</span>
    <span class="n">email</span>    <span class="s2">&quot;michael@example.com&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Передавая символ <code>:user</code> команде <code>factory</code>, мы говорим Factory Girl что последующее определение предназначено для объекта модели User.</p>

<p>С определением в <a class="ref" href="sign-up#code:user_factory">Листинге&nbsp;7.8</a>, мы можем создать фабрику User в тестах используя команду <code>let</code> (<a class="ref" href="modeling-users#sidebar:let">Блок&nbsp;6.3</a>) и метода <code>FactoryGirl</code> поддерживаемого Factory Girl:</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>Конечный результат представлен в <a class="ref" href="sign-up#code:user_show_page_test">Листинге&nbsp;7.9</a>.</p>

<div class="label" id="code:user_show_page_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.9.</span> <span class="description">Тест для страницы показывающей пользователя. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>В этой точке вам необходимо проверить что набор тестов в красном:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Мы можем получить зеленые тесты с кодом из <a class="ref" href="sign-up#code:name_title_and_heading">Листинга&nbsp;7.10</a>.</p>

<div class="label" id="code:name_title_and_heading"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.10.</span> <span class="description">Добавление заголовка браузера и заголовка первого урованя для страницы профиля пользователя. <br /> <code>app/views/users/show.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>Повторный запуск тестов должен подтвердить что тесты из <a class="ref" href="sign-up#code:user_show_page_test">Листинга&nbsp;7.9</a> теперь проходят:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Вы быстро заметите что тесты с Factory Girl -  <em>медленные</em>. И это происходит не по вине Factory Girl и фактически это <em>фича</em>, а не баг. Проблема связана с тем, что алгоритм BCrypt используемый в <a class="ref" href="modeling-users#sec:an_encrypted_password">Разделе&nbsp;6.3.1</a> для создания хэша безопасного пароля является медленным по своей природе: именно низкая скорость BCrypt отчасти делает его таким сложным для взлома. К сожалению, это означает что создание пользователей может утопить набор тестов; к счастью, есть простой способ исправить это. BCrypt использует <em>фактор стоимости</em> для управления вычислительной сложностью создаваемого безопасного хэша. Дефолтное значение призвано обеспечить безопасность, а не скорость и для рабочих приложений это здорово, но в тестах наши потребности противоположны: мы хотим <em>быстрые</em> тесты и нас совершенно не тревожит безопасность хэшей паролей тестовых пользователей. Решением является добавление нескольких строк в файл конфигурации тестов, <code>config/environments/test.rb</code>, для переопределения фактора стоимости от его дефолтного безопасного значения к его минимально возможному значению, как это показано в <a class="ref" href="sign-up#code:test_bcrypt_cost_factor">Листинге&nbsp;7.11</a>. Даже для небольшого набора тестов, выигрыш в скорости от этого шага может быть весьма значительным и я настоятельно рекомендую включить <a class="ref" href="sign-up#code:test_bcrypt_cost_factor">Листинг&nbsp;7.11</a> в ваш <code>test.rb</code>.</p>

<div class="label" id="code:test_bcrypt_cost_factor"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.11.</span> <span class="description">Переопределение фактора стоимости BCrypt в тестовом окружении. <br /> <code>config/environments/test.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Speed up tests by lowering BCrypt&#39;s cost function.</span>
  <span class="nb">require</span> <span class="s1">&#39;bcrypt&#39;</span>
  <span class="n">silence_warnings</span> <span class="k">do</span>
    <span class="ss">BCrypt::Engine</span><span class="o">::</span><span class="no">DEFAULT_COST</span> <span class="o">=</span> <span class="ss">BCrypt::Engine</span><span class="o">::</span><span class="no">MIN_COST</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:a_gravatar_image"></div>


<h3><a id="sec:7.1.4" href="sign-up#sec:a_gravatar_image" class="heading"><span class="number">7.1.4</span> Изображение Gravatar и боковая панель</a></h3>


<p>Определив базовую страницу пользователя в предыдущем разделе, теперь мы немного улучшим ее, добавив изображение пользователя и начальную реализацию боковой панели пользователя. При создании страницы мы сфокусируемся на ее внешнем виде, не особо заботясь о ее структуре, это означает, что (по крайней мере пока) мы не будем писать тесты. Когда мы подойдем к аспектам представления, более подверженным ошибкам, таким как пагинация (<a class="ref" href="updating-showing-and-deleting-users#sec:pagination">Раздел&nbsp;9.3.3</a>), мы продолжим разработку через тестирование.</p>

<p>Мы начнем с добавления &ldquo;globally recognized avatar&rdquo;, or <a href="http://gravatar.com/">Gravatar</a>, к профилю пользователя.<sup class="footnote" id="fnref:7.7"><a href="#fn:7.7">7</a></sup> Изначально созданный Tom Preston-Werner (сооснователь <a href="http://github.com/">GitHub</a>) и впоследствии приобретенный <a href="http://automattic.com/">Automattic</a> (создатели <a href="http://wordpress.com/">WordPress</a>), Gravatar это бесплатный сервис который позволяет польователям загружать изображения и связывать из с подконтрольными им адресами электронной почты. Gravatar это удобный способ добавить изображения пользователей не связываясь с проблемами загрузки изображений, их обрезкой и хранением; все что нам нужно, это создать правильный URI Gravatar изображения используя адрес электронной почты пользователя и соответствующее изображение Gravatar появится автоматически.<sup class="footnote" id="fnref:7.8"><a href="#fn:7.8">8</a></sup></p>

<p>Мы планируем определить вспомогательную функцию <code>gravatar_for</code> которая будет возвращать изображение Gravatar для данного пользователя, как это показано в <a class="ref" href="sign-up#code:user_show_view_with_gravatar">Листинге&nbsp;7.12</a>.</p>

<div class="label" id="code:user_show_view_with_gravatar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.12.</span> <span class="description">Представление показывающее пользователя с именем и Gravatar. <br /> <code>app/views/users/show.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>В этой точке вы можете проверить что набор тестов не проходит:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Из-за того что метод <code>gravatar_for</code> неопредлен, страница показывающая пользователя в настоящий момент не работает. (Отлов подобных ошибок это, возможно самый полезный аспект тестов представлений. Вот почему так важно наличие <em>хоть каких-то</em> тестов представлений, даже минималистичных.)</p>

<p>По умолчанию, методы определеннные в любом файле хелпера является автоматически доступным в любом представлении, но для удобства мы прмустим метод <code>gravatar_for</code> в файл для хелперов, связанных с контроллером Users. Как  <a href="http://en.gravatar.com/site/implement/hash/">отмечено на главной странице Gravatar</a>, Gravatar URI основывается на <a href="http://en.wikipedia.org/wiki/MD5">MD5 hash</a> адреса электронной почты пользователя. В Ruby, алгоритм MD5 хэширования реализутся с помощью метода <code>hexdigest</code>, который является частью библиотеки <code>Digest</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;MHARTL@example.COM&quot;</span><span class="o">.</span>
<span class="gp">&gt;&gt; </span><span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
<span class="go">=&gt; &quot;1fda4469bcbec3badf5418269ffc5968&quot; </span>
</pre></div>
</div>


<p>Поскольку адреса электронной почты нечувствительны к регистру (<a class="ref" href="modeling-users#sec:format_validation">Раздел&nbsp;6.2.4</a>), в отличие от MD5 хэшей, мы используем метод <code>downcase</code> для того чтобы быть уверенными в том, что аргумент передаваемый в <code>hexdigest</code> находится в нижнем регистре. Получившийся  хелпер <code>gravatar_for</code> представлен в  <a class="ref" href="sign-up#code:gravatar_for_helper">Листинге&nbsp;7.13</a>.</p>

<div class="label" id="code:gravatar_for_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.13.</span> <span class="description">Определение вспомогательного метода <code>gravatar_for</code>. <br /> <code>app/helpers/users_helper.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;http://gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Код в <a class="ref" href="sign-up#code:gravatar_for_helper">Листинге&nbsp;7.13</a> возвращает тег  img для Gravatar с классом <code>"gravatar"</code> и альтернативным текстом эквивалентным имени пользователя (что особенно удобно для браузеров используемых слабовидящими людьми работающих с помощью считывателей экрана). Вы можете проверить что теперь наборе тестов проходит:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Страница профиля представленная на <a class="ref" href="sign-up#fig:profile_with_gravatar">Рис.&nbsp;7.7</a>, показывающая дефолтное изображение Gravatar, выглядит подобным образом т.к. <code>user@example.com</code> is an invalid email address (the <a href="http://example.com/">example.com</a> domain is reserved for examples).</p>

<div class="label" id="fig:profile_with_gravatar"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_with_gravatar_bootstrap.png" alt="profile_with_gravatar_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.7: </span><span class="description">Страница профиля пользователя  <a href="http://localhost:3000/users/1">/users/1</a> with the default Gravatar.&nbsp;<a href="http://railstutorial.org/images/figures/profile_with_gravatar_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Для того, чтобы отобразить кастомный Gravatar в нашем приложении, мы будем использовать <code>update_attributes</code> (<a class="ref" href="modeling-users#sec:updating_user_objects">Раздел&nbsp;6.1.5</a>) для обновления пользователя в базе данных:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Здесь мы назначили пользователю адрес электронной почты <code>example@railstutorial.org</code>, который я связал с логотипом Rails Tutorial, как это видно на <a class="ref" href="sign-up#fig:profile_custom_gravatar">Рис.&nbsp;7.8</a>.</p>

<div class="label" id="fig:profile_custom_gravatar"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_custom_gravatar_bootstrap.png" alt="profile_custom_gravatar_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.8: </span><span class="description">Страница показывающая пользователя с кастомным Gravatar.&nbsp;<a href="http://railstutorial.org/images/figures/profile_custom_gravatar_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Последний элемент, необходимый для завершения наброска из <a class="ref" href="sign-up#fig:profile_mockup_profile_name">Рис.&nbsp;7.1</a> это начальная версия пользовательской боковой панели. Мы реализуем ее с помощью тега <code>aside</code>, который используется для элементов (таких как сайдбары), которые дополняют страницу, но также могут быть использованы отдельно. Мы включаем <code>row</code> и <code>span4</code> классы, которые являются частью Bootstrap. Код для измененной страницы показывающей пользователя представлен в <a class="ref" href="sign-up#code:user_show_with_sidebar">Листинге&nbsp;7.14</a>.</p>

<div class="label" id="code:user_show_with_sidebar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.14.</span> <span class="description">Добавление боковой панели к представлению user <code>show</code>. <br /> <code>app/views/users/show.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Имея соответствующие HTML элементы и CSS классы, мы можем отстилить страницу профиля (включая боковую панель и Gravatar) с SCSS показанным в <a class="ref" href="sign-up#code:sidebar_css">Листинге&nbsp;7.15</a>. (Обратите внимание на наследование CSS правил, которое работает только благодаря Sass, используемой файлопроводом.) Получившаяся страница показана на <a class="ref" href="sign-up#fig:user_show_sidebar_css">Рис.&nbsp;7.9</a>.</p>

<div class="label" id="code:sidebar_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.15.</span> <span class="description">SCSS для стилизации страницы показывающей пользователя, включая боковую панель. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">section</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">span</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.6</span><span class="kt">em</span><span class="p">;</span>
      <span class="na">text-align</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_show_sidebar_css"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_sidebar_css_bootstrap.png" alt="user_show_sidebar_css_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.9: </span><span class="description">Страница показывающая пользователя  <a href="http://localhost:3000/users/1">/users/1</a> с боковой панелью и CSS.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_sidebar_css_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:signup_form"></div>


<h2><a id="sec:7.2" href="sign-up#sec:signup_form" class="heading"><span class="number">7.2</span> Регистрационная форма</a></h2>


<p>Теперь, когда у нас есть рабочая (хоть и не завершенная) страница профиля пользователя, мы готовы приступить к созданию формы для регистрации на нашем сайте. Мы видели на <a class="ref" href="filling-in-the-layout#fig:new_signup_page">Рис.&nbsp;5.9</a> (дублированном на <a class="ref" href="sign-up#fig:blank_signup_page_recap">Рис.&nbsp;7.10</a>) что страница регистрации в настоящий момент пуста и совершенно бесполезна для регистрации новых пользователей. Целью этого раздела является разработка формы регистрации из <a class="ref" href="sign-up#fig:signup_mockup">Рис.&nbsp;7.11</a>.</p>

<div class="label" id="fig:blank_signup_page_recap"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/new_signup_page_bootstrap.png" alt="new_signup_page_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.10: </span><span class="description">Текущее состояние страницы регистрации  <a href="http://localhost:3000/signup">/signup</a>.&nbsp;<a href="http://railstutorial.org/images/figures/new_signup_page_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="fig:signup_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_mockup_bootstrap.png" alt="signup_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.11: </span><span class="description">Набросок стрыницы регистрации пользователей.&nbsp;<a href="http://railstutorial.org/images/figures/signup_mockup_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Поскольку мы говорим о создании пользователей через веб-интерфейс, давайте удалим пользователя созданного через консоль в <a class="ref" href="modeling-users#sec:creating_a_user">Разделе&nbsp;6.3.5</a>. Простейшим способом сделать это является очистка базы данных с помощью Rake-задачи <code>db:reset</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
</pre></div>
</div>


<p>После очистки базы данных, на некоторых системах также необходимо заново подготовить тестовую базу данных:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>Наконец, на некоторых системах вам может потребоваться перезагрузка сервера для того чтобы изменения вступили в силу.<sup class="footnote" id="fnref:7.9"><a href="#fn:7.9">9</a></sup></p>

<div class="label" id="sec:tests_for_user_signup"></div>


<h3><a id="sec:7.2.1" href="sign-up#sec:tests_for_user_signup" class="heading"><span class="number">7.2.1</span> Тесты для регистрации пользователя</a></h3>


<p>До появления мощных веб-фреймворков с полным набором тестировочных средств, тестирование часто доставляло много хлопот. Например, для тестирования страницы регистрации вручную, нам бы пришлось посещать страницу в браузере, затем заполнять форму различными валидными и невалидными данными и проверять что в каждом случае поведение приложения соответствует ожидаемому. Кроме того, нам бы пришлось проделывать это каждый раз при изменении приложения. С помощью RSpec и Capybara мы сможем написать выразительные тесты, которые автоматизируют задачи, которые раньше делались вручную.</p>

<p>Мы уже видели как Capybara поддерживает интуитивно понятный синтаксис веб=навигации. До сих пор мы в основном использовали <code>visit</code> для посещения конкретных страниц, но Capybara может гораздо больше, включая заполнение полей, вроде тех что мы видели на <a class="ref" href="sign-up#fig:signup_mockup">Рис.&nbsp;7.11</a> и кликанья по кнопке. Синтаксис выглядит примерно так:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>Сейчас нашей целью является написание тестов для правильного поведения при предоставлении невалидной и валидной регистрационной информации. Поскольку эти тесты довольно продвинутые, мы будем писать их постепенно. Если вам интересно посмотреть как они работают (включая файл в который они должны быть помещены), вы можете перейти непосредственно к <a class="ref" href="sign-up#code:basic_signup_tests">Листингу&nbsp;7.16</a>.</p>

<p>Наша первая задача это тестирование провальной отправки регистрационной формы, и мы можем симулировать отправку невалидных данных посетив страницу и кликнув по кнопке с помощью <code>click_button</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>Это эквивалентно посещению страницы регистрации и отправке формы незаполненной регистрационной информацией. Аналогично, для симуляции отправки валидных данных, мы заполняем форму валидными данными с помощью <code>fill_in</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>Эти тесты проверяют, что при клике по кнопке &ldquo;Sign up&rdquo;, поведение приложения соответствует нашим ожиданиям: создается новый пользователь если информация валидна и не создается новый пользователь в случае когда она невалидна. Для того чтобы сделать это мы проверяем <em>количество</em> пользователей и наши тесты будут использовать метод <code>count</code>, доступный для каждого класса Active Record, включая <code>User</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>Здесь <code>User.count</code> является <code>0</code> поскольку мы очистили базу данных в начале этого раздела.</p>

<p>При отправке невалидных данных, мы ожидаем что количество пользователей не будет изменено; при отправке валидных данных мы ожидаем что оно изменится на 1. Мы можем выразить это в RSpec скомбинировав метод <code>expect</code> с методом <code>to</code> или методом <code>not_to</code>. Мы начнем со случая с невалидными данными поскольку он проще; мы посетим страницу регистрации и кликнем по кнопке, и мы ожидаем что это <em>не</em> изменит количества пользователей:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>Обратите внимание, что <code>expect</code> обворачивает <code>click_button</code> в блок (<a class="ref" href="rails-flavored-ruby#sec:blocks">Раздел&nbsp;4.3.2</a>). Что необходимо для работы метода <code>change</code>, который принимает в качестве аргумента объект и символ, а затем вычисляет результат вызова этого символа в качестве метода на объекте до и после блока. Другими словами, код</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>вычисляет</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>до и после выполнения</p>

<div class="code"><div class="highlight"><pre><span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>В данном случае, мы хотим чтобы данный код <em>не</em> изменял количества, что мы можем выразить с помощью метода <code>not_to</code>. В результате, закрыв клик по кнопке в блоке, мы можем заменить</p>

<div class="code"><div class="highlight"><pre><span class="n">initial</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
<span class="n">final</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">initial</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">final</span>
</pre></div>
</div>


<p>на одну строку</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>которая читается как естетсвенный язык и является намного более компактной.</p>

<p>Случай с валидными данными аналогичен, но вместо проверки того что количество пользователей не изменилось, мы проверяем что клик по кнопке изменяет их количество на 1:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">expect</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>Здесь используется метод <code>to</code> поскольку мы ожидаем что клик по кнопке (вкупе с валидными данными) изменит количество пользователей на единицу.</p>

<p>Комбинирование двух случаев с соответствующими блоками <code>describe</code> и выталкивание общего кода в блоки <code>before</code>, приводит нас к хорошим базовым тестам для регистрации пользователей, как это показано в <a class="ref" href="sign-up#code:basic_signup_tests">Листинге&nbsp;7.16</a>. Здесь мы вынесли общий текст для кнопки регистрации в переменную <code>submit</code>, которую мы определили с помощью метода <code>let</code>.</p>

<div class="label" id="code:basic_signup_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.16.</span> <span class="description">Хорошие базовые тесты для регистрации пользователей. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:submit</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;should not create a user&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should create a user&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Мы будем добавлять тесты по мере надобности в последующих разделах, но базовые тесты в <a class="ref" href="sign-up#code:basic_signup_tests">Листинге&nbsp;7.16</a> уже покрывают внушительный объем функционала. Для того чтобы получить их прохождение, мы должны создать страницу регистрации с необходимым минимумом правильных элементов, предопределить направление пользователя в правильное место после отправки формы и создание нового пользователя в базе данных только в случае если полученная информация валидна.</p>

<p>Конечно же, в этой точке тесты должны быть провальными:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:using_form_for"></div>


<h3><a id="sec:7.2.2" href="sign-up#sec:using_form_for" class="heading"><span class="number">7.2.2</span> Использование <tt>form_for</tt></a></h3>


<p>Теперь, когда у нас есть хорошие провальные тесты для регистрации пользователя, мы начнем добиваться их прохождения, для начала создав <em>форму</em> для регистрации пользователей. Мы можем сделать это в Rails с помощью вспомогательного метода <code>form_for</code>, который принимает объект Active Record и конструирует форму используя атрибуты объекта. Результат представлен в <a class="ref" href="sign-up#code:signup_form">Листинге&nbsp;7.17</a>. (Читатели знакомые с  Rails&nbsp;2.x должны обратить вниманин что <code>form_for</code> использует &ldquo;процент-равно&rdquo; ERb синтаксис для вставки контента; там где Rails&nbsp;2.x используют <tt class="verb">&lt;% form_for ... %&gt;</tt>, Rails&nbsp;3 вместо этого используют <tt class="verb">&lt;%= form_for ... %&gt;</tt>.)</p>

<div class="label" id="code:signup_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.17.</span> <span class="description">Форма для регистрации новых пользователей. <br /> <code>app/views/users/new.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Create my account&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Давайте рассмотрим этот код по частям. Наличие ключевого слова <code>do</code> указывает на то, что <code>form_for</code> принимает блок с одной переменной, которую мы назвали <code>f</code> (от &ldquo;form&rdquo;):</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Как это зачастую происходит с хелперами Rails, нам нет надобности знать о подробностях реализации, но нам <em>необходимо</em> знать что делает  объект <code>f</code>: при вызове с методом соответствующим <a href="http://www.w3schools.com/html/html_forms.asp">элементу HTML формы</a> &mdash; таким как текстовое поле, радио кнопка, или поле пароля &mdash; он возвращает особым образом организованный код для этого элемента для установки атрибута объекта <code>@user</code>. Другими словами,</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>создает HTML необходимый для создания элемента маркированного текстового поля для назначения атрибута <code>name</code> модели User. (Мы взглянем на сам  HTML в <a class="ref" href="sign-up#sec:the_form_html">Разделе&nbsp;7.2.3</a>.)</p>

<p>Для того чтобы увидеть это в действии нам необходимо посмотреть на HTML производимый этой формой, но здесь мы сталкиваемся с проблемой: страница в настоящее время сломана, поскольку мы не установили переменную <code>@user</code> &mdash; как все неопределенные переменные экземпляра (<a class="ref" href="rails-flavored-ruby#sec:a_user_class">Раздел&nbsp;4.4.5</a>), <code>@user</code> в настоящее время является <code>nil</code>. Соответственно, если вы запустите ваш набор тестов в этой точке, вы увидите что тесты структуры страницы регистрации из  <a class="ref" href="sign-up#code:initial_signup_test">Листинга&nbsp;7.6</a> (т.е., <code>h1</code> и <code>title</code>) сейчас провальны:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;signup page&quot;</span>
</pre></div>
</div>


<p>(Флаг <code>-e</code> в данном случае позволяет запустить только спеки, чье описание совпадает с <code>"signup page"</code>. В частности, обратите внимание что это <em>не</em> подстрока <code>"signup"</code>, что привело бы к запуску всех тестов в <a class="ref" href="sign-up#code:basic_signup_tests">Листинге&nbsp;7.16</a>.) Для того чтобы вновь сделать эти тесты проходящими и для того чтобы отрендерить нашу форму, мы должны определить переменную <code>@user</code> в действии контроллера, соответствующем  <code>new.html.erb</code>, т.е., в действии <code>new</code> контроллера Users. Хелпер <code>form_for</code> ожидает что <code>@user</code> будет объектом User и поскольку мы создаем  <em>нового</em> пользователя, мы просто используем <code>User.new</code>, как это видно в <a class="ref" href="sign-up#code:new_action_with_user">Листинге&nbsp;7.18</a>.</p>

<div class="label" id="code:new_action_with_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.18.</span> <span class="description">Добавление переменной <code>@user</code> в действие <code>new</code>. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>После определения переменной <code>@user</code>, тесты для страницы регистрации должны пройти:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;signup page&quot;</span>
</pre></div>
</div>


<p>В этой точке у нас должна получиться форма (со стилями из <a class="ref" href="sign-up#code:form_css">Листинга&nbsp;7.19</a>) выглядящая как на  <a class="ref" href="sign-up#fig:signup_form">Рис.&nbsp;7.12</a>. Обратите внимание на повторное использование примеси <code>box_sizing</code> из <a class="ref" href="sign-up#code:mixin_and_debug">Листинга&nbsp;7.2</a>.</p>

<div class="label" id="code:form_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.19.</span> <span class="description">CSS для формы регистрации. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>

<span class="nt">input</span><span class="o">,</span> <span class="nt">textarea</span><span class="o">,</span> <span class="nt">select</span><span class="o">,</span> <span class="nc">.uneditable-input</span> <span class="p">{</span>
  <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#bbb</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">height</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:signup_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_form_bootstrap.png" alt="signup_form_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.12: </span><span class="description">Форма регистрации новых пользователей <a href="http://localhost:3000/signup">/signup</a>.&nbsp;<a href="http://railstutorial.org/images/figures/signup_form_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:the_form_html"></div>


<h3><a id="sec:7.2.3" href="sign-up#sec:the_form_html" class="heading"><span class="number">7.2.3</span> HTML формы.</a></h3>


<p>Как нам подсказывает <a class="ref" href="sign-up#fig:signup_form">Рис.&nbsp;7.12</a>, теперь страница регистрации рендерится как следует, что указывает на то, что код <code>form_for</code> в <a class="ref" href="sign-up#code:signup_form">Листинге&nbsp;7.17</a> производит валидный HTML. Если вы взглянете на HTML для сгенерированной формы (используя <a href="http://getfirebug.com/">Firebug</a> или функцию &ldquo;просмотр исходного кода страницы&rdquo; вашего браузера), вы должны увидеть разметку как в <a class="ref" href="sign-up#code:signup_form_html">Листинге&nbsp;7.20</a>. Хотя большая часть деталей несущественна для наших целей, давайте улучим минутку и ознакомимся с наиболее важными частями ее структуры.</p>

<div class="label" id="code:signup_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.20.</span> <span class="description">HTML для формы на <a class="ref" href="sign-up#fig:signup_form">Рис.&nbsp;7.12</a>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">&quot;UTF-8&quot;</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span>
      <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span>
         <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password_confirmation&quot;</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password_confirmation&quot;</span>
         <span class="na">name=</span><span class="s">&quot;user[password_confirmation]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span>
         <span class="na">value=</span><span class="s">&quot;Create my account&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>(Здесь я опустил HTML связанный с <em>authenticity token</em>, который Rails автоматически включают для предотвращения определенного вида атак, назывемого  <em>подделка межсайтовых запросов</em> (CSRF). См <a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token">введение в Rails authenticity token на Stack Overflow </a> если вас интересуют подробности того как это работает и почему это так важно.)</p>

<p>Мы начнем с внутренней структуры документа. Сравнивая <a class="ref" href="sign-up#code:signup_form">Листинг&nbsp;7.17</a> с <a class="ref" href="sign-up#code:signup_form_html">Листингом&nbsp;7.20</a>, мы видим что Embedded Ruby</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>производит HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>и</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>производит HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Как видно из <a class="ref" href="sign-up#fig:filled_in_form">Рис.&nbsp;7.13</a>, текстовые поля (<code>type="text"</code>) просто отображают их содержимое, в то время как поля паролей (<code>type="password"</code>) скрывают вводимое в целях безопасности, как это показано на <a class="ref" href="sign-up#fig:filled_in_form">Рис.&nbsp;7.13</a>.</p>

<div class="label" id="fig:filled_in_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/filled_in_form_bootstrap.png" alt="filled_in_form_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.13: </span><span class="description">Заполненная форма с <code>text</code> и <code>password</code> полями.&nbsp;<a href="http://railstutorial.org/images/figures/filled_in_form_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Как мы увидим в <a class="ref" href="sign-up#sec:signup_success">Разделе&nbsp;7.4</a>, ключом к созданию пользователя является специальный <code>name</code> атрибут в каждом <code>input</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Эти значения <code>name</code> позволяют Rails сконструировать хэш инициализации (через переменную <code>params</code>) для создания пользователей с использованием значений введеных пользователем, как мы это увидим в <a class="ref" href="sign-up#sec:signup_failure">Разделе&nbsp;7.3</a>.</p>

<p>Второй важный элемент это сам тег <code>form</code>. Rails создает тег <code>form</code> используя объект <code>@user</code>: поскольку каждый объект в Ruby знает свой класс (<a class="ref" href="rails-flavored-ruby#sec:constructors">Раздел&nbsp;4.4.1</a>), Rails определяет что <code>@user</code> принадлежит к классу <code>User</code>; кроме того, поскольку <code>@user</code> это <em>новый</em> пользователь, Rails знает что необходимо построить форму с <code>post</code> методом, который является правильным глаголом для создания нового объекта (<a class="ref" href="static-pages#sidebar:get_etc">Блок&nbsp;3.1</a>):</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>Здесь атрибуты <code>class</code> и <code>id</code>, по большому счету, не имеют особого значения; более важными являются <code>action="/users"</code> и <code>method="post"</code>. Совместно они формируют инструкцию для отправки HTTP запроса <tt>POST</tt> на URI /users. В следующих двух разделах мы увидим к чему это приводит.</p>

<div class="label" id="sec:signup_failure"></div>


<h2><a id="sec:7.3" href="sign-up#sec:signup_failure" class="heading"><span class="number">7.3</span> Провальная регистрация</a></h2>


<p>Хотя мы кратко рассмотрели HTML формы, показанной в <a class="ref" href="sign-up#fig:signup_form">Рис.&nbsp;7.12</a> (<a class="ref" href="sign-up#code:signup_form_html">Листинг&nbsp;7.20</a>), он (HTML) лучше всего понимается в контексте <em>сбоя регистрации</em>. В этом разделе мы создадим регистрационную форму которая принимает невалидные данные и вновь рендерит страницу регистрации со списком ошибок, как это показано на наброске <a class="ref" href="sign-up#fig:signup_failure_mockup">Рис.&nbsp;7.14</a>.</p>

<div class="label" id="fig:signup_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_mockup_bootstrap.png" alt="signup_failure_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.14: </span><span class="description">Набросок страницы неудавшейся регистрации.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_mockup_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:a_working_form"></div>


<h3><a id="sec:7.3.1" href="sign-up#sec:a_working_form" class="heading"><span class="number">7.3.1</span> Рабочая форма</a></h3>


<p>Нашим первым шагом будет устранение ошибки которая в настоящий момент возникает при отправке формы, что вы можете проверить в вашем браузере или запустив тесты для регистрации с невалидными данными:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="go">-e &quot;signup with invalid information&quot;</span>
</pre></div>
</div>


<p>Вспомните из <a class="ref" href="sign-up#sec:a_users_resource">Раздела&nbsp;7.1.2</a> что добавление <code>resources :users</code> в файл <code>routes.rb</code> (<a class="ref" href="sign-up#code:users_resource">Листинг&nbsp;7.3</a>) автоматически обеспечивает наше Rails приложение возможностью отвечать на RESTful URIs из <a class="ref" href="sign-up#table:RESTful_users">Таблицы&nbsp;7.1</a>. В частности, это приводит к тому, что <tt>POST</tt> запрос к /users обрабатывается действием <code>create</code>. Наша стратегия для действия <code>create</code> зaключается в использовании отправки формы для создания объекта нового пользователя с помощью <code>User.new</code>, попытке (провальной) сохранить этого пользователя и последующем рендеринге страницы регистрации для возможной повторной отправки формы. Давайте начнем с того что еще раз взглянем на код для формы регистрации:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>Как было отмечено в <a class="ref" href="sign-up#sec:the_form_html">Разделе&nbsp;7.2.3</a>, этот HTML выдает <tt>POST</tt> запрос к /users URI.</p>

<p>Мы можем получить прохождение теста для невалидных данных из <a class="ref" href="sign-up#code:basic_signup_tests">Листинга&nbsp;7.16</a> с кодом из <a class="ref" href="sign-up#code:first_create_action">Листинга&nbsp;7.21</a>. Этот листинг включает второе использование метода <code>render</code>, который мы впервые видели в контексте партиалов (<a class="ref" href="filling-in-the-layout#sec:partials">Раздел&nbsp;5.1.3</a>); как вы можете видеть, <code>render</code> также работает и в действиях контроллера. Обратите внимание что мы воспользовались этой возможностью чтобы представить ветвящуюся структуру <code>if</code>-<code>else</code>, которая позволяет нам обрабатывать случаи сбоя и успеха раздельно, в зависимости от значения <code>@user.save</code>, которое (как мы видели в <a class="ref" href="modeling-users#sec:creating_user_objects">Разделе&nbsp;6.1.3</a>) может быть либо <code>true</code> либо <code>false</code> в зависимости от успешности сохранения.</p>

<div class="label" id="code:first_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.21.</span> <span class="description">Действие <code>create</code> которое может обрабатывать провальную регистрацию (но не успешную). <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Лучший способ понять, как работает код в <a class="ref" href="sign-up#code:first_create_action">Листинге&nbsp;7.21</a> это <em>отправить</em> форму с некоторыми невалидными регистрационными данными; результаты представлены на <a class="ref" href="sign-up#fig:signup_failure_rails_3">Рис.&nbsp;7.15</a> и полная отладочная информация представлена на <a class="ref" href="sign-up#fig:signup_failure_rails_3_bootstrap_debug">Рис.&nbsp;7.16</a>.</p>

<div class="label" id="fig:signup_failure_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_rails_3_bootstrap.png" alt="signup_failure_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.15: </span><span class="description">Сбой регистрации.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_rails_3_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="fig:signup_failure_rails_3_bootstrap_debug"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_rails_3_bootstrap_debug.png" alt="signup_failure_rails_3_bootstrap_debug" /></span></div><div class="caption"><span class="header">Рис. 7.16: </span><span class="description">Отладочная информация сбоя регистрации.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_rails_3_bootstrap_debug-full.png">(полный размер)</a></span></div></div>


<p>Чтобы получить более четкую картину того, как Rails обрабатывает предоставление регистрационных данных, давайте поближе познакомимся с хэшем <code>params</code> из отладочной информации (<a class="ref" href="sign-up#fig:signup_failure_rails_3_bootstrap_debug">Рис.&nbsp;7.16</a>):</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Foo Bar</span>
  <span class="l-Scalar-Plain">password_confirmation</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bar</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo@invalid</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create my account</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
</pre></div>
</div>


<p>Мы видели, начиная с <a class="ref" href="sign-up#sec:a_users_resource">Раздела&nbsp;7.1.2</a> что хэш <code>params</code> содержит информацию о каждом запросе; в случае URI типа /users/1, значение <code>params[:id]</code> это <code>id</code> соответствующего пользователя (<code>1</code>&nbsp;в этом примере). В случае отправки регистрационной формы, <code>params</code> вместо этого содержит хэш хэшей, конструкцию, которую мы впервые видели в <a class="ref" href="rails-flavored-ruby#sec:hashes_and_symbols">Разделе&nbsp;4.3.3</a>, который представил стратегически названную <code>params</code> переменную в консольной сессии. Эта отладочная информация показывает, что предоставление (отправка) формы дает в результате <code>user</code> хэш с атрибутами, соответствующими предоставленным значениям, где ключи происходят от <code>name</code> атрибутов тегов <code>input</code> которые мы видели в <a class="ref" href="sign-up#code:signup_form">Листинге&nbsp;7.17</a>; например, значение</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>с именем <code>"user[email]"</code> это именно <code>email</code> атрибут хэша <code>user</code>.</p>

<p>Хотя хэш-ключи отображаются как строки в отладочном выводе, внутренне Rails использует символы, так что <code>params[:user]</code> на самом деле является хэшем атрибутов пользователей, именно тех атрибутов, что необходимы в качестве аргумента для <code>User.new</code>, как мы впервые видели в <a class="ref" href="rails-flavored-ruby#sec:a_user_class">Разделе&nbsp;4.4.5</a> и как представлено в <a class="ref" href="sign-up#code:first_create_action">Листинге&nbsp;7.21</a>. Это означает, что строка</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>эквивалентна</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Конечно, инстанцирование такой переменной имеет значение для успешной регистрации &mdash; как мы увидим в <a class="ref" href="sign-up#sec:signup_success">Разделе&nbsp;7.4</a>, как только <code>@user</code> правильно определена, вызов <code>@user.save</code> это все, что необходимо для завершения регистрации &mdash; но это имеет свои последствия даже в случае сбоя регистрации, рассматриваемого здесь. Обратите внимание на то, что на <a class="ref" href="sign-up#fig:signup_failure_rails_3">Рис.&nbsp;7.15</a> поля <em>предварительно заполнены</em> данными из провальной отправки. Это происходит потому что <code>form_for</code> автоматически заполняет поля атрибутами объекта <code>@user</code>, так что, например, если <code>@user.name</code> это <code>"Foo"</code>, то</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>будет производить HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;Foo&quot;</span><span class="nt">/&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>Здесь <code>value</code> тега <code>input</code> это <code>"Foo"</code>, что и появляется в текстовом поле.</p>

<p>Как вы возможно догадались, теперь, когда мы можем отправить форму без генерации ошибки, тест для провальной регистрации должен пройти:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="go">-e &quot;signup with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec:signup_error_messages"></div>


<h3><a id="sec:7.3.2" href="sign-up#sec:signup_error_messages" class="heading"><span class="number">7.3.2</span> Сообщения об ошибках при регистрации</a></h3>


<p>Хотя это и не является строго обязательным, все же полезно выводить сообщения об ошибках при сбое регистрации, чтобы указать на проблемы, которые помешали успешной регистрации пользователя. Rails предоставляет именно такие сообщения, основанные на валидациях модели User. Рассмотрим, например, попытку сохранения пользователя с неправильным адресом электронной почты и коротким паролем:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                <span class="ss">password:</span> <span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;dude&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Email is invalid&quot;, &quot;Password is too short (minimum is 6 characters)&quot;]</span>
</pre></div>
</div>


<p>Здесь объект <code>errors.full_messages</code> (который мы видели кратко в <a class="ref" href="modeling-users#sec:presence_validation">Разделе&nbsp;6.2.2</a>) содержит массив сообщений об ошибках.</p>

<p>Как и в консольной сессии выше, сбой сохранения в <a class="ref" href="sign-up#code:first_create_action">Листинге&nbsp;7.21</a> генерирует список сообщений об ошибках, связанных с объектом <code>@user</code>. Для отображения сообщения в браузере, мы рендерим партиал error_messages на странице user <code>new</code> как это показано в <a class="ref" href="sign-up#code:f_error_messages">Листинге&nbsp;7.22</a>. (Написание теста на сообщения об ошибках это хорошая идея и мы оставим эти тесты в качестве упражнения; см. <a class="ref" href="sign-up#sec:signup_exercises">Раздел&nbsp;7.6</a>.) Стоит отметить что этот партиал сообщений об ошибках лишь первая попытка; конечная версия представлена в <a class="ref" href="user-microposts#sec:creating_microposts">Разделе&nbsp;10.3.2</a>.</p>

<div class="label" id="code:f_error_messages"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.22.</span> <span class="description">Код для отображения сообщений об ошибках в форме регистрации. <br /> <code>app/views/users/new.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Заметим здесь, что мы <code>render</code> партиал <code>&rsquo;shared/error_messages&rsquo;</code>; что отражает общую конвенцию Rails, которая помещает частичные шаблоны, которые мы планируем использовать во многих контроллерах, в специально отведенный каталог <code>shared/</code>. (Мы увидим что эти планы реализованы в <a class="ref" href="updating-showing-and-deleting-users#sec:edit_form">Разделе&nbsp;9.1.1</a>.) Это означает, что мы должны создать этот новый каталог вместе с файлом партиала <code>_error_messages.html.erb</code>. Сам партиал представлен в <a class="ref" href="sign-up#code:errors_partial">Листинге&nbsp;7.23</a>.</p>

<div class="label" id="code:errors_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.23.</span> <span class="description">Партиал для отображения сообщений об ошибках отправки формы регистрации. <br /> <code>app/views/shared/_error_messages.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Этот частичный шаблон вводит несколько новых Rails и Ruby конструкций, в том числе два метода для объектов класса <code>Array</code>. Давайте откроем сеанс консоли, чтобы увидеть, как они работают. Первый метод это <code>count</code>, который просто возвращает количество элементов в объекте:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 3</span>
</pre></div>
</div>


<p>(Мы видели в <a class="ref" href="sign-up#sec:tests_for_user_signup">Разделе&nbsp;7.2.1</a> что объекты Active Record имеют <code>count</code> метод; теперь мы видим что этот метод присущ и нативным Ruby-объектам.) Другой новый метод это <code>any?</code>, который (совместно с  <code>empty?</code>) является одним из пары комплиментарных методов:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[].</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="o">[].</span><span class="n">any?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">any?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Мы видим здесь, что <code>empty?</code> метод, который мы впервые увидели в <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">Разделе&nbsp;4.2.3</a> в контексте строк, также работает с массивами, возвращая <code>true</code> для пустого массива и <code>false</code> в противном случае. Метод <code>any?</code> это просто противоположность <code>empty?</code>, он возвращает <code>true</code> если в массиве есть какие-нибудь элементы и <code>false</code> в противном случае.</p>

<p>Другая новая идея это текстовый хелпер <code>pluralize</code>. Он не доступен в консоли, но мы можем включить его явно через модуль <code>ActionView::Helpers::TextHelper</code> module:<sup class="footnote" id="fnref:7.10"><a href="#fn:7.10">10</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">include</span> <span class="ss">ActionView::Helpers</span><span class="o">::</span><span class="no">TextHelper</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1 error&quot; </span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;5 errors&quot;</span>
</pre></div>
</div>


<p>Мы видим здесь, что <code>pluralize</code> принимает целочисленный аргумент и возвращает число с правильной версией множественного числа его второго аргумента. В основе этого метода лежит мощный <em>инфлектор</em>, который знает как преобразовать во множественное число огромное количество слов (в том числе, многие с неправильным множественным числом):</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;woman&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;2 women&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;erratum&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;3 errata&quot;</span>
</pre></div>
</div>


<p>В результате код</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>возвращает <code>"0 errors"</code>, <code>"1 error"</code>, <code>"2 errors"</code> и т.д., в зависимости от количества ошибок, тем самым позволяя нам избежать грамматически неверных фраз вроде <code>"1 errors"</code>.</p>

<p>Обратите внимание, что <a class="ref" href="sign-up#code:errors_partial">Листинг&nbsp;7.23</a> включает CSS&nbsp;id <code>error_explanation</code> для использования в стилизации сообщений об ошибках. (Напомним, из <a class="ref" href="filling-in-the-layout#sec:custom_css">Раздела&nbsp;5.1.2</a> что CSS использует знак решетки <code>#</code> для стилизации id.) Кроме того, Rails автоматически помещает поля с ошибками в <code>div</code>ы с CSS классом <code>field_with_errors</code>. Эти метки затем позволят нам отредактироваь стиль сообщений об ошибках с SCSS показанным в <a class="ref" href="sign-up#code:error_messages_css">Листинге&nbsp;7.24</a>, который использует функцию Sass&rsquo; <code>@extend</code> для включения функциональности двух классов Bootstrap <code>control-group</code> и <code>error</code>. В результате чего, при провальной регистрации сообщения об ошибках окружены красным как это показано на <a class="ref" href="sign-up#fig:signup_error_messages">Рис.&nbsp;7.17</a>. Поскольку сообщения генерируются валидациями модели, они автоматически изменятся, если вы когда-нибудь поменяете свое мнение о, скажем, формате адресов электронной почты, или минимальной длине паролей.</p>

<div class="label" id="code:error_messages_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.24.</span> <span class="description">CSS для стилизации сообщений об ошибках. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nn">#error_explanation</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span><span class="mh">#f00</span><span class="p">;</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">18</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="k">@extend</span> <span class="nc">.control-group</span><span class="o">;</span>
  <span class="o">@</span><span class="nt">extend</span> <span class="nc">.error</span><span class="o">;</span>
 <span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:signup_error_messages"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_error_messages_bootstrap.png" alt="signup_error_messages_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.17: </span><span class="description">Сбой регистрации с сообщениями об ошибках.&nbsp;<a href="http://railstutorial.org/images/figures/signup_error_messages_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Для того чтобы увидеть результаты нашей работы в этом разделе, мы повторим шаги из теста провальной регистрации <a class="ref" href="sign-up#code:basic_signup_tests">Листинга&nbsp;7.16</a> посетив страницу регистрации и кликнув по &ldquo;Sign up&rdquo; с пустыми полями ввода. Результат показан на <a class="ref" href="sign-up#fig:blank_signup_password_digest">Рис.&nbsp;7.18</a>. Как вы догадываетесь, глядя на рабочую страницу, в этой точке соответствующий тест тоже должен пройти:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signup with invalid information&quot;</span>
</pre></div>
</div>


<div class="label" id="fig:blank_signup_password_digest"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/blank_signup_password_digest_bootstrap.png" alt="blank_signup_password_digest_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.18: </span><span class="description">Результат посещения <a href="http://localhost:3000/signup">/signup</a> и клика на &ldquo;Sign up&rdquo;.&nbsp;<a href="http://railstutorial.org/images/figures/blank_signup_password_digest_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>К сожалению, в сообщениях об ошибках, показанных на <a class="ref" href="sign-up#fig:blank_signup_password_digest">Рис.&nbsp;7.18</a> есть небольшой недостаток: ошибка для отсутствующего пароля выводится как &ldquo;Password digest can&rsquo;t be blank&rdquo; вместо более уместного &ldquo;Password can&rsquo;t be blank&rdquo;. Это плата за валидацию наличия  password digest скрытую в <code>has_secure_password</code>, как это было вкратце отмечено в <a class="ref" href="modeling-users#sec:has_secure_password">Разделе&nbsp;6.3.4</a>. Исправление этой проблемы остается в качестве упражнения (<a class="ref" href="sign-up#sec:signup_exercises">Раздел&nbsp;7.6</a>).</p>

<div class="label" id="sec:signup_success"></div>


<h2><a id="sec:7.4" href="sign-up#sec:signup_success" class="heading"><span class="number">7.4</span> Успешная регистрация</a></h2>


<p>Получив обработку отправки невалидной формы, теперь пришло время для завершения регистрационной формы, на самом деле сохранив нового пользователя (если валидный) в базу данных. Во-первых, мы попробуем сохранить пользователя; если сохранение пройдет успешно, информация пользователя будет записана в базу данных автоматически, а затем мы <em>перенаправим</em> браузер на страницу профиля пользователя (с дружеским приветствием), как это показано на наброске <a class="ref" href="sign-up#fig:signup_success_mockup">Рис.&nbsp;7.19</a>. Если это не удастся, мы просто отступим к сценарию, разработанному в <a class="ref" href="sign-up#sec:signup_failure">Разделе&nbsp;7.3</a>.</p>

<div class="label" id="fig:signup_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_success_mockup_bootstrap.png" alt="signup_success_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.19: </span><span class="description">Набросок успешной регистрации.&nbsp;<a href="http://railstutorial.org/images/figures/signup_success_mockup_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:the_finished_signup_form"></div>


<h3><a id="sec:7.4.1" href="sign-up#sec:the_finished_signup_form" class="heading"><span class="number">7.4.1</span> Завершенная форма регистрации</a></h3>


<p>Для того чтобы закончить работу с формой регистрации, нам необходимо заполнить закомментированный раздел в <a class="ref" href="sign-up#code:first_create_action">Листинге&nbsp;7.21</a> соответствующим поведением. Сейчас тесты для отправки валидной формы должны быть провальными:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signup with valid information&quot;</span>
</pre></div>
</div>


<p>Это происходит потому что дефолтным поведением для Rails-действий является рендеринг соответствующего представления, но здесь нет (и не должно быть) представления соответствующего действию <code>create</code>. Вместо этого мы должны перенаправить на другую страницу и будет вполне логично если этой страницей будет профиль вновь созданного пользователя. Тестирование того что рендерится правильная страница оставлено в качестве упражнения (<a class="ref" href="sign-up#sec:signup_exercises">Раздел&nbsp;7.6</a>); код приложения представлен в <a class="ref" href="sign-up#code:user_create_action">Листинге&nbsp;7.25</a>.</p>

<div class="label" id="code:user_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.25.</span> <span class="description">Действие user <code>create</code> с сохранением и переадресацией. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание на то что мы можем опустить <code>user_path</code> в редиректе, написав просто <code>redirect_to @user</code> для перенаправления на страницу показывающую пользователя.</p>

<p>С кодом в  <a class="ref" href="sign-up#code:user_create_action">Листинге&nbsp;7.25</a> наша регистрационная форма отлично работает, что вы можете проверить запустив набор тестов:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:the_flash"></div>


<h3><a id="sec:7.4.2" href="sign-up#sec:the_flash" class="heading"><span class="number">7.4.2</span> Флэш</a></h3>


<p>Перед отправкой валидной регистрации в браузер, мы собираемся немного отполировать ее, в соответствии с общепринятой в веб приложениях идеей: добавив сообщение, которое временно  появляется, а затем исчезает при перезагрузке страницы. (Если сейчас что-то непонятно, будьте терпеливы; Конкретный пример появится в ближайшее время) Rails-способ сделать это состоит в использовании специальной переменной <em>flash</em>, которая работает как <a   href="http://ru.wikipedia.org/wiki/Флэш-память">флэш-память</a> в том, что она хранит свои данные временно. Переменная <code>flash</code> это на самом деле хэш; и вы можете даже вспомнить консольный пример в <a class="ref" href="rails-flavored-ruby#sec:hashes_and_symbols">Разделе&nbsp;4.3.3</a>, где мы видели, как для перебора хэша использовался стратегически именованный хэш <code>flash</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success:</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">error:</span> <span class="s2">&quot;It failed.&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, error: &quot;It failed.&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">success</span>
<span class="go">It worked!</span>
<span class="go">error</span>
<span class="go">It failed.</span>
</pre></div>
</div>


<p>ы можем организовать отображение содержимого Флэш на веб-узле, включив его в шаблон нашего приложения, как это показно в <a class="ref" href="sign-up#code:layout_flash">Листинге&nbsp;7.26</a>. (Этот код представляет из себя особенно уродливую комбинацию HTML и ERb; упражнение в <a class="ref" href="sign-up#sec:signup_exercises">Разделе&nbsp;7.6</a> показывает как сделать его более красивым.)</p>

<div class="label" id="code:layout_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.26.</span> <span class="description">Добавление содержимого переменной <code>flash</code> в макет шаблона. <br /> <code>app/views/layouts/application.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Код в <a class="ref" href="sign-up#code:layout_flash">Листинге&nbsp;7.26</a> организует вставку каждого флэш элемента в <code>div</code> тег, с CSS классом, указывающим на тип сообщения. Например, если <code>flash[:success] = "Welcome to the Sample App!"</code>, то код</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>произведет такой HTML:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>Welcome to the Sample App!<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>(Обратите внимание, что ключ <code>:success</code> является символом, но встроенный  Ruby автоматически конвертирует его в строку <code>"success"</code> перед вставкой в шаблон.) Причина, по которой мы перебираем все возможные пары ключ/значение заключается в том, что благодаря этому мы сможем включать другие виды флэш сообщений. Например, в <a class="ref" href="sign-in-sign-out#sec:rendering_with_a_flash_message">Разделе&nbsp;8.1.5</a> мы увидим <code>flash[:error]</code> используемое для индикации неудачной попытки входа на сайт.<sup class="footnote" id="fnref:7.11"><a href="#fn:7.11">11</a></sup></p>

<p>Написание теста на правильное флэш сообщение отсавлено в качестве упражнения (<a class="ref" href="sign-up#sec:signup_exercises">Раздел&nbsp;7.6</a>) и мы можем получить прохождение теста назначив <code>flash[:success]</code> приветственное сообщение в действии <code>create</code> как это показано в <a class="ref" href="sign-up#code:signup_flash">Листинге&nbsp;7.27</a>.</p>

<div class="label" id="code:signup_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.27.</span> <span class="description">Добавление флеш сообщения к успешной регистрации пользователя. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:the_first_signup"></div>


<h3><a id="sec:7.4.3" href="sign-up#sec:the_first_signup" class="heading"><span class="number">7.4.3</span> Первая регистрация</a></h3>


<p>Вы можете увидеть результат всей этой работы, зарегистрировав нашего первого пользователя под именем &ldquo;Rails Tutorial&rdquo; и с адресом электронной почты &ldquo;<tt>example@railstutorial.org</tt>&rdquo;. Получившаяся в результате страница (<a class="ref" href="sign-up#fig:signup_flash">Рис.&nbsp;7.20</a>) показывает дружеское сообщение после успешной регистрации, включая приятный зеленый стиль для класса <code>success</code>, который был добавлен CSS фреймворком Bootstrap из <a class="ref" href="filling-in-the-layout#sec:custom_css">Раздела&nbsp;5.1.2</a>. (Если вместо этого вы получили сообщение об ошибке указывающее на то что адрес электронной почты уже занят, убедитесь что вы выполнили <code>db:reset</code> Rake-задачу как это предлагалось сделать в <a class="ref" href="sign-up#sec:signup_form">Разделе&nbsp;7.2</a>.) Затем, после перезагрузки страницы профиля пользователя, флэш сообщение исчезает, как и было обещано (<a class="ref" href="sign-up#fig:signup_flash_reloaded">Рис.&nbsp;7.21</a>).</p>

<div class="label" id="fig:signup_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash_bootstrap.png" alt="signup_flash_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.20: </span><span class="description">Результирующая страница успешной регистрации с флэш сообщением.&nbsp;<a href="http://railstutorial.org/images/figures/signup_flash_bootstrap-full.png">(полный размер)</a></span></div></div>




<div class="label" id="fig:signup_flash_reloaded"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash_reloaded_bootstrap.png" alt="signup_flash_reloaded_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.21: </span><span class="description">Профиль пользователя с исчезнувшим после перезагрузки страницы флэш сообщением.&nbsp;<a href="http://railstutorial.org/images/figures/signup_flash_reloaded_bootstrap-full.png">(полный размер)</a></span></div></div>


<p>Теперь мы можем проверить нашу базу данных просто для того чтобы еще раз убедиться что новый пользователь действительно создан:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Rails Tutorial&quot;, email: &quot;example@railstutorial.org&quot;,</span>
<span class="go">created_at: &quot;2011-12-13 05:51:34&quot;, updated_at: &quot;2011-12-13 05:51:34&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$A58/j7wwh3aAffGkMAO9Q.jjh3jshd.6akhDKtchAz/R...&quot;&gt;</span>
</pre></div>
</div>




<div class="label" id="sec:deploying_to_production_with_ssl"></div>


<h3><a id="sec:7.4.4" href="sign-up#sec:deploying_to_production_with_ssl" class="heading"><span class="number">7.4.4</span> Развертывание приложения на сервере с SSL</a></h3>


<p>Мы разработали модель User и функционал регистрации, пришло время развернуть пример приложения на сервере. (Если вы еще не выполнили шаги из введения к <a class="ref" href="static-pages#top">Главе&nbsp;3</a>, вам следует вернуться и сделать это сейчас.) В рамках развертывания мы добавим <a href="http://ru.wikipedia.org/wiki/SSL">Secure Sockets Layer (SSL)</a><sup class="footnote" id="fnref:7.12"><a href="#fn:7.12">12</a></sup> к продакшен приложению, тем самым обезопасив регистрацию. Поскольку мы будем реализовывать SSL на стороне сервера, пример приложения будет также обезопасен для входа пользователя (<a class="ref" href="sign-in-sign-out#top">Глава&nbsp;8</a>) и также будет устойчив к уязвимости <em>перехвата сессии</em> (<a class="ref" href="sign-in-sign-out#sec:a_working_sign_in_method">Раздел&nbsp;8.2.2</a>).</p>

<p>В качестве подготовки к развертыванию, вам следует объединить ваши изменения <code>master</code> веткой:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish user signup&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-up
</pre></div>
</div>


<p>Для того чтобы задеплоить приложение, нам для начала нужно добавить строку инициирующую использование SSL в продакшен. Получившийся в результате конфигурационный файл продакшен окружения <code>config/environments/production.rb</code> представлен в <a class="ref" href="sign-up#code:ssl_in_production">Листинге&nbsp;7.28</a>.</p>

<div class="label" id="code:ssl_in_production"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.28.</span> <span class="description">Конфигурирование приложения для использования SSL в продакшен. <br /> <code>config/environments/production.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security, </span>
  <span class="c1"># and use secure cookies.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">force_ssl</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для того чтобы получить рабочий продакшен сайт, мы должны закоммитить изменения в конфигурационном файле и отправить результат на Heroku:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -am <span class="s2">&quot;Add SSL in production&quot;</span>
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>Затем нам нужно запустить миграцию на продакшен базе данных для того чтобы сообщить Heroku о модели данных User:<sup class="footnote" id="fnref:7.13"><a href="#fn:7.13">13</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>(Вы можете увидеть deprecation предупреждения в этой точке; просто игнорируйте их.)</p>

<p>Наконец, нам необходимо установить SSL на удаленном сервере. Конфигурирование продакшен сайта для использования SSL это довольно неприятная процедура, кроме всего прочего подразумевающая покупку <em>SSL сертификата</em> для вашего домена. К счастью, для приложений запущенных на домене Heroku (таких как пример приложения), мы можем упасть на хвост SSL сертификату Heroku. Если вы хотите запустить SSL на собсвенном домене, таком как <code>example.com</code>, вам ничего не остается кроме как немного помучиться, о том как это правильно делать вы можете прочитать на <a href="http://devcenter.heroku.com/articles/ssl">Heroku странице о SSL</a>.</p>

<p>Результатом всей этой работы является рабочая форма регистрации на продакшен сервере (<a class="ref" href="sign-up#fig:signup_in_production">Рис.&nbsp;7.22</a>):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div>
</div>


<p>Обратите внимание на <tt>https://</tt> вместо обычного http:// (<a class="ref" href="sign-up#fig:signup_in_production">Рис.&nbsp;7.22</a>). Дополнительная &lsquo;s&rsquo; это указание на то что SSL работает.</p>

<p>Теперь вы можете посетить страницу регистрации и создать нового пользователя. Если возникнут какие-то проблемы, попробуйте выполнить</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div>
</div>


<p>для того чтобы отловить ошибку с помощью логов Heroku.</p>

<div class="label" id="fig:signup_in_production"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_in_production_bootstrap.png" alt="signup_in_production_bootstrap" /></span></div><div class="caption"><span class="header">Рис. 7.22: </span><span class="description">Рабочая страница регистрации в Web.&nbsp;<a href="http://railstutorial.org/images/figures/signup_in_production_bootstrap-full.png">(полный размер)</a></span></div></div>




<h2><a id="sec:7.5" href="sign-up#sec:7.5" class="heading"><span class="number">7.5</span> Заключение</a></h2>


<p>Возможность регистрировать пользователей это важная веха для нашего приложения. Хотя пример приложения до сих пор не делает ничего полезного, мы заложили необходимый фундамент для последующей разработки. В <a class="ref" href="sign-in-sign-out#top">Главе&nbsp;8</a> мы завершим нашу аутентификационную машинерию позволив пользователям входить и выходить из приложения. В <a class="ref" href="updating-showing-and-deleting-users#top">Главе&nbsp;9</a> позволим пользователям обновлять информацию в их учетных записях и позволим администраторам сайта удалять пользователей тем самым завершив полный набор REST действий ресурса Users из <a class="ref" href="sign-up#table:RESTful_users">Таблицы&nbsp;7.1</a>. Наконец, мы добавим методы авторизации к нашим действиям для того чтобы обеспечить безопасность сайта.</p>

<div class="label" id="sec:signup_exercises"></div>


<h2><a id="sec:7.6" href="sign-up#sec:signup_exercises" class="heading"><span class="number">7.6</span> Упражнения</a></h2>




<ol>

<li>Проверьте что код в <a class="ref" href="sign-up#code:gravatar_option">Листинге&nbsp;7.29</a> позволяет хелперу <code>gravatar_for</code>, определенному в <a class="ref" href="sign-up#sec:a_gravatar_image">Разделе&nbsp;7.1.4</a> принимать опциональный параметр <code>size</code>, позволив код вроде <code>gravatar_for user, size: 40</code> в представлении.</li>

<li>Используя код в <a class="ref" href="sign-up#code:password_digest_message_fix">Листинге&nbsp;7.30</a>, замените сообщение об ошибке для отсутствующего пароля &ldquo;Password digest can&rsquo;t be blank&rdquo; на более понятное &ldquo;Password can&rsquo;t be blank&rdquo;. (Здесь используется Rails поддержка интернационализации для реализации этого функционального, но немного грязноватого решения.)</li>

<li>Напишите тесты для сообщений об ошибках реализованных в <a class="ref" href="sign-up#code:f_error_messages">Листинге&nbsp;7.22</a>. Предлагаемое начало, использующее CSS-вдохновленную нотацию, поддерживаемую Capybara, представлено в <a class="ref" href="sign-up#code:error_messages_test">Листинге&nbsp;7.31</a>.</li>

<li>Написав вначале тест или намеренно ломая а затем исправляя код приложенияBy writing the test first or by intentionally breaking and then fixing the application code, проверьте что тесты в <a class="ref" href="sign-up#code:after_save_tests">Листинге&nbsp;7.32</a> правильно описывают поведение после сохранения пользователя в действии <code>create</code>.</li>

<li>Как было отмечено ранее, HTML флэша в <a class="ref" href="sign-up#code:layout_flash">Листинге&nbsp;7.26</a> уродлив. Проверьте, запустив набор тестов, что очищенный код в <a class="ref" href="sign-up#code:layout_flash_content_tag">Листинге&nbsp;7.33</a>, использующий Rails хелпер <code>content_tag</code>, тоже работает.</li>
</ol>




<div class="label" id="code:gravatar_option"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.29.</span> <span class="description">Определение необязательного параметра <code>:size</code> для хелпера <code>gravatar_for</code>. <br /> <code>app/helpers/users_helper.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Возвращает Gravatar (http://gravatar.com/) для данного пользователя.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">size:</span> <span class="mi">50</span> <span class="p">})</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;http://gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">.png?s=</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:password_digest_message_fix"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.30.</span> <span class="description">Хак улучшающий сообщение об ошибке для отсутствующего пароля. <br /> <code>config/locales/en.yml</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">en</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">activerecord</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="s">&quot;Password&quot;</span>
</pre></div>
</div></div>




<div class="label" id="code:error_messages_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.31.</span> <span class="description">Рекомендуемые тесты для сообщений об ошибках. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;error messages&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div></div>




<div class="label" id="code:after_save_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.32.</span> <span class="description">Тесты описывающие поведение после сохранения в действии <code>create</code>. <br /> <code>spec/requests/user_pages_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre>    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s1">&#39;user@example.com&#39;</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-success&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Welcome&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div></div>




<div class="label" id="code:layout_flash_content_tag"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 7.33.</span> <span class="description">ERb для <code>flash</code> в шаблоне сайта использующий <code>content_tag</code>. <br /> <code>app/views/layouts/application.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;alert alert-</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<div class="navigation">  <a class="prev_page" href="modeling-users#top">
    &laquo;&nbsp;<span class="number">Глава 6</span> Моделирование пользователей
  </a>
  <a class="next_page" href="sign-in-sign-out#top">
    <span class="number">Глава 8</span> Войти, выйти&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:7.1"><a href="http://gomockingbird.com/">Mockingbird</a> не поддерживает кастомные изображения вроде фото на <a class="ref" href="sign-up#fig:profile_mockup_profile_name">Рис.&nbsp;7.1</a>; я добавил его вручную с помощью <a href="http://www.adobe.com/products/fireworks/">Adobe Fireworks</a>. &nbsp;<a class="arrow" href="#fnref:7.1">&uarr;</a></li>
<li id="fn:7.2">Гиппопотам был взят с <a href="http://www.flickr.com/photos/43803060@N00/24308857/">http://www.flickr.com/photos/43803060@N00/24308857/</a>.&nbsp;<a class="arrow" href="#fnref:7.2">&uarr;</a></li>
<li id="fn:7.3">Rails <code>debug</code> информация показана как <a href="http://www.yaml.org/">YAML</a> (a <a href="http://catb.org/jargon/html/R/recursive-acronym.html">recursive acronym</a> (или <a href="http://ru.wikipedia.org/wiki/Рекурсивный_акроним">рекурсивный акроним)</a>)  обозначающий &ldquo;<a href="http://ru.wikipedia.org/wiki/YAML">YAML</a> Ain&rsquo;t Markup Language&rdquo;), который является дружественным форматом данных, разработанным так, чтобы быть удобочитаемым и для машин и для людей.&nbsp;<a class="arrow" href="#fnref:7.3">&uarr;</a></li>
<li id="fn:7.4">Вы также можете определять собственные окружения; см. <a href="http://railscasts.com/episodes/72-adding-an-environment">RailsCast on adding an environment</a>.&nbsp;<a class="arrow" href="#fnref:7.4">&uarr;</a></li>
<li id="fn:7.5">Это означает что <em>маршрутизация</em> работает, но соответствующие страницы необязательно должны работать в этой точке. Например, /users/1/edit правильно направляется к <code>edit</code> действию контроллера Users, но поскольку действие <code>edit</code> пока не существует, обращение к этому URI вернет ошибку.&nbsp;<a class="arrow" href="#fnref:7.5">&uarr;</a></li>
<li id="fn:7.6">Предположительно &ldquo;Factory Girl&rdquo; является ссылкой на <a href="http://www.imdb.com/title/tt0432402/">фильм с таким же названием</a>.&nbsp;<a class="arrow" href="#fnref:7.6">&uarr;</a></li>
<li id="fn:7.7">В индуизме, аватар это форма проявление божества в человеке или животном. В более широком смысле термин <em>avatar</em> обычно используется для обозначения  персонализации пользователя, особенно в виртуальной среде. Но вы уже видели <a href="http://www.imdb.com/title/tt0499549/">фильм</a>, и почти наверняка знаете об этом.&nbsp;<a class="arrow" href="#fnref:7.7">&uarr;</a></li>
<li id="fn:7.8">Если вашему приложению потребуется обработка кастомных изображений или загрузки других файлов, я рекомендую использовать для этих целей гем <a href="http://github.com/thoughtbot/paperclip">Paperclip</a>.&nbsp;<a class="arrow" href="#fnref:7.8">&uarr;</a></li>
<li id="fn:7.9">Странно, не правда ли? Я тоже этого не понимаю.&nbsp;<a class="arrow" href="#fnref:7.9">&uarr;</a></li>
<li id="fn:7.10">Я выяснил это путем поиска <code>pluralize</code> в <a href="http://api.rubyonrails.org/v3.2.0/classes/ActionView/Helpers/TextHelper.html#method-i-pluralize">Rails API</a>.&nbsp;<a class="arrow" href="#fnref:7.10">&uarr;</a></li>
<li id="fn:7.11">На самом деле мы будем использовать тесно связанный <code>flash.now</code>, но мы отложим эти тонкости до тех пор пока они нам не понадобятся.&nbsp;<a class="arrow" href="#fnref:7.11">&uarr;</a></li>
<li id="fn:7.12">Технически, SSL это теперь TLS, от Transport Layer Security, но все кого я знаю по-прежнему говорят &ldquo;SSL&rdquo;.&nbsp;<a class="arrow" href="#fnref:7.12">&uarr;</a></li>
<li id="fn:7.13">Читателей планирующих использовать  Heroku для реальных (не учебных) приложений может заинтересовать <a href="https://github.com/thoughtbot/kumade#">Kumade</a>, который обрабатывает вещи вроде миграции базы данных автоматически.&nbsp;<a class="arrow" href="#fnref:7.13">&uarr;</a></li>
</ol>
</div>
