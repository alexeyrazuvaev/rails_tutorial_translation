<div id="top"></div>


<h1 class="chapter"><a id="sec:8" href="sign-up?version=3.0#top" class="heading"><span class="number">Глава 8</span> Регистрация</a></h1>


<p>Теперь у нас есть рабочая модель User, пришло время добавить возможность без которой некоторые сайты просто жить не могут: позволить пользователям регистрироваться на сайте; таким образом выполнив обещание подразумевавшееся в <a class="ref" href="filling-in-the-layout?version=3.0#sec:user_signup">Разделе&nbsp;5.3</a>, &ldquo;Регистрация пользователей: Первый шаг&rdquo;. Мы будем использовать HTML <em>форму</em> для предоставления пользователями регистрационной информации нашему приложению в <a class="ref" href="sign-up?version=3.0#sec:signup_form">Разделе&nbsp;8.1</a>, которая затем будет использована для создания нового пользователя и сохранения его атрибутов в базе данных в <a class="ref" href="sign-up?version=3.0#sec:signup_success">Разделе&nbsp;8.3</a>. Как обычно, мы будем писать тесты по мере разработки и в <a class="ref" href="sign-up?version=3.0#sec:rspec_integration_tests">Разделе&nbsp;8.4</a> мы будем использовать поддержку RSpec синтаксиса веб навигации для написания кратких и выразительных интеграционных тестов.</p>

<p>Так как мы будем создавать новых пользователей в этой главе, вы можете сбросить базу данных, чтобы удалить всех пользователей, созданных в консоли (например, в <a class="ref" href="modeling-and-viewing-users-two?version=3.0#sec:a_name_and_a_gravatar">Разделе&nbsp;7.3.2</a>), чтобы ваши результаты соответствовали тому, что показано в учебнике. вы можете сделать это следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
</pre></div>
</div>


<p>Если вы используете управление версиями, создайте тему ветки, как обычно: </p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b signing-up
</pre></div>
</div>


<div class="label" id="sec:signup_form"></div>


<h2><a id="sec:8.1" href="sign-up?version=3.0#sec:signup_form" class="heading"><span class="number">8.1</span> Регистрационная форма</a></h2>


<p>Напомним из <a class="ref" href="filling-in-the-layout?version=3.0#sec:users_controller">Раздела&nbsp;5.3.1</a> что у нас уже есть тесты для new users (signup) страницы, первоначально рассматривавшиеся в <a class="ref" href="filling-in-the-layout?version=3.0#code:signup_title_test">Листинге&nbsp;5.26</a> и воспроизведенные в <a class="ref" href="sign-up?version=3.0#code:new_users_tests">Листинге&nbsp;8.1</a>.  (Как и было обещано в <a class="ref" href="modeling-and-viewing-users-two?version=3.0#sec:tests_with_factories">Разделе&nbsp;7.3.1</a>, мы переключились с <code>get &rsquo;new&rsquo;</code> на <code>get :new</code> потому что это то, что мои пальцы хотят печатать.) Кроме того, мы видели в <a class="ref" href="filling-in-the-layout?version=3.0#fig:blank_signup_page">Рис.&nbsp;5.10</a> (еще раз показано в <a class="ref" href="sign-up?version=3.0#fig:blank_signup_page_recap">Рис.&nbsp;8.1</a>) что эта страница регистрации в настоящее время чиста: совершенно бесполезна для регистрации новых пользователей. Цель этого раздела - положить начало исправлению этого печального положения дел, сделав форму регистрации, макет которой показан в <a class="ref" href="sign-up?version=3.0#fig:signup_mockup">Рис.&nbsp;8.2</a>.</p>

<div class="label" id="code:new_users_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.1.</span> <span class="description">Тесты для страницы new users (впервые показанные в <a class="ref" href="filling-in-the-layout?version=3.0#code:signup_title_test">Листинг&nbsp;5.26</a>). <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;GET &#39;new&#39;&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:new</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:new</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sign up&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:blank_signup_page_recap"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/blank_signup_page.png" alt="blank_signup_page" /></span></div><div class="caption"><span class="header">Рисунок  8.1: </span><span class="description">Страница регистрации на данный момент  <a href="http://localhost:3000/signup"><tt>/signup</tt></a>.&nbsp;<a href="http://railstutorial.org/images/figures/blank_signup_page-full.png">(полный размер)</a></span></div></div>




<div class="label" id="fig:signup_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_mockup.png" alt="signup_mockup" /></span></div><div class="caption"><span class="header">Рисунок  8.2: </span><span class="description">Макет страницы для регистрации пользователей.&nbsp;<a href="http://railstutorial.org/images/figures/signup_mockup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:using_form_for"></div>


<h3><a id="sec:8.1.1" href="sign-up?version=3.0#sec:using_form_for" class="heading"><span class="number">8.1.1</span> Использование <code>form_for</code></a></h3>


<p>Элемент HTML, необходимый для предоставления информации на удаленный сайт, это <em>форма</em>, что предполагает хороший первый шаг к регистрации пользователей - создание формы для приема регистрационной информации. Мы можем сделать это в Rails с помощью вспомогательного метода <code>form_for</code>; результат представлен в <a class="ref" href="sign-up?version=3.0#code:new_user_form">Листинге&nbsp;8.2</a>. (Читатели, знакомые с Rails&nbsp;2.x должны отметить, что <code>form_for</code> теперь использует &ldquo;процент-равно&rdquo; ERb синтаксис для вставки контента; то есть, где Rails&nbsp;2.x использовал <tt class="verb">&lt;% form_for ... %&gt;</tt>, Rails&nbsp;3 использует <tt class="verb">&lt;%= form_for ... %&gt;</tt>.)</p>

<div class="label" id="code:new_user_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.2.</span> <span class="description">Форма для регистрации новых пользователей. <br /> <code>app/views/users/new.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Sign up&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Давайте рассмотрим по частям. Наличие ключевого слова <code>do</code> указывает, что <code>form_for</code> принимает блок (<a class="ref" href="rails-flavored-ruby?version=3.0#sec:blocks">Раздел&nbsp;4.3.2</a>), который имеет одну переменную, которую мы назвали <code>f</code> от &ldquo;form&rdquo;. Внутри <code>form_for</code> хелпера, <code>f</code> это объект, который представляет форму; как это обычно бывает с Rails хелперами, нам не нужно знать деталей реализации, но нам <em>нужно</em> знать что делает объект <code>f</code>: при вызове с методом, соответствующим <a href="http://www.w3schools.com/html/html_forms.asp">HTML элементу form</a>&nbsp;&mdash;&nbsp;таким как  текстовое поле, радио кнопки, или поле пароля, он возвращает код для этого элемента, специально разработанный для установки атрибута объекта <code>@user</code>. Другими словами,</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>создает HTML, необходимый, чтобы сделать маркированный элемент текстового поля, подходящий для установки <code>name</code> атрибута модели User.</p>

<p>Чтобы увидеть это в действии, нам нужно добыть и посмотреть на реальный HTML производимый с помощью этой формы, но здесь у нас есть проблема: сейчас страница неисправна, потому что мы не установили переменную <code>@user</code>, как и все неопределенные переменные экземпляра (<a class="ref" href="rails-flavored-ruby?version=3.0#sec:objects_and_message_passing">Раздел&nbsp;4.2.3</a>), <code>@user</code> в настоящее время равна <code>nil</code>. Соответственно, если вы сейчас запустите свой набор тестов, вы увидите, что тесты страницы регистрации не проходят. Чтобы заставить их пройти и получить визуализацию нашей формы, мы должны определить переменную <code>@user</code> в действии контроллера, соответствующего <code>new.html.erb</code>, т.е., в <code>new</code> действии контроллера Users. Хелпер <code>form_for</code> ожидает, что <code>@user</code> будет объектом User, а так как мы создаем <em>нового</em> пользователя, мы просто используем <code>User.new</code>, как видно в <a class="ref" href="sign-up?version=3.0#code:new_action_with_user">Листинге&nbsp;8.3</a>.</p>

<div class="label" id="code:new_action_with_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.3.</span> <span class="description">Добавление <code>@user</code> переменной в <code>new</code> действие. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Sign up&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>С определенной <code>@user</code> переменной, тесты вновь должны проходить,<sup class="footnote" id="fnref:8.1"><a href="?version=3.0#fn:8.1">1</a></sup> и теперь форма (чуть-чуть отстиленная <a class="ref" href="sign-up?version=3.0#code:form_css">Листингом&nbsp;8.4</a>) представлена на <a class="ref" href="sign-up?version=3.0#fig:signup_form">Рис.&nbsp;8.3</a>.</p>

<div class="label" id="code:form_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.4.</span> <span class="description"> <a href="http://www.youtube.com/watch?v=MlfcF1I5e_g">Капелька</a> CSS для формы регистрации. <br /> <code>public/stylesheets/custom.css</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="nt">div</span><span class="nc">.field</span><span class="o">,</span> <span class="nt">div</span><span class="nc">.actions</span> <span class="p">{</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:signup_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_form.png" alt="signup_form" /></span></div><div class="caption"><span class="header">Рисунок  8.3: </span><span class="description">Регистрационная форма  <a href="http://localhost:3000/signup"><tt>/signup</tt></a> для новых пользователей.&nbsp;<a href="http://railstutorial.org/images/figures/signup_form-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:the_form_html"></div>


<h3><a id="sec:8.1.2" href="sign-up?version=3.0#sec:the_form_html" class="heading"><span class="number">8.1.2</span> HTML формы</a></h3>


<p>Как видно на <a class="ref" href="sign-up?version=3.0#fig:signup_form">Рис.&nbsp;8.3</a>, страница регистрации теперь правильно отображается, указывая на то, что <code>form_for</code> код в <a class="ref" href="sign-up?version=3.0#code:new_user_form">Листинге&nbsp;8.2</a> производит валидный HTML. Если вы посмотрите на HTML генерируемый формой (используя <a href="http://getfirebug.com/">Firebug</a> или опцию &ldquo;Исходный код страницы&rdquo;  вашего браузера), вы должны увидеть разметку как в <a class="ref" href="sign-up?version=3.0#code:signup_form_html">Листинге&nbsp;8.5</a>. Хотя многие детали не имеют значения для наших целей, давайте уделим минуту, чтобы осветить наиболее важные части ее структуры.</p>

<div class="label" id="code:signup_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.5.</span> <span class="description">HTML формы из <a class="ref" href="sign-up?version=3.0#fig:signup_form">Рис.&nbsp;8.3</a>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;margin:0;padding:0;display:inline&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;authenticity_token&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span>
       <span class="na">value=</span><span class="s">&quot;rB82sI7Qw5J9J1UMILG/VQL411vH5putR+JwlxLScMQ=&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password_confirmation&quot;</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password_confirmation&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password_confirmation]&quot;</span>
           <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_submit&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Sign up&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>Мы начнем с внутренней структуры. Сравнивая <a class="ref" href="sign-up?version=3.0#code:new_user_form">Листинг&nbsp;8.2</a> с <a class="ref" href="sign-up?version=3.0#code:signup_form_html">Листингом&nbsp;8.5</a>, мы видим, что Embedded Ruby</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>производит HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>и</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>производит HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Как видно в <a class="ref" href="sign-up?version=3.0#fig:filled_in_form">Рис.&nbsp;8.4</a>, текстовые поля (<code>type="text"</code>) просто отображает их содержимое, в то время как поле пароля (<code>type="password"</code>) скрывает ввод в целях безопасности, как показано на <a class="ref" href="sign-up?version=3.0#fig:filled_in_form">Рис.&nbsp;8.4</a>.</p>

<div class="label" id="fig:filled_in_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/filled_in_form.png" alt="filled_in_form" /></span></div><div class="caption"><span class="header">Рисунок  8.4: </span><span class="description">Заполненная форма, показывающая разницу между <code>text</code> и <code>password</code> полями.&nbsp;<a href="http://railstutorial.org/images/figures/filled_in_form-full.png">(полный размер)</a></span></div></div>


<p>Как мы увидим в <a class="ref" href="sign-up?version=3.0#sec:signup_success">Разделе&nbsp;8.3</a>, ключ к созданию пользователя это специальный атрибут <code>name</code> в каждом <code>input</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Эти значения <code>name</code> позволяют Rails построить хэш инициализации (через переменную <code>params</code> впервые показанную в <a class="ref" href="modeling-and-viewing-users-one?version=3.0#sec:users_show">Разделе&nbsp;6.3.2</a>) для создания пользователей, используя значения, введенные пользователями, как мы увидим в <a class="ref" href="sign-up?version=3.0#sec:signup_failure">Разделе&nbsp;8.2</a>.</p>

<p>Вторым важным элементом является сам тег <code>form</code>. Rails создает <code>form</code> тег используя объект <code>@user</code>: потому что каждый объект Ruby знает свой собственный класс (<a class="ref" href="rails-flavored-ruby?version=3.0#sec:constructors">Раздел&nbsp;4.4.1</a>), Rails выводит, что <code>@user</code> принадлежит классу <code>User</code>; причем, так как <code>@user</code> это <em>новый</em> пользователь, Rails знает, что нужно построить форму с <code>post</code> методом, который является надлежащим глаголом для создания нового объекта (<a class="ref" href="static-pages?version=3.0#sidebar:get_etc">Box&nbsp;3.1</a>):</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>Здесь атрибуты <code>class</code> и <code>id</code> не играют большой роли; куда более важны <code>action="/users"</code> и <code>method="post"</code>. Вместе они составляют инструкцию выдавать HTTP запрос <tt>POST</tt> к <tt>/users</tt> URL. Мы увидим в ближайших двух разделах какие это имеет последствия.</p>

<p>Наконец, отметим, весьма туманный код для &ldquo;authenticity token&rdquo;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;margin:0;padding:0;display:inline&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;authenticity_token&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span>
       <span class="na">value=</span><span class="s">&quot;rB82sI7Qw5J9J1UMILG/VQL411vH5putR+JwlxLScMQ=&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Здесь Rails использует специальное уникальное значение, чтобы помешать конкретному виду межсайтовой скриптовой атаки, называемой <em>forgery</em> (подделка); см. <a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token">the Stack Overflow entry on the Rails authenticity token</a> если вам интересны детали того, как это работает и почему это важно. К счастью, Rails позаботился о проблеме за вас, и input тег  <code>hidden</code> (скрытый), так что вы не должны дважды думать о нем, но его видно, когда вы смотрите исходный код формы, поэтому я хотел по крайней мере упомянуть об этом.</p>

<div class="label" id="sec:signup_failure"></div>


<h2><a id="sec:8.2" href="sign-up?version=3.0#sec:signup_failure" class="heading"><span class="number">8.2</span> Сбой регистрации</a></h2>


<p>Хотя мы кратко рассмотрели HTML формы, показанной в <a class="ref" href="sign-up?version=3.0#fig:signup_form">Рис.&nbsp;8.3</a> (<a class="ref" href="sign-up?version=3.0#code:signup_form_html">Листинг&nbsp;8.5</a>), он (HTML) лучше всего понимается в контексте <em>сбоя регистрации</em>. Просто получить регистрационную форму, которая принимает недействительные данные и вновь показывает страницу регистрации (как на макете в <a class="ref" href="sign-up?version=3.0#fig:signup_failure_mockup">Рис.&nbsp;8.5</a>) является значительным достижением, и это будет целью данного раздела.</p>

<div class="label" id="fig:signup_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_mockup.png" alt="signup_failure_mockup" /></span></div><div class="caption"><span class="header">Рисунок  8.5: </span><span class="description">Макет страницы неудавшейся регистрации.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_mockup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:testing_failure"></div>


<h3><a id="sec:8.2.1" href="sign-up?version=3.0#sec:testing_failure" class="heading"><span class="number">8.2.1</span> Тестирование сбоя</a></h3>


<p>Напомним, из <a class="ref" href="modeling-and-viewing-users-one?version=3.0#sec:a_users_resource">Раздела&nbsp;6.3.3</a> что добавление <code>resources :users</code> в файл <code>routes.rb</code> (<a class="ref" href="modeling-and-viewing-users-one?version=3.0#code:users_resource">Листинг&nbsp;6.26</a>) автоматически гарантирует, что наше Rails приложение отвечает на RESTful URL из <a class="ref" href="modeling-and-viewing-users-one?version=3.0#table:RESTful_users">Таблицы&nbsp;6.2</a>. В частности, это гарантирует, что <tt>POST</tt> запрос в <tt>/users</tt> обрабатывается <code>create</code> действием. Нашей стратегией для <code>create</code> действия будет использование формы регистрации, для создания нового объекта пользователь, используя <code>User.new</code>, попробовать (безуспешно) сохранить этого пользователя, а затем сделать страницу регистрации для возможной повторной попытки. Наша задача заключается в написании тестов для этого действия, а затем добавлении <code>create</code> в контроллер Users, чтобы заставить тесты пройти.</p>

<p>Давайте начнем с обзора кода для формы регистрации:</p>



<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>Как отмечено в <a class="ref" href="sign-up?version=3.0#sec:the_form_html">Разделе&nbsp;8.1.2</a>, этот HTML выдает <tt>POST</tt> запрос к <tt>/users</tt> URL. По аналогии с методом <code>get</code>, который выдает <tt>GET</tt> запрос внутри теста, мы используем метод <code>post</code> чтобы выдать запрос <tt>POST</tt> к <code>create</code> действию. Как мы вскоре увидим, <code>create</code> принимает хэш соответствующий типу создаваемого объекта; так как это тест для <em>сбоя</em> регистрации, мы просто передадим хэш <code>@attr</code> с пустыми записями, как показано в <a class="ref" href="sign-up?version=3.0#code:failing_create_specs">Листинге&nbsp;8.6</a>. Это по сути эквивалентно посещению страницы регистрации и нажатии на кнопку с любым незаполненным полем.</p>

<div class="label" id="code:failing_create_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.6.</span> <span class="description">Тест для сбоя регистрации пользователя. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>

  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should not create a user&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sign up&quot;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the &#39;new&#39; page&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Последние два теста относительно просты: мы убеждаемся, что заголовок правильный, а потом проверяем, что не удавшаяся попытка регистрации просто повторно показывает new user страницу (используя RSpec метод <code>render_template</code>). Первый тест немного более сложен.</p>

<p>Целью теста</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should not create a user&quot;</span> <span class="k">do</span>
  <span class="nb">lambda</span> <span class="k">do</span>
    <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
  <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>является проверка того, что провальное <code>create</code> действие не создает пользователя в базе данных. Для этого он вводит два новых элемента. Во-первых, мы используем RSpec метод <code>change</code> чтобы вернуть изменение количества пользователей в базе данных:</p>

<div class="code"><div class="highlight"><pre><span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>Это откладывает Active Record <code>count</code> (количество) метод, который просто возвращает количество записей данного типа, находящихся в базе данных. Например, если вы очистили development database базу данных в начале главы, это количество сейчас должно быть&nbsp;<code>0</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>Вторая новая идея, это сворачивание <code>post :create</code> шага в package (пакет), используя Ruby конструкцию называемую <code>lambda</code>,<sup class="footnote" id="fnref:8.2"><a href="?version=3.0#fn:8.2">2</a></sup> которая позволяет нам проверить что он не меняет количество <code>User</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span>
  <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
<span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>Хотя эта <code>lambda</code> в данный момент может показаться странной, в следующих тестах будет много примеров и картина быстро прояснится.</p>

<div class="label" id="sec:a_working_form"></div>


<h3><a id="sec:8.2.2" href="sign-up?version=3.0#sec:a_working_form" class="heading"><span class="number">8.2.2</span> Работающая форма</a></h3>


<p>Мы можем получить прохождение тестов из <a class="ref" href="sign-up?version=3.0#sec:testing_failure">Раздела&nbsp;8.2.1</a> с кодом из <a class="ref" href="sign-up?version=3.0#code:first_create_action">Листинга&nbsp;8.7</a>. Этот листинг включает в себя второй вариант использования <code>render</code> метода, который мы впервые увидели в контексте партиалов (частичных шаблонов) (<a class="ref" href="filling-in-the-layout?version=3.0#sec:partials">Раздел&nbsp;5.1.3</a>); как вы можете видеть, <code>render</code> также работает в контроллере действий. Обратите внимание, что мы воспользовались этой возможностью, чтобы представить <code>if</code>-<code>else</code> ветвящиеся структуры, которые позволяют нам обрабатывать случаи сбоя и успеха раздельно, в зависимости от значения <code>@user.save</code>.</p>

<div class="label" id="code:first_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.7.</span> <span class="description"><code>create</code> действие которое может обрабатывать сбой регистрации (но не успех). <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Обработка успешного сохранения.</span>
    <span class="k">else</span>
      <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Sign up&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Лучший способ понять, как работает код в <a class="ref" href="sign-up?version=3.0#code:first_create_action">Листинге&nbsp;8.7</a> это <em>отправить</em> форму с некоторыми недействительной регистрационными данными; результаты представлены в <a class="ref" href="sign-up?version=3.0#fig:signup_failure_rails_3">Рис.&nbsp;8.6</a>.</p>

<div class="label" id="fig:signup_failure_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_rails_3.png" alt="signup_failure_rails_3" /></span></div><div class="caption"><span class="header">Рисунок  8.6: </span><span class="description">Сбой регистрации с хэшем <code>params</code>&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_rails_3-full.png">(полный размер)</a></span></div></div>


<p>Чтобы получить более четкую картину того, как Rails обрабатывает предоставление регистрационных данных, давайте ближе познакомимся с хэшем <code>params</code> в отладочной информации, отображаемой в нижней части страницы <a class="ref" href="sign-up?version=3.0#fig:signup_failure_rails_3">Рис.&nbsp;8.6</a>:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span> <span class="kt">!map</span><span class="l-Scalar-Plain">:ActiveSupport::HashWithIndifferentAccess</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sign up</span>
<span class="l-Scalar-Plain">authenticity_token</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rB82sI7Qw5J9J1UMILG/VQL411vH5puR+Jw1xL5cMQ=</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="kt">!map</span><span class="l-Scalar-Plain">:ActiveSupport::HashWithIndifferentAccess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Foo Bar</span>
  <span class="l-Scalar-Plain">password_confirmation</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dude</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dude</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo@invalid</span>
</pre></div>
</div>


<p>Мы видели, начиная с <a class="ref" href="modeling-and-viewing-users-one?version=3.0#sec:users_show">Раздела&nbsp;6.3.2</a> что хэш <code>params</code> содержит информацию о каждом запросе; в случае URL типа <tt>/users/1</tt>, значение <code>params[:id]</code> это <code>id</code> соответствующего пользователя (<code>1</code>&nbsp;в этом примере). В случае отправки регистрационной формы, <code>params</code> вместо этого содержит хэш хэшей, конструкцию, которую мы впервые видели в <a class="ref" href="rails-flavored-ruby?version=3.0#sec:hashes_and_symbols">Разделе&nbsp;4.3.3</a>, который представил стратегически названную <code>params</code> переменную в консольной сессии. Эта отладочная информация показывает, что предоставление (отправка) формы дает в результате <code>user</code> хэш с атрибутами, соответствующими предоставленным значениям, где ключи происходят от <code>name</code> атрибутов тега <code>input</code> который мы видели в <a class="ref" href="sign-up?version=3.0#code:new_user_form">Листинге&nbsp;8.2</a>; например, значение</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>с именем <code>"user[email]"</code> это именно <code>email</code> атрибут хэша <code>user</code>.</p>

<p>Хотя хэш-ключи отображаются как строки в отладочном выводе, внутренне Rails использует символы, так что <code>params[:user]</code> на самом деле является хэшем атрибутов пользователей, именно атрибутов, необходимых в качестве аргумента <code>User.new</code>, как мы впервые видели в <a class="ref" href="rails-flavored-ruby?version=3.0#sec:a_user_class">Разделе&nbsp;4.4.5</a> и как представлено в <a class="ref" href="sign-up?version=3.0#code:first_create_action">Листинг&nbsp;8.7</a>. Это означает, что строка</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>эквивалентна</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
                 <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>А это именно тот формат который необходим для инициализации объекта модели User с заданными атрибутами.</p>

<p>Конечно, такой экземпляр переменной имеет значение для успешной регистрации, как мы увидим в <a class="ref" href="sign-up?version=3.0#sec:signup_success">Разделе&nbsp;8.3</a>, как только <code>@user</code> правильно определена, вызов <code>@user.save</code> это все, что необходимо для завершения регистрации&mdash;но это имеет свои последствия даже в случае сбоя регистрации, рассматриваемого здесь. Обратите внимание на <a class="ref" href="sign-up?version=3.0#fig:signup_failure_rails_3">Рис.&nbsp;8.6</a> что поля уже <em>заполнены</em> данными из провальной отправки. Это происходит потому что <code>form_for</code> автоматически заполняет поля атрибутами объекта <code>@user</code>, так что, например, если <code>@user.name</code> это <code>"Foo"</code> то</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>будет производить HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;Foo&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>Здесь <code>value</code> тега <code>input</code> это <code>"Foo"</code>, что и появляется в текстовом поле.</p>

<div class="label" id="sec:signup_error_messages"></div>


<h3><a id="sec:8.2.3" href="sign-up?version=3.0#sec:signup_error_messages" class="heading"><span class="number">8.2.3</span> Сообщения об ошибках при регистрации</a></h3>

<p>Хотя это и не является строго обязательным, все же полезно выводить сообщения об ошибках при сбое регистрации, чтобы указать на проблемы, которые помешали успешной регистрации пользователя. Rails предоставляет именно такие сообщения, основанные на валидациях модели User. Рассмотрим, например, попытку сохранения пользователя с неправильным адресом электронной почты и коротким паролем:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Email is invalid&quot;, &quot;Password is too short (minimum is 6 characters)&quot;]</span>
</pre></div>
</div>


<p>Здесь объект <code>errors.full_messages</code> (который мы видели кратко в <a class="ref" href="modeling-and-viewing-users-one?version=3.0#sec:presence_validation">Разделе&nbsp;6.2.1</a>) содержит массив сообщений об ошибках.</p>

<p>Как и в консольной сессии выше, сбой сохранения в <a class="ref" href="sign-up?version=3.0#code:first_create_action">Листинге&nbsp;8.7</a> генерирует список сообщений об ошибках, связанных с объектом <code>@user</code>. Для отображения сообщения в браузер, мы <code>render</code> партиал error_messages в user <code>new</code> страницу (<a class="ref" href="sign-up?version=3.0#code:f_error_messages">Листинг&nbsp;8.8</a>).<sup class="footnote" id="fnref:8.3"><a href="?version=3.0#fn:8.3">3</a></sup></p>

<div class="label" id="code:f_error_messages"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.8.</span> <span class="description">Код для отображения сообщений об ошибках в форме регистрации. <br /> <code>app/views/users/new.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Заметим здесь, что мы <code>render</code> партиал <code>&rsquo;shared/error_messages&rsquo;</code>; что отражает общую конвенцию Rails, которая помещает частичные шаблоны, которые мы планируем использовать во многих контроллерах, в специально отведенный каталог <code>shared/</code>. (Мы увидим что эти планы реализованы в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#sec:edit_form">Разделе&nbsp;10.1.1</a>.) Это означает, что мы должны создать этот новый каталог вместе с файлом партиала <code>_error_messages.html.erb</code>. Сам партиал представлен в <a class="ref" href="sign-up?version=3.0#code:errors_partial">Листинге&nbsp;8.9</a>.</p>

<div class="label" id="code:errors_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.9.</span> <span class="description">Партиал для отображения сообщений об ошибках на форме регистрации. <br /> <code>app/views/shared/_error_messages.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
        prohibited this user from being saved:<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>There were problems with the following fields:<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Этот частичный шаблон вводит несколько новых Rails и Ruby конструкций, в том числе два метода для объектов класса <code>Array</code>. Давайте откроем сеанс консоли, чтобы увидеть, как они работают. Первый метод это <code>count</code>, который просто возвращает количество элементов в объекте:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 3</span>
</pre></div>
</div>


<p>Другой новый метод <code>any?</code>, один из пары дополнительных методов:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[].</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="o">[].</span><span class="n">any?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">any?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Мы видим здесь, что <code>empty?</code> метод, который мы впервые увидели в <a class="ref" href="rails-flavored-ruby?version=3.0#sec:objects_and_message_passing">Разделе&nbsp;4.2.3</a> в контексте строк, также работает с массивами, возвращая <code>true</code> для пустого массива и <code>false</code> в противном случае. Метод <code>any?</code> это просто противоположность <code>empty?</code>, он возвращает <code>true</code> если в массиве есть какие-нибудь элементы и <code>false</code> в противном случае.</p>

<p>Другая новая идея это <code>pluralize</code> текст хелпер. Он не доступен в консоли, но мы можем включить его явно через модуль <code>ActionView::Helpers::TextHelper</code>:<sup class="footnote" id="fnref:8.4"><a href="?version=3.0#fn:8.4">4</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">include</span> <span class="ss">ActionView::Helpers</span><span class="o">::</span><span class="no">TextHelper</span>
<span class="go">=&gt; Object </span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1 error&quot; </span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;5 errors&quot;</span>
</pre></div>
</div>


<p>Мы видим здесь, что <code>pluralize</code> принимает целочисленный аргумент и возвращает число с правильной версией множественного числа его второго аргумента. В основе этого метода лежит мощный <em>инфлектор</em>, который знает как преобразовать во множественное число огромное количество слов (в том числе, многие с неправильным множественным числом):</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;woman&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;2 women&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;erratum&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;3 errata&quot;</span>
</pre></div>
</div>


<p>В результате, код</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>возвращает <code>"1 error"</code> или <code>"2 errors"</code> (и т.д.) в зависимости от количества ошибок.</p>

<p>Обратите внимание, что <a class="ref" href="sign-up?version=3.0#code:errors_partial">Листинг&nbsp;8.9</a> включает CSS&nbsp;id <code>error_explanation</code> для использования в отстиливании сообщения об ошибках. (Напомним, из <a class="ref" href="filling-in-the-layout?version=3.0#sec:custom_css">Раздела&nbsp;5.1.2</a> что CSS использует знак решетки <code>#</code> для стилизации id.) Кроме того, Rails автоматически помещает поля с ошибками в <code>div</code>ы с CSS классом <code>field_with_errors</code>. Эти метки затем позволят нам отредактироваь стиль сообщений об ошибках с CSS показанным в <a class="ref" href="sign-up?version=3.0#code:error_messages_css">Листинге&nbsp;8.10</a>. Результат сбоя регистрации с сообщениями об ошибке представлен в <a class="ref" href="sign-up?version=3.0#fig:signup_error_messages">Рис.&nbsp;8.7</a>. Поскольку сообщения генерируются валидациями модели, они автоматически изменятся, если вы когда-нибудь поменяете свое мнение о, скажем, формате адресов электронной почты, или минимальной длине паролей.</p>

<div class="label" id="code:error_messages_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.10.</span> <span class="description">CSS для оформления сообщений об ошибках. <br /> <code>public/stylesheets/custom.css</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="k">margin-top</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">2px</span><span class="p">;</span>
  <span class="k">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
  <span class="k">display</span><span class="o">:</span> <span class="n">table</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="nt">label</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#error_explanation</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">400px</span><span class="p">;</span>
  <span class="k">border</span><span class="o">:</span> <span class="m">2px</span> <span class="k">solid</span> <span class="nb">red</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">7px</span><span class="p">;</span>
  <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span>
  <span class="k">background-color</span><span class="o">:</span> <span class="m">#f0f0f0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#error_explanation</span> <span class="nt">h2</span> <span class="p">{</span>
  <span class="k">text-align</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
  <span class="k">font-weight</span><span class="o">:</span> <span class="k">bold</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">5px</span> <span class="m">5px</span> <span class="m">5px</span> <span class="m">15px</span><span class="p">;</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span>
  <span class="k">margin</span><span class="o">:</span> <span class="m">-7px</span><span class="p">;</span>
  <span class="k">background-color</span><span class="o">:</span> <span class="m">#c00</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#error_explanation</span> <span class="nt">p</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span> <span class="m">#333</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#error_explanation</span> <span class="nt">ul</span> <span class="nt">li</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span>
  <span class="k">list-style</span><span class="o">:</span> <span class="k">square</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:signup_error_messages"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_error_messages.png" alt="signup_error_messages" /></span></div><div class="caption"><span class="header">Рисунок  8.7: </span><span class="description">Сбой регистрации с сообщениями об ошибках.&nbsp;<a href="http://railstutorial.org/images/figures/signup_error_messages-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:filtering_parameter_logging"></div>


<h3><a id="sec:8.2.4" href="sign-up?version=3.0#sec:filtering_parameter_logging" class="heading"><span class="number">8.2.4</span> Фильтрация логгируемых параметров</a></h3>

<p>Прежде чем перейти к успешной регистрации, нужно довести до конца одно дело. Вы могли заметить, что, хотя приложили большие усилия, чтобы зашифровать пароль в <a class="ref" href="modeling-and-viewing-users-two?version=3.0#top">Главе&nbsp;7</a>, как пароль так и его подтверждение появляются в виде <a href="http://www.computerhope.com/jargon/c/cleartex.htm">чистого текста</a> в отладочной информации. Само по себе это не проблема, вспомните из <a class="ref" href="modeling-and-viewing-users-one?version=3.0#code:rails_debug">Листинга&nbsp;6.23</a> что эта информация отображается только для приложений, работающих в режиме <code>development</code>, поэтому реальные пользователи никогда не увидят этого, но это намек на потенциальную проблему: пароли могут также появиться в незашифрованном виде в <em>log файле</em> который Rails использует для записи информации о выполнении приложения. Действительно, в предыдущих версиях Rails, development log файл в этом случае мог содержать строки, подобные показанным в <a class="ref" href="sign-up?version=3.0#code:development_log_file_with_passwords">Листинге&nbsp;8.11</a>.</p>

<div class="label" id="code:development_log_file_with_passwords"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.11.</span> <span class="description">Development log предыдущих (до 3) версий Rails с видимыми паролями. <br /> <code>log/development.log</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="ss">Parameters:</span> <span class="p">{</span><span class="s2">&quot;commit&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Sign up&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
<span class="s2">&quot;authenticity_token&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;K1HchFF8uYE8ZaQKz5DVG9vF2KGoXJu4JGp/VE3NMjA=&quot;</span><span class="p">,</span>
<span class="s2">&quot;controller&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;users&quot;</span><span class="p">,</span>
  <span class="s2">&quot;user&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="s2">&quot;password_confirmation&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;dude&quot;</span><span class="p">,</span>
           <span class="s2">&quot;password&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;foo@invalid&quot;</span><span class="p">}}</span>
</pre></div>
</div></div>


<p>Хранение незашифрованных паролей в лог-файлах было бы страшным нарушением безопасности, если  бы кто-нибудь овладел файлом, он потенциально мог получить пароли каждого пользователя в системе. (Конечно, здесь показана провальная регистрация, но для успешной регистрации проблема аналогична.) Эта проблема была настолько распространена в Rails приложениях, что Rails 3 реализовал новое значение по умолчанию: теперь все <code>password</code> атрибуты фильтруются автоматически, как показано в <a class="ref" href="sign-up?version=3.0#code:development_log_file_with_filtered_passwords">Листинге&nbsp;8.12</a>. Мы видим, что строка <code>"[FILTERED]"</code> появляется на месте пароля и его подтверждения. (В production, лог-файлом будет <code>log/production.log</code>, и фильтрация будет работать аналогичным образом.)</p>

<div class="label" id="code:development_log_file_with_filtered_passwords"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.12.</span> <span class="description">Лог-файл с фильтруемыми паролями. <br /> <code>log/development.log</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="ss">Parameters:</span> <span class="p">{</span><span class="s2">&quot;commit&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Sign up&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
<span class="s2">&quot;authenticity_token&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;K1HchFF8uYE8ZaQKz5DVG9vF2KGoXJu4JGp/VE3NMjA=&quot;</span><span class="p">,</span>
<span class="s2">&quot;controller&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;users&quot;</span><span class="p">,</span>
  <span class="s2">&quot;user&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="s2">&quot;password_confirmation&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;[FILTERED]&quot;</span><span class="p">,</span>
           <span class="s2">&quot;password&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;[FILTERED]&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;foo@invalid&quot;</span><span class="p">}}</span>
</pre></div>
</div></div>


<p>Сама фильтрация паролей осуществляется через настройки в конфигурационном файле <code>application.rb</code> (<a class="ref" href="sign-up?version=3.0#code:password_filtering">Листинг&nbsp;8.13</a>).</p>

<div class="label" id="code:password_filtering"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.13.</span> <span class="description">Дефолтная фильтрация паролей. <br /> <code>config/application.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../boot&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>

<span class="nb">require</span> <span class="s1">&#39;rails/all&#39;</span>

<span class="c1"># If you have a Gemfile, require the gems listed there, including any gems</span>
<span class="c1"># you&#39;ve limited to :test, :development, or :production.</span>
<span class="no">Bundler</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="p">)</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Bundler</span><span class="p">)</span>

<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails::Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="c1"># Configure sensitive parameters which will be filtered from the log file.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">filter_parameters</span> <span class="o">+=</span> <span class="o">[</span><span class="ss">:password</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>



<p>Если вы когда-нибудь будете писать Rails приложение с именем защищаемого параметра, <em>отличным</em> от <code>password</code>, вы должны добавить его в массив фильтруемых параметров. Например, если у вас включен секретный код как часть процесса регистрации, вы можете включить строку</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:secret_code</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:secret_code</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>в регистрационную форму. Затем вам необходимо будет добавить <code>:secret_code</code> в <code>application.rb</code> следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">filter_parameters</span> <span class="o">+=</span> <span class="o">[</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">:secret_code</span><span class="o">]</span>
</pre></div>
</div>




<div class="label" id="sec:signup_success"></div>


<h2><a id="sec:8.3" href="sign-up?version=3.0#sec:signup_success" class="heading"><span class="number">8.3</span> Успешная регистрация</a></h2>

<p>Получив обработку недействительной предоставляемой формы, теперь пришло время для завершения регистрационной формы, на самом деле сохранив нового пользователя (если валидный) в базу данных. Во-первых, мы попробуем сохранить пользователя; если сохранение пройдет успешно, информация пользователя будет записана в базу данных автоматически, а затем  <em>перенаправлена</em> браузеру для отображения профиля пользователя (вместе с дружеским приветствием), как показано в макете на <a class="ref" href="sign-up?version=3.0#fig:signup_success_mockup">Рис.&nbsp;8.8</a>. Если это не удастся, мы просто отступим к сценарию, разработанному в <a class="ref" href="sign-up?version=3.0#sec:signup_failure">Разделе&nbsp;8.2</a>.</p>

<div class="label" id="fig:signup_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_success_mockup.png" alt="signup_success_mockup" /></span></div><div class="caption"><span class="header">Рисунок  8.8: </span><span class="description">Макет успешной регистрации.&nbsp;<a href="http://railstutorial.org/images/figures/signup_success_mockup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:testing_success"></div>


<h3><a id="sec:8.3.1" href="sign-up?version=3.0#sec:testing_success" class="heading"><span class="number">8.3.1</span> Тестирование успешной регистрации</a></h3>

<p>Тесты для успешной регистрации следуют примеру тестов для сбоя регистрации из <a class="ref" href="sign-up?version=3.0#code:failing_create_specs">Листинга&nbsp;8.6</a>. Давайте посмотрим на результат, показанный в <a class="ref" href="sign-up?version=3.0#code:signup_success_tests">Листинге&nbsp;8.14</a>.</p>

<div class="label" id="code:signup_success_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.14.</span> <span class="description">Тесты для успешной регистрации. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;New User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
                  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should create a user&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should redirect to the user show page&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">user_path</span><span class="p">(</span><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)))</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Как и тестами сбоя регистрации (<a class="ref" href="sign-up?version=3.0#code:failing_create_specs">Листинг&nbsp;8.6</a>), здесь мы используем <code>post :create</code> для обращения к <code>create</code> действию с HTTP запросом <tt>POST</tt>. Как и в тестах для провального создания <a class="ref" href="sign-up?version=3.0#code:failing_create_specs">Листинг&nbsp;8.6</a>, первый тест сворачивает создание пользователя в <code>lambda</code> и использует <code>count</code> метод для проверки того, что база данных изменилась соответствующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should create a user&quot;</span> <span class="k">do</span>
  <span class="nb">lambda</span> <span class="k">do</span>
    <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
  <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Здесь, вместо <code>should_not change(User, :count)</code>  как в случае провального создания пользователя, мы имеем <code>should change(User, :count).by(1)</code>, которое утверждает, что <code>lambda</code> блок должен изменить количество <code>User</code> на&nbsp;1.</p>

<p>Второй тест использует <code>assigns</code> метод, впервые показанный в <a class="ref" href="modeling-and-viewing-users-two?version=3.0#code:get_show_test">Листинге&nbsp;7.17</a> чтобы проверить, что действие <code>create</code> перенаправляется на вновь созданную страницу user&rsquo;s <code>show</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should redirect to the user show page&quot;</span> <span class="k">do</span>
  <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
  <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">user_path</span><span class="p">(</span><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)))</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Этот вид переадресации происходит при, практически, каждой успешной отправке формы в вебе, и, благодаря удобному синтаксису RSpec, вы не должны ничего знать о лежащем в его основе коде ответа HTTP.<sup class="footnote" id="fnref:8.5"><a href="?version=3.0#fn:8.5">5</a></sup> Сам URL генерируется с использованием именованного маршрута <code>user_path</code>, показанного в <a class="ref" href="modeling-and-viewing-users-two?version=3.0#table:named_routes">Таблице&nbsp;7.1</a>.</p>

<div class="label" id="sec:the_finished_signup_form"></div>


<h3><a id="sec:8.3.2" href="sign-up?version=3.0#sec:the_finished_signup_form" class="heading"><span class="number">8.3.2</span> Завершение формы регистрации</a></h3>

<p>Чтобы получить прохождение этих тестов, и, тем самым, завершить рабочую регистрационную форму, заполните закомментированный раздел в <a class="ref" href="sign-up?version=3.0#code:first_create_action">Листинге&nbsp;8.7</a> переадресацией, как показано в <a class="ref" href="sign-up?version=3.0#code:user_create_action">Листинге&nbsp;8.15</a>.</p>

<div class="label" id="code:user_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.15.</span> <span class="description">Действие user <code>create</code> с сохранением и перадресацией. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Sign up&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание, что мы можем опустить <code>user_path</code> в переадресации, написав просто <code>redirect_to @user</code> для перенаправления на страницу показывающую пользователя, в соответствии с конвенцией, которую мы видели ранее в контексте <code>link_to</code> в <a class="ref" href="modeling-and-viewing-users-two?version=3.0#code:user_show_with_sidebar">Листинге&nbsp;7.25</a>. Этот синтаксис приятно краток, но, к сожалению RSpec не понимает его, поэтому в тестах мы должны использовать более подробный <code>user_path(@user)</code>.</p>

<div class="label" id="sec:the_flash"></div>


<h3><a id="sec:8.3.3" href="sign-up?version=3.0#sec:the_flash" class="heading"><span class="number">8.3.3</span> Флэш</a></h3>

<p>Перед отправкой валидной регистрации в браузер, мы собираемся немного отполировать ее, в соответствии с общепринятой в веб приложениях идеей: добавив сообщение, которое временно  появляется, а затем исчезает при перезагрузке страницы. (Если сейчас что-то непонятно, будьте терпеливы; Конкретный пример появится в ближайшее время) Rails способ сделать это состоит в использовании специальной переменной <em>flash</em>, которая работает как <a   href="http://ru.wikipedia.org/wiki/Флэш-память">флэш-память</a> в том, что она хранит свои данные временно. Переменная <code>flash</code> это на самом деле хэш; и вы можете даже вспомнить консольный например, в <a class="ref" href="rails-flavored-ruby?version=3.0#sec:hashes_and_symbols">Разделе&nbsp;4.3.3</a>, где мы видели, как для перебора хэша использовался стратегически именованный хэш <code>flash</code>. Чтобы вспомнить, попробуйте эту консольную сессию:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">:error</span> <span class="o">=&gt;</span> <span class="s2">&quot;It failed. :-(&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, :error =&gt; &quot;It failed. :-(&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">success</span>
<span class="go">It worked!</span>
<span class="go">error</span>
<span class="go">It failed. :-(</span>
</pre></div>
</div>


<p>Мы можем организовать отображение содержимого Флэш на веб-узле, включив его в макет нашего приложения, как в <a class="ref" href="sign-up?version=3.0#code:layout_flash">Листинге&nbsp;8.16</a>.</p>

<div class="label" id="code:layout_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.16.</span> <span class="description">Добавление содержимого <code>flash</code> переменной в макет сайта. <br /> <code>app/views/layouts/application.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;flash </span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Этот код организует вставку каждого флэш элемента в <code>div</code> тег, с CSS классом, указывающим на тип сообщения. Например, если <code>flash[:success] = "Welcome to the Sample App!"</code>, то код</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;flash </span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>произведет такой HTML:<sup class="footnote" id="fnref:8.6"><a href="?version=3.0#fn:8.6">6</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;flash success&quot;</span><span class="nt">&gt;</span>Welcome to the Sample App!<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Причина, по которой мы перебираем все возможные пары ключ/значение заключается в том, что благодаря этому мы сможем включать другие виды флэш сообщений; например, в <a class="ref" href="sign-in-sign-out?version=3.0#code:signin_failure">Листинге&nbsp;9.8</a> мы увидим <code>flash[:error]</code> используемое для индикации неудавшегося входа на сайт.<sup class="footnote" id="fnref:8.7"><a href="?version=3.0#fn:8.7">7</a></sup></p>

<p>Давайте протестируем флэш сообщение, чтобы убедиться в его правильности и в том, что оно появляется под ключом <code>:success</code> (<a class="ref" href="sign-up?version=3.0#code:signup_flash_test">Листинг&nbsp;8.17</a>).</p>

<div class="label" id="code:signup_flash_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.17.</span> <span class="description">Тест для флэш сообщения об успешной регистрации. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>

    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">it</span> <span class="s2">&quot;should have a welcome message&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/welcome to the sample app/i</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Это вводит &ldquo;равно-тильда&rdquo; <tt class="verb">=~</tt> оператор для сравнения строк с регулярными выражениями. (Мы впервые увидели регулярные выражения в <code>email_regex</code> <a class="ref" href="modeling-and-viewing-users-one?version=3.0#code:validates_format_of_email">Листинга&nbsp;6.17</a>). Вместо того, чтобы тестировать полное флэш сообщение, мы просто тестируем на существование &ldquo;welcome to the sample app&rdquo;. (Обратите внимание, что у нас еще нет теста для внешнего вида реального HTML флэш сообщений; мы исправим это тестированием  фактического тега <a class="ref" href="sign-up?version=3.0#sec:successful_signup">Раздел&nbsp;8.4.3</a>.)</p>

<p>Если вы много программировали ранее, скорее всего, вы уже знакомы с регулярными выражениями, но вот быстрая <code>console</code> сессия в случае если вам необходимо введение:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foo bar&quot;</span> <span class="o">=~</span> <span class="sr">/Foo/</span>     <span class="c1"># Regex сравнение по умолчанию чувствительно к регистру.</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foo bar&quot;</span> <span class="o">=~</span> <span class="sr">/foo/</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>Значения, возвращаемые здесь консолью, могут выглядеть странно: для несовпадения, regex сравнение возвращает <code>nil</code>; для совпадения оно возвращает <em>index</em> (позицию, место) в строке где началось совпадение.<sup class="footnote" id="fnref:8.8"><a href="?version=3.0#fn:8.8">8</a></sup> Обычно точный индекс не имеет значения, так как сравнение, как правило, используется в булевом контексте: вспомните из <a class="ref" href="rails-flavored-ruby?version=3.0#sec:objects_and_message_passing">Раздела&nbsp;4.2.3</a> что <code>nil</code> это <code>false</code> в булевом контексте и что все остальное (даже&nbsp;<code>0</code>) является истиной. Таким образом, мы можем написать код, подобный этому:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">success</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
<span class="go">=&gt; &quot;Welcome to the Sample App!&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;It&#39;s a match!&quot;</span> <span class="k">if</span> <span class="n">success</span> <span class="o">=~</span> <span class="sr">/welcome to the sample app/</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>Здесь нет совпадения, поскольку регулярные выражения чувствительны к регистру по умолчанию, но мы можем быть более снисходительными при сравнении, используя&nbsp;<code>/.../i</code> чтобы добиться нечувствительного к регистру совпадения:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;It&#39;s a match!&quot;</span> <span class="k">if</span> <span class="n">success</span> <span class="o">=~</span> <span class="sr">/welcome to the sample app/i</span>
<span class="go">=&gt; &quot;It&#39;s a match!&quot;</span>
</pre></div>
</div>


<p>Теперь, когда мы понимаем, как работает сравнение регулярных выражений в тестах флэш, мы можем получить прохождение тестов, назначив <code>flash[:success]</code> в действии <code>create</code> как в <a class="ref" href="sign-up?version=3.0#code:signup_flash">Листинге&nbsp;8.18</a>. Сообщения используют различный регистр, но тесты пройдут в любом случае так как в конце регулярного выражения стоит&nbsp;<code>i</code>. Таким образом, мы не испортим тест, если напишем, например, <code>sample app</code> вместо <code>Sample App</code>.</p>

<div class="label" id="code:signup_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.18.</span> <span class="description">Добавление флэш сообщения в регистрацию пользователя. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Sign up&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:the_first_signup"></div>


<h3><a id="sec:8.3.4" href="sign-up?version=3.0#sec:the_first_signup" class="heading"><span class="number">8.3.4</span> Первая регистрация</a></h3>

<p>Вы можете увидеть результат всей этой работы, зарегистрировав нашего первого пользователя (под именем &ldquo;Rails Tutorial&rdquo; и адресом электронной почты &ldquo;<tt>example@railstutorial.org</tt>&rdquo;), которые показывают дружеское послание после успешной регистрации, как показано на <a class="ref" href="sign-up?version=3.0#fig:signup_flash">Рис.&nbsp;8.9</a>. (приятный зеленый дизайн для <code>success</code> класса был включен с помощью Blueprint CSS фреймворка из <a class="ref" href="rails-flavored-ruby?version=3.0#sec:cascading_style_sheets">Раздела&nbsp;4.1.2</a>.) Затем, после перезагрузки страницы показывающей пользователя, флэш сообщение исчезает, как и было обещано (<a class="ref" href="sign-up?version=3.0#fig:signup_flash_reloaded">Рис.&nbsp;8.10</a>).</p>

<div class="label" id="fig:signup_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash.png" alt="signup_flash" /></span></div><div class="caption"><span class="header">Рисунок  8.9: </span><span class="description">Результат успешной регистрации, с флеш сообщением.&nbsp;<a href="http://railstutorial.org/images/figures/signup_flash-full.png">(полный размер)</a></span></div></div>




<div class="label" id="fig:signup_flash_reloaded"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash_reloaded.png" alt="signup_flash_reloaded" /></span></div><div class="caption"><span class="header">Рисунок  8.10: </span><span class="description">Страница профиля пользователя с исчезнувшим после перезагрузки браузера флэш сообщением.&nbsp;<a href="http://railstutorial.org/images/figures/signup_flash_reloaded-full.png">(полный размер)</a></span></div></div>


<p>Теперь мы можем проверить нашу базу данных, только чтобы еще раз убедиться, что новый пользователь был действительно создан:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Rails Tutorial&quot;, email: &quot;example@railstutorial.org&quot;,</span>
<span class="go">created_at: &quot;2010-02-17 03:07:53&quot;, updated_at: &quot;2010-02-17 03:07:53&quot;,</span>
<span class="go">encrypted_password: &quot;48aa8f4444b71f3f713d87d051819b0d44cd89f4a963949f201...&quot;,</span>
<span class="go">salt: &quot;f52924ba502d4f92a634d4f9647622ccce26205176cceca2adc...&quot;&gt;</span>
</pre></div>
</div>


<p>Успех!</p>

<div class="label" id="sec:rspec_integration_tests"></div>


<h2><a id="sec:8.4" href="sign-up?version=3.0#sec:rspec_integration_tests" class="heading"><span class="number">8.4</span> RSpec интеграционные тесты</a></h2>

<p>В принципе, мы закончили с регистрацией пользователей, но вы могли заметить, что мы не протестировали структуру формы регистрации, также мы не проверили, что предоставление информации действительно работает. Конечно, мы <em>должны</em> проверить это, просмотрев страницы в нашем браузере, но весь смысл автоматизированного тестирования в том, чтобы убедиться, что раз уж вещи работают, то они и останутся таковыми. Создание таких тестов - цель этого раздела и результаты довольно приятны.</p>

<p>Один метод тестирования мог бы проверять структуру HTML формы (с использованием <code>render_views</code> и <code>have_selector</code> метода), и это действительно хороший способ для тест-драйва представлений. (<a class="ref" href="sign-up?version=3.0#sec:signup_exercises">Раздел&nbsp;8.6</a> имеет упражнения на этот счет.) Но я предпочитаю не тестировать детальную структуру HTML представлений&mdash;я не вижу никаких причин, почему мы должны знать, что Rails реализует предоставление пользовательского email используя <code>name="user[email]"</code>, к тому же, любые тесты этой структуры будут сломаны, если будущие версии Rails изменят эту конвенцию. Кроме того, было бы неплохо иметь тесты для всего процесса регистрации: посещение страницы регистрации, заполнение формы, нажатие на кнопку, и проверка (если предоставленные данные валидны) того, что новый пользователь создается в (тестовой) базе данных.</p>

<p>Хотя это не единственный способ (см. <a class="ref" href="sign-up?version=3.0#sidebar:integration_alternatives">Блок&nbsp;8.1</a>), я предпочитаю решать эту проблему используя RSpec интеграционные тесты, которые мы впервые использовали в <a class="ref" href="filling-in-the-layout?version=3.0#sec:integration_tests">Разделе&nbsp;5.2.1</a> для тестирования пользовательских маршрутов (например <tt>/about</tt> для About страницы). В том разделе мы видели только небольшую часть мощности интеграционных тестов; начиная с этого раздела, мы увидим, насколько удивительными они могут быть.</p>

<div class="label" id="sidebar:integration_alternatives"></div>


<div class="sidebar"><span class="title"><span class="header">Box 8.1.</span><span class="description">Интеграционные альтернативы</span></span>
<p>Как мы видели в этой и предыдущих главах, <em>Учебник Ruby On Rails</em> использует RSpec для всех испытаний, в том числе, для интеграционных тестов. На мой взгляд, нет ничего равносильного  простоте и мощи RSpec интеграционных тестов. Однако есть несколько реальных альтернатив. Одна из них это дефолтное Rails интеграционное тестирование с <tt>Test::Unit</tt>. Это нормально, если вы используете <tt>Test::Unit</tt> в другом месте, но мы используем RSpec в этом учебнике, и я предпочитаю не смешивать RSpec и <tt>Test::Unit</tt> в одном проекте.</p>

<p>Второй вариант это <a href="http://cukes.info">Cucumber</a> (Огурец), который хорошо работает с RSpec и позволяет определять читаемый текст историй, описывающих поведение приложений. Многие программисты Rails находят Cucumber особенно удобным при работе с клиентами; так как они могут быть прочитаны даже неопытными пользователями, Cucumber тесты, или &ldquo;сценарии&rdquo;, могут использоваться совместно с (и иногда даже быть написанными) клиентом. Конечно, использование фреймворка тестирования, который не является чистым Ruby имеет и оборотную сторону, и я считаю, что текстовые истории могут быть излишне многословными и немного громоздкими (# в оригинале - "(cu)cumbersome"). Поскольку в Rails Tutorial у нас нет каких-либо  клиентских требований, и так как я решительно предпочитаю чисто Ruby-подход к тестированию в любом случае, мы будем придерживаться RSpec интеграционных тестов в этой книге. Тем не менее, я предлагаю взглянуть на некоторые <a   href="https://github.com/cucumber/cucumber/wiki/tutorials-and-related-blog-posts">Cucumber tutorials</a> чтобы посмотреть, подходит ли он вам.</p>
</div>




<div class="label" id="sec:integration_tests_with_style"></div>


<h3><a id="sec:8.4.1" href="sign-up?version=3.0#sec:integration_tests_with_style" class="heading"><span class="number">8.4.1</span> Интеграционные тесты со стилем</a></h3></a></h3>


<p>Мы видели в <a class="ref" href="filling-in-the-layout?version=3.0#code:layout_links_spec">Листинге&nbsp;5.13</a> что RSpec интеграционные тесты поддерживают контроллер-тест&ndash;стиль конструкции, такие как</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;/&#39;</span>
<span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Home&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Однако это не единственный вид поддерживаемого синтаксиса, RSpec интеграционные тесты также поддерживают очень выразительный синтаксис веб-навигации.<sup class="footnote" id="fnref:8.9"><a href="?version=3.0#fn:8.9">9</a></sup> В этом разделе, мы увидим как использовать этот синтаксис для имитации заполнения регистрационной формы, используя код вида:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signin_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">click_button</span>
</pre></div>
</div>




<div class="label" id="sec:failed_signup"></div>


<h3><a id="sec:8.4.2" href="sign-up?version=3.0#sec:failed_signup" class="heading"><span class="number">8.4.2</span> Сбой регистрации пользователя не должен создавать нового пользователя</a></h3>

<p>Теперь мы готовы сделать интеграционный тест для регистрации пользователей. Как мы видели в <a class="ref" href="filling-in-the-layout?version=3.0#sec:integration_tests">Разделе&nbsp;5.2.1</a>, RSpec поставляется с генератором для изготовления подобных интеграционных specs; в данном случае, наши интеграционные тесты будут содержать различные действия, предпринимаемые пользователями, поэтому мы назовем тесты <code>users</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test users
<span class="go">      invoke  rspec</span>
<span class="go">      create    spec/requests/users_spec.rb</span>
</pre></div>
</div>


<p>Как и в <a class="ref" href="filling-in-the-layout?version=3.0#sec:integration_tests">Разделе&nbsp;5.2.1</a>, генератор автоматически добавляет spec идентификатор, что приводит название файла теста к виду <code>users_spec.rb</code>.<sup class="footnote" id="fnref:8.10"><a href="?version=3.0#fn:8.10">10</a></sup></p>

<p>Мы начнем со сбоя регистрации. Простой способ организовать провальную регистрацию, это посетить signup URL и просто нажать на кнопку, в результате должна появиться страница как в <a class="ref" href="sign-up?version=3.0#fig:blank_signup">Рис.&nbsp;8.11</a>. После сбоя предоставления, ответ должен сформировать <code>users/new</code> шаблон.  Если вы проверите результирующий HTML, вы должны увидеть что-то вроде разметки в <a class="ref" href="sign-up?version=3.0#code:error_explanation">Листинге&nbsp;8.19</a>. Это означает, что мы можем проверить на наличие сообщений об ошибках, поиском тега <code>div</code> с CSS id <code>"error_explanation"</code>. Тест для этого шага представлен в <a class="ref" href="sign-up?version=3.0#code:signup_failure_test">Листинге&nbsp;8.20</a>.</p>

<div class="label" id="fig:blank_signup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/blank_signup.png" alt="blank_signup" /></span></div><div class="caption"><span class="header">Рисунок  8.11: </span><span class="description">Результат посещения  <a href="http://localhost:3000/signup"><tt>/signup</tt></a> и просто клика &ldquo;Sign up&rdquo;.&nbsp;<a href="http://railstutorial.org/images/figures/blank_signup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="code:error_explanation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.19.</span> <span class="description"><code>div</code> error_explanation из страницы на <a class="ref" href="sign-up?version=3.0#fig:blank_signup">Рис.&nbsp;8.11</a>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;error_explanation&quot;</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;</span>5 errors prohibited this user from being saved<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;p&gt;</span>There were problems with the following fields:<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>Name can&#39;t be blank<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>Email can&#39;t be blank<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>Email is invalid<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>Password can&#39;t be blank<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>Password is too short (minimum is 6 characters)<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:signup_failure_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.20.</span> <span class="description">Тестирование сбоя регистрации. <br /> <code>spec/requests/users_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Users&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not make a new user&quot;</span> <span class="k">do</span>
        <span class="n">visit</span> <span class="n">signup_path</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">click_button</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;users/new&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div#error_explanation&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Здесь <code>"div#error_explanation"</code> это CSS-вдохновленное сокращение для</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Обратите внимание, какой естественный язык в <a class="ref" href="sign-up?version=3.0#code:signup_failure_test">Листинге&nbsp;8.20</a>. Единственная проблема заключается в том, что это (# написано по-английски?)   <em>немного</em> не тот тест который мы хотели: мы на самом деле не протестировали что сбой предоставления формы приводит к сбою создания нового пользователя. Чтобы так сделать, нам нужно свернуть шаги теста в один пакет, а затем проверить что количество <code>User</code> не изменилось. Как мы видели в  <a class="ref" href="sign-up?version=3.0#code:failing_create_specs">Листинге&nbsp;8.6</a> и  <a class="ref" href="sign-up?version=3.0#code:signup_success_tests">Листинге&nbsp;8.14</a>, это может быть достигнуто с <code>lambda</code>. В тех случаях блок <code>lambda</code> содержал только одну строку, но мы видим в <a class="ref" href="sign-up?version=3.0#code:signup_failure_test_lambda">Листинг&nbsp;8.21</a> Листинге&nbsp;8.21</a> что она может обвернуть несколько строк так же легко.</p>

<div class="label" id="code:signup_failure_test_lambda"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.21.</span> <span class="description">Тестирование сбоя регистрации с <code>lambda</code>. <br /> <code>spec/requests/users_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Users&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not make a new user&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">signup_path</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">click_button</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;users/new&#39;</span><span class="p">)</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div#error_explanation&quot;</span><span class="p">)</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Как и в <a class="ref" href="sign-up?version=3.0#code:failing_create_specs">Листинг&nbsp;8.6</a>, это использует</p>

<div class="code"><div class="highlight"><pre><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>чтобы проверить, что код внутри <code>lambda</code> блока не меняет значение <code>User.count</code>.</p>

<p>Интеграционный тест в <a class="ref" href="sign-up?version=3.0#code:signup_failure_test_lambda">Листинге&nbsp;8.21</a> связывает воедино все части Rails, включая модели, представления, контроллеры, маршрутизацию и хелперы. Он обеспечивает непрерывную цепь проверяющую, что наш регистрационный механизм исправно работает, по крайней мере для случая сбоя регистрации.</p>

<div class="label" id="sec:successful_signup"></div>


<h3><a id="sec:8.4.3" href="sign-up?version=3.0#sec:successful_signup" class="heading"><span class="number">8.4.3</span> Успешная регистрация пользователя должна создавать нового пользователя</a></h3>

<p>Теперь мы переходим к интеграцоннму тесту для успешной регистрации. В этом случае нам необходимо заполнить поля регистрации валидными данными пользователя. Когда мы закончим, результом должна быть страница показывающая пользователя с &ldquo;flash success&rdquo; <code>div</code> тегом, и это должно изменить количество User на&nbsp;1. <a class="ref" href="sign-up?version=3.0#code:signup_success_test">Листинг&nbsp;8.22</a> показывает, как это сделать</p>

<div class="label" id="code:signup_success_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.22.</span> <span class="description">Тестирование успешной регистрации. <br /> <code>spec/requests/users_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Users&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should make a new user&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">signup_path</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
          <span class="n">click_button</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div.flash.success&quot;</span><span class="p">,</span>
                                        <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Welcome&quot;</span><span class="p">)</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;users/show&#39;</span><span class="p">)</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Кстати, хотя это не очевидно из документации RSpec, вы можете использовать HTML-атрибут 'id' текстового поля вместо содержимого связанного тега label, так что <code>fill_in :user_name</code> тоже работает.<sup class="footnote" id="fnref:8.11"><a href="?version=3.0#fn:8.11">11</a></sup> (Это особенно хорошо для форм, которые не используют labels(??).)</p>

<p>Я надеюсь, вы согласитесь, что этот синтаксис веб-навигации невероятно естественный и краткий. Например, чтобы заполнить поля значениями, мы просто используем такой код:</p>

<div class="code"><div class="highlight"><pre><span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
</pre></div>
</div>


<p>Здесь первыми аргументами <code>fill_in</code> являются значения меток, т. е. именно тот текст, который пользователь видит в браузере; нет необходимости знать что-нибудь о лежащей в его основе структуре HTML, сгенерированной Rails хелпером <code>form_for</code>.</p>

<p>Наконец, мы подошли к <a  href="http://ru.wikipedia.org/wiki/Coup_de_grace">coup de gr&acirc;ce</a>&mdash;тестированию того, что успешная регистрация действительно создает пользователя в базе данных:</p>


<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should make a new user&quot;</span> <span class="k">do</span>
  <span class="nb">lambda</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>Как и в <a class="ref" href="sign-up?version=3.0#code:signup_failure_test_lambda">Листинге&nbsp;8.21</a>, мы завернули код для успешной регистрации в <code>lambda</code> блок. В этом случае, вместо того, чтобы убедиться, что количество пользователей <em>не</em> меняется, мы убедимся, что оно увеличивается на&nbsp;1 за счет записи пользователя, создаваемой в тестовой базе данных. Результат выглядит следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/users_spec.rb
<span class="go">..</span>


<span class="go">Finished in 2.14 seconds</span>
<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>С этим, наши интеграционные тесты для регистрации завершены, и мы можем быть уверены, что, если пользователи не присоединяется к нашему сайту, то это не потому, что регистрационная форма не работает.</p>

<h2><a id="sec:8.5" href="sign-up?version=3.0#sec:8.5" class="heading"><span class="number">8.5</span> Заключение</a></h2>

<p>Возможность регистрировать пользователей это важная веха для нашего приложения. Хотя пример приложения до сих пор не делает ничего полезного, мы заложили необходимый фундамент для  будущего развития. В следующих двух главах, мы завершим еще две основные вехи: во-первых, в <a class="ref" href="sign-in-sign-out?version=3.0#top">Главе&nbsp;9</a> мы завершим нашу аутентификационную машинерию, позволив пользователям входить и выходить из приложения, во-вторых, в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#top">Главе&nbsp;10</a> мы позволим всем пользователям обновлять информацию в их учетных записях и позволим администраторам сайта удалять пользователей, а также добавим защиту страниц для обеспечения безопасности сайта, завершив тем самым полный набор REST действий для ресурса Users из <a class="ref" href="modeling-and-viewing-users-one?version=3.0#table:RESTful_users">Таблицы&nbsp;6.2</a>.</p>

<p>Как обычно, если вы используете Git, вы должны объединить ваши изменения c главной веткой:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;User signup complete&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge signing-up
</pre></div>
</div>


<div class="label" id="sec:signup_exercises"></div>


<h2><a id="sec:8.6" href="sign-up?version=3.0#sec:signup_exercises" class="heading"><span class="number">8.6</span> Упражнения</a></h2>




<ol>

<li>Используя модель из <a class="ref" href="sign-up?version=3.0#code:field_tests">Листинга&nbsp;8.23</a>, напишите тесты для проверки на наличие каждого поля в регистрационной форме. (Не забудьте строку <code>render_views</code>,  необходимую для работы этих тестов.)</li>

<li>Зачастую регистрационные формы очищают поле пароля при сбое регистрации, как показано на  <a class="ref" href="sign-up?version=3.0#fig:cleared_password">Рис.&nbsp;8.12</a>. Модифицируйте действие <code>create</code> контроллера Users, чтобы изменить соответствующим образом поведение нашего приложения. <em>Подсказка:</em> Сброс <code>@user.password</code>.</li>

<li>HTML флэша в <a class="ref" href="sign-up?version=3.0#code:layout_flash">Листинге&nbsp;8.16</a> это, практически, уродская комбинация HTML и ERb. Проверьте, запустив набор тестов, что более чистый код в <a class="ref" href="sign-up?version=3.0#code:layout_flash_content_tag">Листинге&nbsp;8.24</a>, использующий Rails хелпер <code>content_tag</code>, тоже работает.</li>

</ol>




<div class="label" id="code:field_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.23.</span> <span class="description">Шаблон для написания тестов на наличие каждого поля в регистрационной форме. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;GET &#39;new&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>

    <span class="n">it</span> <span class="s2">&quot;should have a name field&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:new</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;input[name=&#39;user[name]&#39;][type=&#39;text&#39;]&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have an email field&quot;</span>

    <span class="n">it</span> <span class="s2">&quot;should have a password field&quot;</span>

    <span class="n">it</span> <span class="s2">&quot;should have a password confirmation field&quot;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:cleared_password"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/cleared_password.png" alt="cleared_password" /></span></div><div class="caption"><span class="header">Рисунок  8.12: </span><span class="description">Провальная регистрационная форма с очищенным полем пароля.&nbsp;<a href="http://railstutorial.org/images/figures/cleared_password-full.png">(полный размер)</a></span></div></div>




<div class="label" id="code:layout_flash_content_tag"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 8.24.</span> <span class="description">The <code>flash</code> ERb в макете сайта, использующий <code>content_tag</code>. <br /> <code>app/views/layouts/application.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;flash </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<div class="navigation">  <a class="prev_page" href="modeling-and-viewing-users-two?version=3.0#top">
    &laquo;&nbsp;<span class="number">Глава 7</span> Моделирование и просмотр пользователей, часть II
  </a>
  <a class="next_page" href="sign-in-sign-out?version=3.0#top">
    <span class="number">Глава 9</span> Войти, выйти&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:8.1">Если вы получили ошибку вроде <code>views/users/new.html.erb_spec.rb fails</code>, удалите этот мерзкий view specs командой <code>$ rm -rf spec/views</code> .&nbsp;<a class="arrow" href="?version=3.0#fnref:8.1">&uarr;</a></li>
<li id="fn:8.2">Название происходит от <a  href="http://ru.wikipedia.org/wiki/Ламбда-исчисление">лямбда-исчисления</a>, математической системы для представления функций и их операций.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.2">&uarr;</a></li>
<li id="fn:8.3">До Rails&nbsp;3, отображение сообщений об ошибках было реализовано через магический вызов специального метода <code>error_messages</code> на объект формы&nbsp;<code>f</code>, следующим образом: <tt class="verb">&lt;%= f.error_messages %&gt;</tt>. Хотя зачастую это было удобно, этот волшебный метод было тяжело настроить, так что команда Rails Core решила рекомендовать использование Embedded Ruby для отображения ошибок вручную.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.3">&uarr;</a></li>
<li id="fn:8.4">Я выяснил это путем поиска <code>pluralize</code> в Rails API.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.4">&uarr;</a></li>
<li id="fn:8.5">В случае, если вам интересно, код ответа <tt>302</tt>, в отличие от &ldquo;постоянной переадресации&rdquo; <tt>301</tt> кратко обсуждаемой в <a class="ref" href="static-pages?version=3.0#sidebar:response_codes">Блоке&nbsp;3.2</a>.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.5">&uarr;</a></li>
<li id="fn:8.6">Обратите внимание, что ключ <code>:success</code> является символом, но Embedded Ruby автоматически преобразует его в строку <code>"success"</code> перед вставкой в шаблон.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.6">&uarr;</a></li>
<li id="fn:8.7">На самом деле, мы будем использовать тесно связаный <code>flash.now</code>, но мы не будем акцентироваться на этом ньюансе, до тех пор, пока он нам не понадобится.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.7">&uarr;</a></li>
<li id="fn:8.8">Индексы имеют нулевое смещние, как и массивы (<a class="ref" href="rails-flavored-ruby?version=3.0#sec:arrays_and_ranges">Раздел&nbsp;4.3.1</a>), поэтому возвращаемое значение, <code>0</code> означает что строка совпадает с регулярным выражением, начиная с первого символа.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.8">&uarr;</a></li>
<li id="fn:8.9">Что касается этой записи, этот синтаксис доступен благодаря <a href="http://github.com/brynary/webrat">Webrat</a>, (# WebКрыса), которая предоставляется как гем зависимость для <tt>rspec-rails</tt>, но Webrat была написана до широкого внедрения <a  href="http://rack.rubyforge.org/">Rack</a> и в конечном итоге будет вытеснена проектом  <a  href="http://github.com/jnicklas/capybara">Capybara</a>. К счастью, <a  href="http://ru.wikipedia.org/wiki/%CA%E0%EF%E8%E1%E0%F0%E0">Capybara</a> разработан как прямая замена для Webrat, поэтому синтаксис должен остаться тем же.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.9">&uarr;</a></li>
<li id="fn:8.10">Обратите внимание на множественное число; это <em>не</em> User spec <code>user_spec.rb</code>, который является тестом модели, а не интеграционным тестом.&nbsp;<a class="arrow" href="?version=3.0#fnref:8.10">&uarr;</a></li>
<li id="fn:8.11">Вы можете использовать Firebug или &rsquo;s &ldquo;Исходный код страницы&rdquo; вашего браузера, если вам необходимо выяснить id. Или вы можете заметить, что Rails использует имя ресурса и имя атрибута разделенные знаком подчеркивания, что приводит к <code>user_name</code>, <code>user_email</code>, и т.д..&nbsp;<a class="arrow" href="?version=3.0#fnref:8.11">&uarr;</a></li>
</ol>
</div>

