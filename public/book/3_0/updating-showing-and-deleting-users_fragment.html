<div id="top"></div>


<h1 class="chapter"><a id="sec:10" href="updating-showing-and-deleting-users?version=3.0#top" class="heading"><span class="number">Глава 10</span> Обновление, демонстрация, и удаление пользователей</a></h1>


<p>В этой главе мы завершим REST действия для ресурса Users (<a class="ref" href="modeling-and-viewing-users-one?version=3.0#table:RESTful_users">Таблица&nbsp;6.2</a>) добавив <code>edit</code>, <code>update</code>, <code>index</code>, и <code>destroy</code> действия. Мы начнем с того, что дадим пользователям возможность обновлять свои профили, что также обеспечит естественную возможность для обеспечения модели безопасности (стало возможным, благодаря аутентификационному коду из <a class="ref" href="sign-in-sign-out?version=3.0#top">Главы&nbsp;9</a>). Затем мы сделаем список всех пользователей (также требует аутентификации), что будет поводом для внедрения выборки данных и постраничного вывода (пагинации). Наконец, мы также добавим возможность удалять пользователей, стиранием их в базе данных. Так как мы не можем позволить любому пользователю обладать такими опасными возможностями, мы позаботимся о создании привилегированного класса административных пользователей (администраторов).</p>

<p>Начнем с создания новой <code>updating-users</code> темы ветки:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b updating-users
</pre></div>
</div>


<div class="label" id="sec:updating_users"></div>


<h2><a id="sec:10.1" href="updating-showing-and-deleting-users?version=3.0#sec:updating_users" class="heading"><span class="number">10.1</span> Обновление пользователей</a></h2>


<p>Основная идея редактирования информации о пользователе тесно параллельна созданию новых пользователей (<a class="ref" href="sign-up?version=3.0#top">Глава&nbsp;8</a>). Вместо <code>new</code> действия визуализирующего представление для нового пользователя, мы имеем <code>edit</code> действие, отображающее представление для редактирования пользователей; вместо <code>create</code> отвечающего на запрос <tt>POST</tt>, мы имеем <code>update</code> действие, отвечающее на запрос <tt>PUT</tt> (<a class="ref" href="static-pages?version=3.0#sidebar:get_etc">Блок&nbsp;3.1</a>). Основное отличие заключается в том, что зарегистрироваться может любой человек, но только текущий пользователь должен иметь возможность обновлять свою информацию. Это означает, что нам необходимо обеспечить контроль доступа таким образом, чтобы только авторизированные пользователи могли редактировать и обновлять информацию; аутентификационный механизм из <a class="ref" href="sign-in-sign-out?version=3.0#top">Главы&nbsp;9</a> позволит нам использовать <em>before filter</em> для обеспечения этого вида контроля.</p>

<div class="label" id="sec:edit_form"></div>


<h3><a id="sec:10.1.1" href="updating-showing-and-deleting-users?version=3.0#sec:edit_form" class="heading"><span class="number">10.1.1</span> Форма для редактирования</a></h3>


<p>Начнем с тестов для  формы редактирования, макет которой показан на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:edit_user_mockup">Рис.&nbsp;10.1</a>.<sup class="footnote" id="fnref:10.1"><a href="?version=3.0#fn:10.1">1</a></sup> Два аналогичных теста для <code>new</code> user страницы, проверяющие на правильный ответ и заголовок, мы видели в (<a class="ref" href="sign-up?version=3.0#code:new_users_tests">Листинге&nbsp;8.1</a>; третий тест проверяет существование ссылки для редактирования изображения Gravatarа пользователя (<a class="ref" href="modeling-and-viewing-users-two?version=3.0#sec:a_name_and_a_gravatar">Раздел&nbsp;7.3.2</a>). Если вы покопаетесь в сайте Gravatar, вы увидите, что страница для добавления или изменения изображений (что несколько странно), расположена на <a href="http://gravatar.com/emails"><tt>http://gravatar.com/emails</tt></a>, поэтому мы тестируем <code>edit</code> страницу на наличие ссылки на этот URL.<sup class="footnote" id="fnref:10.2"><a href="?version=3.0#fn:10.2">2</a></sup> Результат показан в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_edit_specs">Листинге&nbsp;10.1</a>.</p>

<div class="label" id="fig:edit_user_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_user_mockup.png" alt="edit_user_mockup" /></span></div><div class="caption"><span class="header">Рисунок  10.1: </span><span class="description">Макет страницы редактирования пользователя.&nbsp;<a href="http://railstutorial.org/images/figures/edit_user_mockup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="code:user_edit_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.1.</span> <span class="description">Тест для user <code>edit</code> действия. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;GET &#39;edit&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="n">test_sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a link to change the Gravatar&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;http://gravatar.com/emails&quot;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">gravatar_url</span><span class="p">,</span>
                                         <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;change&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Здесь мы использовали <code>test_sign_in(@user)</code> для входа в качестве пользователя, в ожидании защиты страницы редактирования от несанкционированного доступа (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#sec:protecting_pages">Раздел&nbsp;10.2</a>). В противном случае, эти тесты прервались бы сразу после реализации нашего аутентификационного кода.</p>

<p>Напомним из <a class="ref" href="modeling-and-viewing-users-one?version=3.0#table:RESTful_users">Таблицы&nbsp;6.2</a> что надлежащим URL для страницы редактирования пользователя является <tt>/users/1/edit</tt> (при условии, что id пользователя&nbsp;<tt>1</tt>). Напомним, что идентификатор пользователя доступен в переменной <code>params[:id]</code> , это означает, что мы можем найти пользователя с помощью кода из  <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:initial_edit_action">Листинга&nbsp;10.2</a>. При этом используется <code>find</code> для поиска соответствующего пользователя в базе данных, а затем устанавливается нужное значение переменной <code>@title</code>.</p>

<div class="label" id="code:initial_edit_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.2.</span> <span class="description">User <code>edit</code> действие. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit user&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Для прохождения этих тестов требуется создание соответствующего (edit) представления, показанного в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_edit_view">Листинге&nbsp;10.3</a>. Обратите внимание, насколько оно похоже на new user представление из  <a class="ref" href="sign-up?version=3.0#code:new_user_form">Листинга&nbsp;8.2</a>; большое перекрытие предполагает факторинг повторяющгося кода в партиал, который мы оставим в качестве упражнения (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#sec:updating_deleting_exercises">Раздел&nbsp;10.6</a>).</p>

<div class="label" id="code:user_edit_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.3.</span> <span class="description">Представление user edit. <br /> <code>app/views/users/edit.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Edit user<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Update&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Здесь мы повторно использовали общедоступный партиал <code>error_messages</code>, введеный в <a class="ref" href="sign-up?version=3.0#sec:signup_error_messages">Разделе&nbsp;8.2.3</a>.</p>

<p>Вы можете вспомнить из <a class="ref" href="sign-up?version=3.0#code:f_error_messages">Листинга&nbsp;8.8</a> что error-messages партиал явно связан с переменной <code>@user</code>. В данном случае, у нас <em>есть</em> переменная <code>@user</code>, но для того, чтобы сделать этот партиал действительно общедоступным, мы не должны зависеть от этого факта. Решение заключается в передаче соответствующего объекта переменной формы&nbsp;<code>f</code> в качестве параметра партиала:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Это создает переменную <code>object</code> в партиале, которую мы можем использовать для генерации сообщений об ошибках, как показано в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:updated_error_messages_partial">Листинге&nbsp;10.4</a>. (Отмечу причудливую цепочку методов для получения точной версии имени объекта; см Rails API введение в, скажем, <code>humanize</code>, чтобы получить представление о диапазоне Rails утилит.)</p>

<div class="label" id="code:updated_error_messages_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.4.</span> <span class="description">Обновление error-messages партиала из <a class="ref" href="sign-up?version=3.0#code:errors_partial">Листинга&nbsp;8.9</a>, позволяющее ему работать с другими объектами. <br /> <code>app/views/shared/_error_messages.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
        prohibited this <span class="cp">&lt;%=</span> <span class="n">object</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="o">.</span><span class="n">humanize</span><span class="o">.</span><span class="n">downcase</span> <span class="cp">%&gt;</span>
        from being saved:<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>There were problems with the following fields:<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Здесь используется метод <code>any?</code> который мы видели в <a class="ref" href="sign-up?version=3.0#sec:signup_error_messages">Разделе&nbsp;8.2.3</a>. Пока мы здесь, мы также обновим форму регистрации с более общим кодом (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:signup_errors_updated">Листинг&nbsp;10.5</a>).</p>

<div class="label" id="code:signup_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.5.</span> <span class="description">Обновление рендеринга ошибок регистрации пользователей. <br /> <code>app/views/users/new.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Мы также добавим ссылку на страницу редактирования пользователя в навигацию сайта (мы назовем ее  &ldquo;Settings&rdquo; (#"настройки"), как показано на макете в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:profile_settings_link_mockup">Рис.&nbsp;10.2</a><sup class="footnote" id="fnref:10.3"><a href="?version=3.0#fn:10.3">3</a></sup> и <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:settings_link">Листинге&nbsp;10.6</a>.</p>

<div class="label" id="fig:profile_settings_link_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_settings_link_mockup.png" alt="profile_settings_link_mockup" /></span></div><div class="caption"><span class="header">Рисунок  10.2: </span><span class="description">Макет страницы профиля пользователя со ссылкой &ldquo;Settings&rdquo;.&nbsp;<a href="http://railstutorial.org/images/figures/profile_settings_link_mockup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="code:settings_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.6.</span> <span class="description">Добавление ссылки Settings. <br /> <code>app/views/layouts/_header.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">logo</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>Здесь мы используем именованный маршрут <code>edit_user_path</code> из <a class="ref" href="modeling-and-viewing-users-one?version=3.0#table:RESTful_users">Таблицы&nbsp;6.2</a>, вместе с удобным вспомогательным методом <code>current_user</code> определенным в <a class="ref" href="sign-in-sign-out?version=3.0#code:current_user_working">Листинге&nbsp;9.16</a>.</p>

<p>С переменной экземпляра <code>@user</code> из <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:initial_edit_action">Листинга&nbsp;10.2</a>, тесты из <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_edit_specs">Листинга&nbsp;10.1</a> проходят. Как видно на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:edit_user_settings">Рис.&nbsp;10.3</a>, страница <code>edit</code> отображается, хотя она еще не работает.</p>

<div class="label" id="fig:edit_user_settings"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_user_settings.png" alt="edit_user_settings" /></span></div><div class="caption"><span class="header">Рисунок  10.3: </span><span class="description">Редактирование настроек пользователя (<a href="http://localhost:3000/users/1/edit"><tt>/users/1/edit</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/edit_user_settings-full.png">(полный размер)</a></span></div></div>


<p>Глядя на исходный HTML <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:edit_user_settings">Рис.&nbsp;10.3</a>, мы видим form тег, как и ожидалось (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:edit_form_html">Листинг&nbsp;10.7</a>).</p>

<div class="label" id="code:edit_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.7.</span> <span class="description">HTML формы редактирования, определенной в  <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_edit_view">Листинге&nbsp;10.3</a> и показанной на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:edit_user_settings">Рис.&nbsp;10.3</a>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users/1&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_user&quot;</span> <span class="na">id=</span><span class="s">&quot;edit_user_1&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>Отметим здесь скрытые поля ввода</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Так как веб-браузеры не могут напрямую отправлять <tt>PUT</tt> запросы (в соответствии с требованиями REST конвенции из <a class="ref" href="modeling-and-viewing-users-one?version=3.0#table:RESTful_users">Таблицы&nbsp;6.2</a>), Rails подделывает их с помощью <tt>POST</tt> запроса и скрытого <code>input</code> поля.<sup class="footnote" id="fnref:10.4"><a href="?version=3.0#fn:10.4">4</a></sup></p>

<p>Здесь стоит обратить внимание на еще одну тонкость: код <code>form_for(@user)</code> в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_edit_view">Листинге&nbsp;10.3</a> <em>абсолютно идентичен</em> коду в <a class="ref" href="sign-up?version=3.0#code:new_user_form">Листинге&nbsp;8.2</a> &mdash; откуда Rails знает, что нужно использовать <tt>POST</tt> запрос для  новых пользователей и <tt>PUT</tt> для редактирования пользователей? Ответ кроется в возможности определения того, что мы имеем дело с новым или уже существующим в базе данных пользователем, посредством булевого метода <code>new_record?</code> библиотеки ActiveRecord:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>При построении формы с помощью <code>form_for(@user)</code>, Rails использует <tt>POST</tt> если <code>@user.new_record?</code> это <code>true</code> и <tt>PUT</tt> если это является <code>false</code>.</p>

<div class="label" id="sec:enabling_edits"></div>


<h3><a id="sec:10.1.2" href="updating-showing-and-deleting-users?version=3.0#sec:enabling_edits" class="heading"><span class="number">10.1.2</span> Включение редактирования</a></h3>

<p>Несмотря на то что форма редактирования пока не работает, мы возложили загрузку изображений на Gravatar, поэтому он работает сразу, при нажатии на ссылку &ldquo;change&rdquo; показанную на  <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:edit_user_settings">Рис.&nbsp;10.3</a>, как видно на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:gravatar_cropper">Рис.&nbsp;10.4</a>. Давайте получим остальную функциональность редактирования пользователя, работающую с тем же успехом.</p>

<div class="label" id="fig:gravatar_cropper"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/gravatar_cropper.png" alt="gravatar_cropper" /></span></div><div class="caption"><span class="header">Рисунок  10.4: </span><span class="description">Интерфейс обрезки изображений  <a href="http://gravatar.com/">Gravatar</a> с изображением <a href="http://michaelhartl.com/">какого-то чувака</a>.&nbsp;<a href="http://railstutorial.org/images/figures/gravatar_cropper-full.png">(полный размер)</a></span></div></div>


<p>Тесты для <code>update</code> действия похожи на аналогичные для <code>create</code> действия. В частности, мы тестируем и успех и провал обновления (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_update_specs">Листинг&nbsp;10.8</a>). (Это большой кусок кода; посмотрим, сможете ли вы проработать его, опираясь на тесты из <a class="ref" href="sign-up?version=3.0#top">Главы&nbsp;8</a>.)</p>

<div class="label" id="code:user_update_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.8.</span> <span class="description">Тесты для <code>update</code> действия. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;PUT &#39;update&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="n">test_sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the &#39;edit&#39; page&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;New Name&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.org&quot;</span><span class="p">,</span>
                  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;barbaz&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;barbaz&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should change the user&#39;s attributes&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should redirect to the user show page&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should have a flash message&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/updated/</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Единственная новинка здесь, это метод <code>reload</code>, который появляется в тесте для изменения атрибутов пользователя:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should change the user&#39;s attributes&quot;</span> <span class="k">do</span>
  <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span>
  <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
  <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Этот код перезагружает <code>@user</code> переменную из (тестовой) базы данных используя <code>@user.reload</code>, а затем проверяет, что новые имя пользователя и email совпадают с атрибутами в хэше <code>@attr</code>.</p>

<p>Действие <code>update</code>, необходимое для прохождения тестов в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_update_specs">Листинге&nbsp;10.8</a> аналогично финальной форме <code>create</code> действия (<a class="ref" href="sign-in-sign-out?version=3.0#code:signin_upon_signup">Листинг&nbsp;9.24</a>), как видно в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_update_action">Листинге&nbsp;10.9</a>.</p>

<div class="label" id="code:user_update_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.9.</span> <span class="description">Действие <code>update</code> пользователя. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated.&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit user&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>С этим кодом страница редактирования пользователя должна работать. Каждое редактирование требует от пользователя повторного подтверждения пароля (как следует из пустого текстового поля подтверждения на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:edit_user_settings">Рис.&nbsp;10.3</a>), что делает обновление более безопасным, но вызывающим незначительное раздражение.</p>

<div class="label" id="sec:protecting_pages"></div>


<h2><a id="sec:10.2" href="updating-showing-and-deleting-users?version=3.0#sec:protecting_pages" class="heading"><span class="number">10.2</span> Защита страниц</a></h2>



<p>Хотя edit и update действия из  <a class="ref" href="updating-showing-and-deleting-users?version=3.0#sec:updating_users">Раздела&nbsp;10.1</a> функционально завершены, они страдают от нелепой бреши в безопасности: они позволяют любым (даже незарегистрированным пользователям) иметь доступ к любому действию, и любой зарегистрированный пользователь может изменять информацию любого другого пользователя. В этом разделе мы реализуем модель безопасности, которая будет требовать от пользователей входа в систему и будет предотвращать обновление любой информации, кроме их собственной. Незарегистрированные пользователи, пытающиеся получить доступ к защищенным страницам будут перенаправлены на страницу входа с полезным сообщением, как показано на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:signin_page_protected_mockup">Рис.&nbsp;10.5</a>.</p>

<div class="label" id="fig:signin_page_protected_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_page_protected_mockup.png" alt="signin_page_protected_mockup" /></span></div><div class="caption"><span class="header">Рисунок  10.5: </span><span class="description">Макет результата посещения защищенной страницы&nbsp;<a href="http://railstutorial.org/images/figures/signin_page_protected_mockup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:requiring_signed_in_users"></div>


<h3><a id="sec:10.2.1" href="updating-showing-and-deleting-users?version=3.0#sec:requiring_signed_in_users" class="heading"><span class="number">10.2.1</span> Требование входа пользователей</a></h3>

<p>Поскольку ограничения безопасности для <code>edit</code> и <code>update</code> действий идентичны, мы будем обрабатывать их в одном  RSpec <code>describe</code> блоке. Начав с требования входа, наши первоначальные тесты затем проверяют, что не вошедшие пользователи, пытающиеся получить доступ к какому либо из действий, просто перенаправляеются на страницу входа, как показано в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:authentication_specs">Листинге&nbsp;10.10</a>.</p>

<div class="label" id="code:authentication_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.10.</span> <span class="description">Первые тесты для аутентификации. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authentication of edit/update pages&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should deny access to &#39;edit&#39;&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should deny access to &#39;update&#39;&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="p">{}</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Код приложения получит прохождение этих тестов используя <em>before filter</em>, который организует особый метод, который будет вызываться перед данным действием. В этом случае мы определим <code>authenticate</code> метод и вызовем его используя <code>before_filter :authenticate</code>, как показано в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:authenticate_before_filter">Листинге&nbsp;10.11</a>.</p>

<div class="label" id="code:authenticate_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.11.</span> <span class="description">Добавление предфильтра <code>authenticate</code>. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">authenticate</span>
      <span class="n">deny_access</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>По умолчанию предфильтр применяется к <em>каждому</em> действию в контроллере, поэтому здесь мы ограничим действие фильтра только <code>:edit</code> и <code>:update</code> действиями передачей хэша опций <code>:only</code>.</p>

<p>Этот код пока не будет работать, так как <code>deny_access</code> не был определен. Поскольку отказ в доступе является частью аутентификации, мы поместим его в хелпер Sessions из <a class="ref" href="sign-in-sign-out?version=3.0#top">Главы&nbsp;9</a>. Все что <code>deny_access</code> делает, это выводит сообщение <code>flash[:notice]</code>, а затем перенаправляет на страницу входа (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:deny_access">Листинг&nbsp;10.12</a>).</p>

<div class="label" id="code:deny_access"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.12.</span> <span class="description">Метод <code>deny_access</code> для аутентификации пользователей.<br /> <code>app/helpers/sessions_helper.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">deny_access</span>
    <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Please sign in to access this page.&quot;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Отметим здесь, что <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:deny_access">Листинг&nbsp;10.12</a> использует сокращение для установки <code>flash[:notice]</code> передавая хэш опций функции <em>redirect_to</em>. Код в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:deny_access">Листинге&nbsp;10.12</a> эквивалентен более подробному</p>

<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Please sign in to access this page.&quot;</span>
<span class="n">redirect_to</span> <span class="n">signin_path</span>
</pre></div>
</div>


<p>(Аналогичная конструкция работает для ключа <code>:error</code>, но не для <code>:success</code>.)</p>

<p>Вместе с <code>:success</code> и <code>:error</code>, <code>:notice</code> ключ завершает наш триумвират <code>flash</code> стилей, каждый из которых имеет встроенную поддержку Blueprint CSS. Выйдя из системы и попытавшись получить доступ к странице редактирования пользователя <a href="http://localhost:3000/users/1/edit"><tt>/users/1/edit</tt></a>, мы  в результате увидим желтый <code>"notice"</code> блок, как показано на  <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:protected_sign_in">Рис.&nbsp;10.6</a>.</p>

<div class="label" id="fig:protected_sign_in"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/protected_sign_in.png" alt="protected_sign_in" /></span></div><div class="caption"><span class="header">Рисунок  10.6: </span><span class="description">Форма входа после попытки доступа к защищенной странице.&nbsp;<a href="http://railstutorial.org/images/figures/protected_sign_in-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:requiring_the_right_user"></div>


<h3><a id="sec:10.2.2" href="updating-showing-and-deleting-users?version=3.0#sec:requiring_the_right_user" class="heading"><span class="number">10.2.2</span> Требование правильного пользователя</a></h3>

<p>Конечно, требования входа пользователей недостаточно; пользователи должны иметь доступ к редактированию <em>только</em> своей информации. Мы можем протестировать это, вначале войдя как неправильный пользователь, а затем обратившись к <code>edit</code> и <code>update</code> действиям (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:authentication_for_signed_in">Листинг&nbsp;10.13</a>). Обратите внимание, что, так как пользователи никогда не должны даже <em>пытаться</em> изменить профиль другого пользователя, мы сделаем переадресацию не на страницу входа, а на корневой URL.</p>

<div class="label" id="code:authentication_for_signed_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.13.</span> <span class="description">Аутентификационный тест для вошедших пользователей. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authentication of edit/update pages&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">wrong_user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.net&quot;</span><span class="p">)</span>
        <span class="n">test_sign_in</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should require matching users for &#39;edit&#39;&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should require matching users for &#39;update&#39;&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="p">{}</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Код приложения прост: мы добавим второй предфильтр к вызову <code>correct_user</code> метода (который мы должны написать), как показано в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:correct_user_before_filter">Листинге&nbsp;10.14</a>.</p>

<div class="label" id="code:correct_user_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.14.</span> <span class="description">Предфильтр <code>correct_user</code> для защиты edit/update страниц. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit user&quot;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">authenticate</span>
      <span class="n">deny_access</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Этот код использует <code>current_user?</code> метод, который (как и <code>deny_access</code>) мы определяем в хелпере Sessions (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:current_user_p">Листинг&nbsp;10.15</a>).</p>

<div class="label" id="code:current_user_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.15.</span> <span class="description">Метод <code>current_user?</code>. <br /> <code>app/helpers/sessions_helper.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">deny_access</span>
    <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Please sign in to access this page.&quot;</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:correct_user_before_filter">Листинг&nbsp;10.14</a> также показывает обновленное <code>edit</code> действие. Ранее, в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:initial_edit_action">Листинге&nbsp;10.2</a>, мы имели</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit user&quot;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>но теперь, когда предфильтр <code>correct_user</code>  определяет <code>@user</code>, мы можем опустить его в <code>edit</code> действии (равно как и в <code>update</code> действии).</p>

<div class="label" id="sec:friendly_forwarding"></div>


<h3><a id="sec:10.2.3" href="updating-showing-and-deleting-users?version=3.0#sec:friendly_forwarding" class="heading"><span class="number">10.2.3</span> Дружелюбная переадресация</a></h3>

<p>Защита наших страниц закончена, как и было написано, но есть один небольшой недостаток: когда пользователи пытаются получить доступ к защищенной странице, они перенаправляются к странице профиля, независимо от того, куда они пытались попасть. Другими словами, если не залогинившийся пользователь пытается посетить страницу редактирования, после входа пользователь будет перенаправлен на <tt>/users/1</tt> вместо <tt>/users/1/edit</tt>. Было бы намного более доброжелательно, по отношению к пользователям, все же перенаправлять их на запрашиваемую страницу вместо этого .</p>

<p>Очередность посещения страниц, вход, и переадресация на требуемую страницу, это идеальная работа для интеграционного теста, так что давайте сделаем его для дружественной переадресации:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test friendly_forwarding
</pre></div>
</div>


<p>Последующий код выглядит как в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:friendly_forwarding_test">Листинге&nbsp;10.16</a>.</p>

<div class="label" id="code:friendly_forwarding_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.16.</span> <span class="description">Интеграционный тест для дружеской переадресации. <br /> <code>spec/requests/friendly_forwardings_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;FriendlyForwardings&quot;</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">&quot;should forward to the requested page after signin&quot;</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># The test automatically follows the redirect to the signin page.</span>
    <span class="n">fill_in</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">fill_in</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
    <span class="n">click_button</span>
    <span class="c1"># The test follows the redirect again, this time to users/edit.</span>
    <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;users/edit&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Как отмечено в комментарии, интеграционный тест <em>follows</em> redirects (# переходит на страницу к которой ведет переадресация), поэтому тестирование того, что ответ <code>should redirect_to</code> (# должен перенаправлять_к) некоторому URL - не будет работать. Это знание мне дорогого стоило.)</p>

<p>Теперь реализация.<sup class="footnote" id="fnref:10.5"><a href="?version=3.0#fn:10.5">5</a></sup> Для того чтобы перенаправить пользователей к запрашиваемой ими странице, нам нужно где-то сохранить запрашиваемую страницу, а затем переадресовать к ней. Хранение будет осуществляться посредством <code>session</code> - объекта, предоставляемого Rails, о котором вы можете думать как об экземпляре переменной <code>cookies</code> из <a class="ref" href="sign-in-sign-out?version=3.0#sec:remember_me">Раздела&nbsp;9.3.2</a>, которая автоматически истекает при закрытии браузера.<sup class="footnote" id="fnref:10.6"><a href="?version=3.0#fn:10.6">6</a></sup> Мы также используем <code>request</code> объект для получения <code>fullpath</code>, т.е. полный адрес запрашиваемой страницы. Результирующий код приложения показан в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:friendly_forwarding_code">Листинге&nbsp;10.17</a>.</p>

<div class="label" id="code:friendly_forwarding_code"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.17.</span> <span class="description">Код реализующий дружественную переадресацию. <br /> <code>app/helpers/sessions_helper.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">deny_access</span>
    <span class="n">store_location</span>
    <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Please sign in to access this page.&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">clear_return_to</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">store_location</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">fullpath</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">clear_return_to</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Здесь мы добавили строку к методу <code>deny_access</code>, сохраняющую полный путь запроса с помощью <code>store_location</code> перед дальнейшим выполнением кода. Метод <code>store_location</code> помещает запрашиваемый URL в переменную <code>session</code> под ключом <code>:return_to</code>. (Мы сделали методы <code>store_location</code> и <code>clear_return_to</code> приватными так как они никогда не понадобятся за пределами хелпера Sessions.)</p>

<p>Мы также определили метод <code>redirect_back_or</code> для запрашиваемого URL если он существует, или какого либо дефолтного URL в противном случае. Этот метод необходим в <code>create</code> действии контроллера Sessions для переадресации после успешного входа (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:friendly_session_create">Листинг&nbsp;10.18</a>).</p>

<div class="label" id="code:friendly_session_create"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.18.</span> <span class="description">Действие  <code>create</code> контроллера  Sessions с доброжелательной переадресацией. <br /> <code>app/controllers/sessions_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span>
                             <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Invalid email/password combination.&quot;</span>
      <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">else</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_back_or</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>С этим тест доброжелательной переадресации из <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:friendly_forwarding_test">Листинга&nbsp;10.16</a> должен пройти, и базовую аутентификацию пользователей можно считать законченной.</p>

<div class="label" id="sec:showing_users"></div>


<h2><a id="sec:10.3" href="updating-showing-and-deleting-users?version=3.0#sec:showing_users" class="heading"><span class="number">10.3</span> Просмотр всех пользователей сайта</a></h2>

<p>В этом разделе мы добавим предпоследнее user действие <code>index</code>, которое предназначено для отображения <em>всех</em> пользователей, а не одного из них. По пути, мы узнаем о наполнении базы данных образцами пользователей и <em>пагинации (разбиения на страницы)</em> вывода пользователей, таким образом index страница может быть масштабирована для отображения потенциально большого количества пользователей. Макет результата&nbsp;&mdash;&nbsp;пользователи, постраничные ссылки, и &ldquo;Users&rdquo; навигационная ссылка&nbsp;&mdash;&nbsp;представлены на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:user_index_mockup">Рис.&nbsp;10.7</a>.<sup class="footnote" id="fnref:10.7"><a href="?version=3.0#fn:10.7">7</a></sup> В <a class="ref" href="updating-showing-and-deleting-users?version=3.0#sec:destroying_users">Разделе&nbsp;10.4</a>, мы также добавим административный интерфейс к user index таким образом (предположительно проблемные) пользователи смогут быть удалены.</p>

<div class="label" id="fig:user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_mockup.png" alt="user_index_mockup" /></span></div><div class="caption"><span class="header">Рисунок  10.7: </span><span class="description">Макет user index, с пагинацией и  &ldquo;Users&rdquo; навигационной ссылкой.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_mockup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:user_index"></div>


<h3><a id="sec:10.3.1" href="updating-showing-and-deleting-users?version=3.0#sec:user_index" class="heading"><span class="number">10.3.1</span> Список пользователей</a></h3>

<p>Хотя мы сохраним страницы <code>show</code> отдельных пользователей видимыми для всех посетителей сайта, для страницы user <code>index</code> будет реализовано ограничение, отображающее ее только для зарегистрированных пользователей, также будет реализовано ограничение того, сколько зарегистрированных пользователей будет отображаться на каждой странице списка. Наши <code>index</code> тесты проконтролируют это, а также проверят, что все зарегистрированные пользователи попали в список  (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_index_tests">Листинг&nbsp;10.19</a>).</p>

<div class="label" id="code:user_index_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.19.</span> <span class="description">Тесты для страницы user index.<br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;index&#39;&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;should deny access&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/sign in/i</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
        <span class="n">second</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;another@example.com&quot;</span><span class="p">)</span>
        <span class="n">third</span>  <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ben&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;another@example.net&quot;</span><span class="p">)</span>

        <span class="vi">@users</span> <span class="o">=</span> <span class="o">[</span><span class="vi">@user</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;All users&quot;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should have an element for each user&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Как вы можете видеть, метод проверки index страницы делает три "фабричных" пользователя (вошедших, как и первый из них), а затем проверяет что страница  index содержит тег элемента списка (<code>li</code>) для имени каждого из них. Обратите внимание, что мы позаботились о том, чтобы дать пользователям различные имена, чтобы каждый элемент в списке пользователей имел уникальную запись.</p>

<p>Как и ожидалось, код приложения использует <code>User.all</code> для создания переменной экземпляра <code>@users</code> в  <code>index</code> действии контроллера Users (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_index">Листинг&nbsp;10.20</a>).</p>

<div class="label" id="code:user_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.20.</span> <span class="description">Действие <code>index</code> контроллера Users. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;All users&quot;</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание, что мы добавили <code>:index</code> к списку действий контроллера, защищаемых <code>authenticate</code> предфильтром, тем самым получив прохождение первого теста из <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_index_tests">Листинга&nbsp;10.19</a>.</p>

<p>Для того, чтобы на самом деле создать страницу, нам необходимо создать представление, которое перебирает всех пользователей и обертывает каждого из них в тег&nbsp;<code>li</code>. Мы сделаем это с помощью метода <code>each</code>, отображающего Gravatar и имя каждого пользователя, в то время как сам он будет завернут в тег ненумерованного списка (<code>ul</code>) (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_index_view">Листинг&nbsp;10.21</a>).</p>

<div class="label" id="code:user_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.21.</span> <span class="description">Представление для страницы user index. <br /> <code>app/views/users/index.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div></div>


<p>Затем мы добавим немного CSS (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_index_css">Листинг&nbsp;10.22</a>).</p>

<div class="label" id="code:user_index_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.22.</span> <span class="description">CSS для страницы user index. <br /> <code>public/stylesheets/custom.css</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="nt">ul</span><span class="nc">.users</span> <span class="p">{</span>
  <span class="k">margin-top</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.users</span> <span class="nt">li</span> <span class="p">{</span>
  <span class="k">list-style</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>Наконец мы добавим &ldquo;Users&rdquo; ссылку в навигационное меню шапки сайта (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:users_link">Листинг&nbsp;10.23</a>). Этот код использует именованый маршрут <code>users_path</code> из <a class="ref" href="modeling-and-viewing-users-one?version=3.0#table:RESTful_users">Таблицы&nbsp;6.2</a>.</p>

<div class="label" id="code:users_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.23.</span> <span class="description">Ссылка в шаблоне для страницы user index. <br /> <code>app/views/layouts/_header.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">logo</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>С этим кодом мы получили полнофункциональную страницу user index (со всеми проходящими тестами), но она выглядит несколько&hellip; безлюдно (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:user_index_only_one">Рис.&nbsp;10.8</a>).</p>

<div class="label" id="fig:user_index_only_one"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_only_one.png" alt="user_index_only_one" /></span></div><div class="caption"><span class="header">Рисунок  10.8: </span><span class="description">Страница user index  <a href="http://localhost:3000/users"><tt>/users</tt></a> с одним пользователем.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_only_one-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:sample_users"></div>


<h3><a id="sec:10.3.2" href="updating-showing-and-deleting-users?version=3.0#sec:sample_users" class="heading"><span class="number">10.3.2</span> Образцы пользователей</a></h3>

<p>В этом разделе мы дадим нашему одинокому образцу пользователя небольшую компанию. Конечно, чтобы создать достаточное количество пользователей, мы <em>могли бы</em>, использовать наш веб-браузер, для посещения страницы регистрации и создания новых пользователей по одному, но куда более продвинутым решением является использование Ruby (и Rake), чтобы сделать пользователей для нас.</p>

<p>Во-первых, мы добавим <a  href="http://lingvo.yandex.ru/faker/">Faker</a> гем в <code>Gemfile</code>, который позволит нам делать образцы пользователей с полу-реалистичными именами и адресами электронной почты (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:faker_gemfile">Листинг&nbsp;10.24</a>).</p>

<div class="label" id="code:faker_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.24.</span> <span class="description">Добавление Faker гема в <code>Gemfile</code>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.6.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate&#39;</span><span class="p">,</span> <span class="s1">&#39;2.4.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3.1&#39;</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Затем установите как обычно:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle
</pre></div>
</div>


<p>Далее мы добавим Rake-задачу для создания образцов пользователей. Rake задачи живут в <code>lib/tasks</code>, и определяются с помощью  <em>пространства имен</em> (в даном случае, <code>:db</code>), как видно в  <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:db_populate">Листинге&nbsp;10.25</a>.</p>

<div class="label" id="code:db_populate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.25.</span> <span class="description">Rake задача для заполнения базы данных образцами пользователей. <br /> <code>lib/tasks/sample_data.rake</code></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="ss">Rake::Task</span><span class="o">[</span><span class="s1">&#39;db:reset&#39;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                 <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                 <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                 <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker::Name</span><span class="o">.</span><span class="n">name</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org&quot;</span>
      <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
      <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="nb">name</span><span class="p">,</span>
                   <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">,</span>
                   <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">password</span><span class="p">,</span>
                   <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Этот код определяет задачу <code>db:populate</code> которая перезагружает development базу данных используя <code>db:reset</code> (с использованием немного странного синтаксиса, который не должен вас сильно тревожить), затем создает пример пользователя с именем и адресом электронной почты, делая реплику нашего предыдущего пользователя, после чего делает еще 99 экземпляров. Строка</p>

<div class="code"><div class="highlight"><pre><span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</pre></div>
</div>


<p>обеспечивает Rake задаче доступ к локальному Rails окружению, включая модель User (и, следовательно, к <code>User.create!</code>).</p>

<p>С пространством имен <code>:db</code> как в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:db_populate">Листинге&nbsp;10.25</a>, мы можем вызвать Rake задачу следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
</pre></div>
</div>

<p>После запуска Rake задачи, наше приложениее имеет 100 примеров пользователей, как видно в  <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:user_index_all">Рис.&nbsp;10.9</a>. (Я взял на себя смелость связать первые несколько образцов адресов  с фотографиями так что не все изображения являются дефолтными картинками Gravatar.)</p>
<div class="label" id="fig:user_index_all"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_all.png" alt="user_index_all" /></span></div><div class="caption"><span class="header">Рисунок  10.9: </span><span class="description">Страница user index   <a href="http://localhost:3000/users"><tt>/users</tt></a> с 100 образцов пользователей.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_all-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:pagination"></div>


<h3><a id="sec:10.3.3" href="updating-showing-and-deleting-users?version=3.0#sec:pagination" class="heading"><span class="number">10.3.3</span> Пагинация</a></h3>

<p>Решив проблему слишком малого количества образцов пользователей, мы столкнулись с противоположной проблемой: наличие слишком большого числа пользователей на странице. Сейчас их сто, что уже достаточно большое число, а на реальном сайте это могут быть и тысячи. Решение заключается в <em>пагинации (разбиении на страницы, постраничном выводе)</em> пользователей, так, чтобы (например) показывать только 30 на каждой странице одновременно.</p>

<p>В Rails есть несколько способов разбиения на страницы, мы будем использовать один из самых простых и надежных, он называется <a href="http://wiki.github.com/mislav/will_paginate/"><tt>will_paginate</tt></a>. Для его использования, нам, как обычно, необходимо обновить <code>Gemfile</code> (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:will_paginate_gem">Листинг&nbsp;10.26</a>). Вам также следует рестартовать веб-сервер для того чтобы <tt>will_paginate</tt> гарантированно загрузился как следует.</p>

<div class="label" id="code:will_paginate_gem"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.26.</span> <span class="description">Включение <tt>will_paginate</tt> в Gemfile.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.12&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;gravatar_image_tag&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.0.pre2&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.pre2&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Затем <code>bundle</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle
</pre></div>
</div>


<p>С установленным <tt>will_paginate</tt> мы готовы разбивать на страницы результаты поиска пользователей. Мы начнем с добавления специального метода <code>will_paginate</code> в представление (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:will_paginate_index_view">Листинг&nbsp;10.27</a>); через мгновение мы увидим, почему код появился выше и ниже списка пользователей.</p>

<div class="label" id="code:will_paginate_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.27.</span> <span class="description">Список пользователей с пагинацией. <br /> <code>app/views/users/index.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Метод <code>will_paginate</code> немного волшебный; внутри представления <code>users</code>, он автоматически ищет объект <code>@users</code>, а затем отображает пагинационные ссылки для доступа к остальным страницам. Представление в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:will_paginate_index_view">Листинге&nbsp;10.27</a> пока не работает, из-за того что на данный момент <code>@users</code> содержит результаты <code>User.all</code> (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_index">Листинг&nbsp;10.20</a>), которые принадлежат классу Массив, в то время как <code>will_paginate</code> ожидает объект класса <code>WillPaginate::Collection</code>. К счастью, это всего лишь вид объекта, возвращаемого методом <code>paginate</code> поставляемого гемом <tt>will_paginate</tt>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Array</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; WillPaginate::Collection</span>
</pre></div>
</div>


<p>Обратите внимание, что <code>paginate</code> принимает в качестве аргумента хэш с ключом <code>:page</code> и значением, равным запрашиваемой странице. <code>User.paginate</code> вытягивает пользователей из базы данных по одному куску за раз (30 по умолчанию), основываясь на параметре <code>:page</code>. Так, например, стр.&nbsp;1 содержит пользователей с 1 по 30, стр.&nbsp;2 это пользователи 31&ndash;60, и т.д..</p>

<p>Мы можем разбить список пользователей на страницы в примере приложения, используя <code>paginate</code> вместо <code>all</code> в <code>index</code> действии (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:will_paginate_index_action">Листинг&nbsp;10.28</a>). Здесь <code>:page</code> параметр приходит из <code>params[:page]</code>, который <code>will_paginate</code> сгенерировал автоматически.</p>

<div class="label" id="code:will_paginate_index_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.28.</span> <span class="description">Пагинация пользователей в <code>index</code> действии. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;All users&quot;</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Страница user index теперь должна работать как представлено на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:user_index_pagination_rails_3">Рис.&nbsp;10.10</a>. (На некоторых системах вам может потребоваться рестарт Rails-сервера в этой точке.) Так как мы включили <code>will_paginate</code> сверху и снизу списка пользователей, ссылки на страницы появились в обоих местах.</p>

<div class="label" id="fig:user_index_pagination_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_pagination_rails_3.png" alt="user_index_pagination_rails_3" /></span></div><div class="caption"><span class="header">Рисунок  10.10: </span><span class="description">Страница user index   <a href="http://localhost:3000/users"><tt>/users</tt></a> с пагинацией.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_pagination_rails_3-full.png">(полный размер)</a></span></div></div>


<p>Если теперь кликнуть по любой&nbsp;<a href="http://localhost:3000/users?page=2">2</a> или <a href="http://localhost:3000/users?page=2">Next</a> ссылке, вы получите вторую страницу с результатами, как это показано на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:user_index_page_two_rails_3">Рис.&nbsp;10.11</a>.</p>

<div class="label" id="fig:user_index_page_two_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_page_two_rails_3.png" alt="user_index_page_two_rails_3" /></span></div><div class="caption"><span class="header">Рисунок  10.11: </span><span class="description">Страница 2 списка пользователей (<a href="http://localhost:3000/users?page=2"><tt>/users?page=2</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/user_index_page_two_rails_3-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:testing_pagination"></div>


<h4><a id="sec:10.3.3.1" href="updating-showing-and-deleting-users?version=3.0#sec:testing_pagination" class="heading">Тестирование пагинации</a></h4>


<p>Тестирование пагинации требует детального знания принципов работы <tt>will_paginate</tt>, поэтому мы вначале сделали реализацию, но ее тестирование все еще хорошая идея. Для того, чтобы сделать это, нам необходимо вызвать пагинацию в тесте, что подразумевает создание более чем 30 (сфабрикованных) пользователей.</p>

<p>Как и прежде, мы будем использовать Factory Girl для имитации пользователей, но мы тут же натыкаемся на проблему: адреса электронной почты пользователей должны быть уникальными, что, как представляется, требует создания более чем 30 пользователей вручную&nbsp;&mdash;&nbsp;ужасно муторная работа. К счастью, Factory Girl предвидела этот вопрос, и обеспечила <em>последовательность (цикл)</em> для ее решения, как показано в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:factory_sequence">Листинге&nbsp;10.29</a>.</p>

<div class="label" id="code:factory_sequence"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.29.</span> <span class="description">Определение последовательности (цикла) Factory Girl. <br /> <code>spec/factories.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="no">Factory</span><span class="o">.</span><span class="n">define</span> <span class="ss">:user</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">user</span><span class="o">.</span><span class="n">name</span>                  <span class="s2">&quot;Michael Hartl&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">email</span>                 <span class="s2">&quot;mhartl@example.com&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password</span>              <span class="s2">&quot;foobar&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
<span class="k">end</span>

<span class="no">Factory</span><span class="o">.</span><span class="n">sequence</span> <span class="ss">:name</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="no">Factory</span><span class="o">.</span><span class="n">sequence</span> <span class="ss">:email</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="s2">&quot;person-</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Это организует возвращение адреса электронной почты, вида <code>person-1@example.com</code>, <code>person-2@example.com</code>, и т.д., которые мы вызываем используя метод <code>next</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
</pre></div>
</div>

<p>Обратите внимание: <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:factory_sequence">Листинг&nbsp;10.29</a> также добавляет аналогичную последовательность для создания уникальных пользовательских имен.</p>

<p>Применяя идею фабричных последовательностей (циклов), мы можем сделать 31 пользователя (исходный <code>@user</code> плюс еще 30) внутри теста, а затем проверить, что ответ имеет HTML, ожидаемый от  <tt>will_paginate</tt> (который вы должны суметь определить с помощью Firebug или просмотра исходного кода страницы). Результат показан в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:will_paginate_test">Листинге&nbsp;10.30</a>.</p>

<div class="label" id="code:will_paginate_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.30.</span> <span class="description">Тест для пагинации. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;UsersController&quot;</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;index&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="vi">@users</span> <span class="o">=</span> <span class="o">[</span><span class="vi">@user</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="o">]</span>
        <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
          <span class="vi">@users</span> <span class="o">&lt;&lt;</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span>
                                   <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">it</span> <span class="s2">&quot;should have an element for each user&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="vi">@users</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should paginate users&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div.pagination&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;span.disabled&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Previous&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="s2">&quot;/users?page=2&quot;</span><span class="p">,</span>
                                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="s2">&quot;/users?page=2&quot;</span><span class="p">,</span>
                                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Next&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Этот код обеспечивает вызов тестами пагинации, добавлением 30<sup class="footnote" id="fnref:10.8"><a href="?version=3.0#fn:10.8">8</a></sup> пользователей в переменную <code>@users</code> используя <code>Array</code> push нотацию&nbsp;<code>&lt;&lt;</code>, которая добавляет элемент в существующий массив:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 5]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span>
<span class="go">=&gt; [1, 2, 5, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">42</span> <span class="o">&lt;&lt;</span> <span class="mi">1337</span>
<span class="go">=&gt; [1, 2, 5, 17, 42, 1337]</span>
</pre></div>
</div>


<p>Как видно из последнего примера, вхождения&nbsp;<code>&lt;&lt;</code> могут быть объединены. В самом тесте обратите внимание на компактную запись <code>have_selector("div.pagination")</code>, которая заимствует конвенцию классов из CSS (впервые виденную в <a class="ref" href="filling-in-the-layout?version=3.0#code:header_content">Листинге&nbsp;5.3</a>) для проверки <code>div</code> тега с классом <code>pagination</code>. Также отметим, что, поскольку на данный момент существует 33 пользователя, мы обновили элемент user теста для использования только первых трех элементов (<code>[0..2]</code>) массива <code>@users</code>, которые мы имели в своем распоряжении в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_index_tests">Листинге&nbsp;10.19</a>:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@users</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>С этим наш код пагинации хорошо протестирован, и, как мы увидим в следующем разделе, осталась лишь одна важная деталь. </p>

<div class="label" id="sec:partial_refactoring"></div>


<h3><a id="sec:10.3.4" href="updating-showing-and-deleting-users?version=3.0#sec:partial_refactoring" class="heading"><span class="number">10.3.4</span> Частичный рефакторинг</a></h3>

<p>Разбитый на страницы список пользователей теперь закончен, но есть одно улучшение, от которого я не могу удержаться: Rails имеет несколько невероятно ловких инструментов для создания компактных представлений, и в этом разделе мы займемся рефакторингом страницы со списком пользователей, используя эти инструменты. Так как наш код хорошо протестирован, мы можем с уверенностью приступить к рефакторингу, будучи уверенными в том, что мы вряд ли нарушим функциональность сайта. </p>

<p>Первым шагом нашего рефакторинга будет замена пользовательского&nbsp;<code>li</code> из <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:will_paginate_index_view">Листинга&nbsp;10.27</a> вызовом <code>render</code>  (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:index_view_first_refactoring">Листинг&nbsp;10.31</a>).</p>

<div class="label" id="code:index_view_first_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.31.</span> <span class="description">Первая попытка рефакторинга в index представлении.<br /> <code>app/views/users/index.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Здесь мы вызываем  <code>render</code> не на строку с именем партиала, а на перемнную <code>user</code> класса <code>User</code>;<sup class="footnote" id="fnref:10.9"><a href="?version=3.0#fn:10.9">9</a></sup> в этом контексте, Rails автоматически ищет партиал с названием <code>_user.html.erb</code>, который мы должны создать (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_partial">Листинг&nbsp;10.32</a>).</p>

<div class="label" id="code:user_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.32.</span> <span class="description">Партиал для отображения отдельно взятого пользователя. <br /> <code>app/views/users/_user.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>Это явное улучшение, но мы можем сделать еще лучше: мы можем вызвать <code>render</code> <em>непосредственно</em> на переменную  <code>@users</code> (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:index_final_refactoring">Листинг&nbsp;10.33</a>).</p>

<div class="label" id="code:index_final_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.33.</span> <span class="description">Полностью реорганизованный список пользователей. <br /> <code>app/views/users/index.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Здесь Rails делает вывод, что <code>@users</code> это список объектов <code>User</code>; кроме того, при вызове с коллекцией пользователей, Rails автоматически перебирает их и отображает каждого из них с помощью партиала <code>_user.html.erb</code>. Результатом служит впечатляюще компактный код <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:index_final_refactoring">Листинга&nbsp;10.33</a>.</p>

<div class="label" id="sec:destroying_users"></div>


<h2><a id="sec:10.4" href="updating-showing-and-deleting-users?version=3.0#sec:destroying_users" class="heading"><span class="number">10.4</span> Уничтожение пользователей</a></h2>

<p>Теперь, когда список пользователей завершен, осталось лишь одно каноничное REST действие: <code>destroy</code>. В этом разделе мы добавим ссылки для удаления пользователей, как показано в макете на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:user_index_delete_links_mockup">Рис.&nbsp;10.12</a>, и определим <code>destroy</code> действие необходимое для выполнения удаления. Но мы начнем с создания класса уполномоченных на это административных пользователей.</p>


<div class="label" id="fig:user_index_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_delete_links_mockup.png" alt="user_index_delete_links_mockup" /></span></div><div class="caption"><span class="header">Рисунок  10.12: </span><span class="description">Макет списка пользователей с удаляющими ссылками.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_delete_links_mockup-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:administrative_users"></div>


<h3><a id="sec:10.4.1" href="updating-showing-and-deleting-users?version=3.0#sec:administrative_users" class="heading"><span class="number">10.4.1</span> Административные пользователи</a></h3>


<p>Мы будем идентифицировать привилегированных пользователей с правами администратора посредством булевого атрибута <code>admin</code> в модели User, что, как мы увидим, автоматически приведет нас к методу <code>admin?</code> для проверки административного статуса. Мы можем написать тесты для этого атрибута, как в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:admin_specs">Листинге&nbsp;10.34</a>.</p>

<div class="label" id="code:admin_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.34.</span> <span class="description">Тесты для атрибута <code>admin</code>. <br /> <code>spec/models/user_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;admin attribute&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should respond to admin&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not be an admin by default&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_admin</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be convertible to an admin&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_admin</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Здесь мы использовали метод <code>toggle!</code> для изменения атрибута <code>admin</code> от <code>false</code> к <code>true</code>. Отметим также, что строка</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_admin</span>
</pre></div>
</div>


<p>подразумевает (через булеву конвенцию RSpec), что пользователь должен иметь булев метод <code>admin?</code>.</p>

<p>Мы добавим атрибут <code>admin</code> как обычно, посредством миграции, указав тип <code>boolean</code> в командной строке:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div>
</div>


<p>Миграция просто добавляет столбец <code>admin</code> к таблице <code>users</code> (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:admin_migration">Листинг&nbsp;10.35</a>), приводя к модели данных показанной на <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:user_model_admin">Рис.&nbsp;10.13</a>.</p>

<div class="label" id="code:admin_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.35.</span> <span class="description">Миграция для добавления булевого атрибута <code>admin</code> к пользователям. <br /> <code>db/migrate/&lt;timestamp&gt;_add_admin_to_users.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание на то, что мы добавили аргумент <code>:default =&gt; false</code> к <code>add_column</code> в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:admin_migration">Листинге&nbsp;10.35</a>, что означает, что пользователи <em>не являются</em> администраторами по умолчанию. (Без <code>:default =&gt; false</code> аргумента, <code>admin</code> был бы по умолчанию <code>nil</code>, который по-прежнему <code>false</code>, так что этот шаг не является строго обязательным. Это более явно и четко сообщает о наших  намерениях, и Rails, и читателям нашего кода.)</p>

<div class="label" id="fig:user_model_admin"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_admin.png" alt="user_model_admin" /></span></div><div class="caption"><span class="header">Рисунок  10.13: </span><span class="description">Модель User с добавленным булевым атрибутом  <code>admin</code>.</span></div></div>


<p>Наконец, мы мигрируем базу данных разработки и подготавливаем тестовую бд:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>Как и ожидалось, Rails догадывается о булевом характере атрибута <code>admin</code> и автоматически добавляет метод со знаком вопроса <code>admin?</code>:<sup class="footnote" id="fnref:10.10"><a href="?version=3.0#fn:10.10">10</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>В качестве последнего шага, давайте обновим наш заполнитель образцов данных для того, чтобы сделать первого пользователя администратором (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:populator_with_admin">Листинг&nbsp;10.36</a>).</p>

<div class="label" id="code:populator_with_admin"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.36.</span> <span class="description">Код заполнителя образцов данных для создания административного пользователя. <br /> <code>lib/tasks/sample_data.rake</code></span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="ss">Rake::Task</span><span class="o">[</span><span class="s1">&#39;db:reset&#39;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                         <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                         <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                         <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Наконец, перезапустим заполнитель для перезагрузки базы данных и последующей перестройки ее с нуля:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
</pre></div>
</div>


<div class="label" id="sec:revisiting_attr_accessible"></div>


<h4><a id="sec:10.4.1.1" href="updating-showing-and-deleting-users?version=3.0#sec:revisiting_attr_accessible" class="heading">Возвращение к  <code>attr_accessible</code></a></h4>



<p>Вы могли заметить, что <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:populator_with_admin">Листинг&nbsp;10.36</a> делает пользователя администратором с помощью <code>toggle!(:admin)</code>, но почему бы просто не добавить <code>:admin =&gt; true</code> к хэшу инициализации? Ответ прост&nbsp;&mdash;&nbsp;это не будет работать, и это является его особенностью: только <code>attr_accessible</code> атрибуты могут быть назначены через массовое назначение, а атрибут <code>admin</code> не является доступным. <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:attr_accessible_review">Листинг&nbsp;10.37</a> воспроизводит последний список <code>attr_accessible</code> атрибутов&nbsp;&mdash;&nbsp;обратите внимание на то, что <code>:admin</code> <em>не присутствует</em> в списке.</p>

<div class="label" id="code:attr_accessible_review"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.37.</span> <span class="description"><code>attr_accessible</code> атрибуты модели User <em>без</em> атрибута <code>:admin</code>.  <br /> <code>app/models/user.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:password</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Явное определение доступных атрибутов имеет решающее значение для хорошей безопасности сайта. Если бы мы опустили список <code>attr_accessible</code> в модели User (или безрассудно добавили бы в список <code>:admin</code>), злоумышленник мог бы послать запрос <tt>PUT</tt> следующим образом:<sup class="footnote" id="fnref:10.11"><a href="?version=3.0#fn:10.11">11</a></sup></p>

<div class="code"><div class="highlight"><pre>put /users/17?admin=1
</pre></div>
</div>


<p>Этот запрос сделал бы администратором пользователя 17, что могло бы стать потенциально серьезной брешью в безопасности, если не сказать больше.  Из-за этой опасности, хорошей практикой является определение <code>attr_accessible</code> для каждой модели.</p>

<div class="label" id="sec:the_destroy_action"></div>


<h3><a id="sec:10.4.2" href="updating-showing-and-deleting-users?version=3.0#sec:the_destroy_action" class="heading"><span class="number">10.4.2</span> <code>Destroy</code> действие</a></h3>

<p>Последний шаг, необходимый для завершения ресурса Users, заключается в добавлении удаляющих ссылок и <code>destroy</code> действия. Мы начнем с добавления удаляющей ссылки для каждого пользователя на страницу со списком пользователей  (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:delete_links">Листинг&nbsp;10.38</a>).</p>

<div class="label" id="code:delete_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.38.</span> <span class="description">Ссылки для удаления пользователей  (видимые только администраторам). <br /> <code>app/views/users/_user.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="cp">%&gt;</span>
  | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:confirm</span> <span class="o">=&gt;</span> <span class="s2">&quot;You sure?&quot;</span><span class="p">,</span>
                                <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s2">&quot;Delete </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>Обратите внимание на аргумент <code>:method =&gt; :delete</code>, который организует выдачу ссылками необходимого запроса <tt>DELETE</tt>. Мы также обернули каждую ссылку в&nbsp;<code>if</code> выражение, таким образом они видны только администраторам. Результат, видимый нашим административным пользователям, представлен в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#fig:index_delete_links_rails_3">Рис.&nbsp;10.14</a>.</p>

<p>Изначально, веб браузеры не могут отправлять <tt>DELETE</tt> запросы, и  Rails подделывает их с помощью JavaScript.<sup class="footnote" id="fnref:10.12"><a href="?version=3.0#fn:10.12">12</a></sup> Поэтому, для того, чтобы получить рабочие удаляющие ссылки, мы должны включить дефолтные Rails JavaScript библиотеки, что мы сделаем, добавив строку</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="ss">:defaults</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>в шаблон сайта. Результат показан в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:adding_default_javascript">Листинг&nbsp;10.39</a>.</p>

<div class="label" id="code:adding_default_javascript"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.39.</span> <span class="description">Добавление дефолтных библиотек JavaScript в пример приложения. <br /> <code>app/views/layouts/application.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tag</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/stylesheets&#39;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="ss">:defaults</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:index_delete_links_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/index_delete_links_rails_3.png" alt="index_delete_links_rails_3" /></span></div><div class="caption"><span class="header">Рисунок  10.14: </span><span class="description">Список пользователей <a href="http://localhost:3000/users"><tt>/users</tt></a> с удаляющими ссылками.&nbsp;<a href="http://railstutorial.org/images/figures/index_delete_links_rails_3-full.png">(полный размер)</a></span></div></div>


<p>Даже несмотря на то, что только администраторы могут видеть ссылки на удаление, есть еще одна страшная дыра в безопасности: любой достаточно опытный злоумышленник может просто выдать запрос <tt>DELETE</tt> из командной строки и удалить любого пользователя на сайте. Для того, чтобы обеспечить безопасность сайта, мы также нуждаемся в контроле доступа, и наши тесты должны проверить не только то, что администраторы  <em>могут</em> удалять пользователей, но также и то, что другие пользователи <em>не могут</em> этого делать. Результаты представлены в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:destroy_tests">Листинге&nbsp;10.40</a>. Отметим, что, по аналогии с <code>get</code>, <code>post</code>, и <code>put</code> методами, мы используем <code>delete</code> для того, чтобы выдать запрос <tt>DELETE</tt> внутри теста.</p>

<div class="label" id="code:destroy_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.40.</span> <span class="description">Тесты для удаления пользователей. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;DELETE &#39;destroy&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;as a non-signed-in user&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;should deny access&quot;</span> <span class="k">do</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;as a non-admin user&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;should protect the page&quot;</span> <span class="k">do</span>
        <span class="n">test_sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;as an admin user&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;admin@example.com&quot;</span><span class="p">,</span> <span class="ss">:admin</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
        <span class="n">test_sign_in</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should destroy the user&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should redirect to the users page&quot;</span> <span class="k">do</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">users_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Вы могли заметить, что мы создали пользователя с правами администратора, используя <code>:admin =&gt; true</code>; фабрика пользователей не связана правилами <code>attr_accessible</code> параметров.) Отметим здесь, что метод <code>change</code> может принимать отрицательные значения, это означает, что, как мы убеждаемся в создании пользователя, тестируя изменение на +1  (<a class="ref" href="sign-up?version=3.0#code:signup_success_tests">Листинг&nbsp;8.14</a>), мы можем проверить удаление пользователя, тестируя изменение на -1:</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
<span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>Как вы можете догадаться, реализация использует предфильтр, в этот раз для ограничения доступа к <code>destroy</code> действию. <code>Destroy</code> действие самостоятельно находит пользователя, уничтожает его, а затем переадресует к списку пользователей (<a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:admin_destroy_before_filter">Листинг&nbsp;10.41</a>).</p>

<div class="label" id="code:admin_destroy_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.41.</span> <span class="description">Предфильтр, позволяющий иметь доступ к <code>destroy</code> действию только администраторам. <br /> <code>app/controllers/users_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:admin_user</span><span class="p">,</span>   <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;User destroyed.&quot;</span>
    <span class="n">redirect_to</span> <span class="n">users_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание, что <code>destroy</code> действие использует <em>цепочку методов</em> (кратко рассматривается в <a class="ref" href="rails-flavored-ruby?version=3.0#sec:objects_and_message_passing">Разделе&nbsp;4.2.3</a>) в строке</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>


<p>которая удерживает код в одной строке.</p>

<p>В этой точке все тесты должны проходить, и ресурс Users&nbsp;&mdash;&nbsp;со своим контроллером, моделью и представлением&nbsp;&mdash;&nbsp;функционально завершен.</p>

<h2><a id="sec:10.5" href="updating-showing-and-deleting-users?version=3.0#sec:10.5" class="heading"><span class="number">10.5</span> Заключение</a></h2>


<p>Мы прошли долгий путь с момента введения контроллера Users в <a class="ref" href="filling-in-the-layout?version=3.0#sec:user_signup">Разделе&nbsp;5.3</a>. Разделе&nbsp;5.3</a>. Те пользователи, даже не могли зарегистрироваться; теперь же пользователи могут зарегистрироваться, войти в систему, выйти, просматривать свои профили, редактировать их параметры, и видеть список всех пользователей, а некоторые из них могут даже удалять других пользователей.</p>

<p>Остальная часть этой книги будет опираться на ресурс Users (и связанную с ним аутентификационную систему) чтобы сделать сайт с  Twitter-подобными микросообщениями (<a class="ref" href="user-microposts?version=3.0#top">Глава&nbsp;11</a>) и следованием за пользователями (<a class="ref" href="following-users?version=3.0#top">Глава&nbsp;12</a>). Эти главы представят некоторые из наиболее мощных возможностей Rails, включая моделирование данных с <code>has_many</code> и <code>has_many :through</code>.</p>

<p>Прежде чем двигаться дальше, убедитесь, что объединили все изменения в мастер ветку:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish user edit, update, index, and destroy actions&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
</pre></div>
</div>


<p>Стоит также отметить, что в этой главе мы в последний раз имели необходимость в установке гема. Для справки, окончательный вариант <code>Gemfile</code> показан в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:final_gemfile">Листинге&nbsp;10.42</a>.</p>

<div class="label" id="code:final_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.42.</span> <span class="description">Окончательный вариант <code>Gemfile</code> для примера приложения.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.12&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;gravatar_image_tag&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.0.pre2&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.pre2&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.6.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate&#39;</span><span class="p">,</span> <span class="s1">&#39;2.4.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3.1&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.6.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;webrat&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;spork&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9.0.rc8&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:updating_deleting_exercises"></div>


<h2><a id="sec:10.6" href="updating-showing-and-deleting-users?version=3.0#sec:updating_deleting_exercises" class="heading"><span class="number">10.6</span> Упражнения</a></h2>




<ol>

<li>Организуйте открытие Gravatar ссылки &ldquo;change&rdquo; из <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:user_edit_view">Листинга&nbsp;10.3</a> в новом окне (или вкладке). <em>Подсказка:</em> Ищите в сети; вы должны найти один простой и надежный метод с участием так называмого <code>_blank</code>. </li>

<li>Удалите дублирующийся код формы рефакторингом <code>new.html.erb</code> и <code>edit.html.erb</code> представлений, используя партиал из <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:new_edit_partial">Листинга&nbsp;10.43</a>. Обратите внимание, на то, что вам придется передать пременную формы&nbsp;<code>f</code> в виде явной локальной переменной, как показано в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:new_user_with_partial">Листинге&nbsp;10.44</a>.</li>

<li>Зарегистрированным пользователям совершенно незачем иметь доступ к <code>new</code> и <code>create</code> действиям контроллера Users. Организуйте  для таких пользователей переадресацию  в корневой URL, при попытке обратиться к этим страницам.</li>

<li>Добавьте тесты, проверяющие что удаляющие ссылки в <a class="ref" href="updating-showing-and-deleting-users?version=3.0#code:delete_links">Листинге&nbsp;10.38</a> появляются для администраторов, но не для обычных пользователей.</li>

<li>Модифицируйте действие <code>destroy</code> так, чтобы предотвратить уничтожение административными пользователями самих себя. (Начните с написания теста.)</li>

</ol>




<div class="label" id="code:new_edit_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.43.</span> <span class="description">Партиал для new и edit полей формы. <br /> <code>app/views/users/_fields.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:new_user_with_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 10.44.</span> <span class="description">Представление new user с партиалом. <br /> <code>app/views/users/new.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="ss">:f</span> <span class="o">=&gt;</span> <span class="n">f</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Sign up&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="sign-in-sign-out?version=3.0#top">
    &laquo;&nbsp;<span class="number">Глава 9</span> Войти, выйти
  </a>
  <a class="next_page" href="user-microposts?version=3.0#top">
    <span class="number">Глава 11</span> Микросообщения пользователей&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:10.1">Изображение взято на <a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a>.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.1">&uarr;</a></li>
<li id="fn:10.2">Сайт Gravatar на самом деле переадресует на <a href="http://en.gravatar.com/emails"><tt>http://en.gravatar.com/emails</tt></a>, предназначенную для англоговорящих пользователей, но я опустил <tt>en</tt> часть для возможного использования других языков.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.2">&uarr;</a></li>
<li id="fn:10.3">Изображение взято на <a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a>.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.3">&uarr;</a></li>
<li id="fn:10.4">Не беспокойтесь о том, как это работает, детали, представляют интерес для разработчиков самого фреймворка Rails, но по замыслу не имеют значения для разработчиков Rails приложений.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.4">&uarr;</a></li>
<li id="fn:10.5">Код в этом разделе это адаптация (переделка) гема <a href="http://github.com/thoughtbot/clearance">Clearance</a> команды разработчиков <a href="http://thoughtbot.com/">thoughtbot</a>.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.5">&uarr;</a></li>
<li id="fn:10.6">Действительно, как отмечалось в <a class="ref" href="sign-in-sign-out?version=3.0#sec:sign_in_out_exercises">Разделе&nbsp;9.6</a>, <code>session</code> реализуется именно этим способом.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.6">&uarr;</a></li>
<li id="fn:10.7">Фотография ребенка из <a href="http://www.flickr.com/photos/glasgows/338937124/">http://www.flickr.com/photos/glasgows/338937124/</a>.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.7">&uarr;</a></li>
<li id="fn:10.8">Технически, нам требуется создать только 28 дополнительных "сфабрикованных" пользователей, так как три пользователя у нас уже есть, но я считаю создание 30 более однозначным.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.8">&uarr;</a></li>
<li id="fn:10.9">Имя <code>user</code> непринципиально&nbsp;&mdash;&nbsp;мы могли бы написать <code>@users.each do |foobar|</code>, а затем использовать <code>render foobar</code>. Ключом является <em>класс</em> объекта&nbsp;&mdash;&nbsp;в данном случае, <code>User</code>.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.9">&uarr;</a></li>
<li id="fn:10.10">Метод <code>toggle!</code> вызывает колбэки Active Record но не валидации, так что мы должны установить атрибут <code>password</code> (но не подтверждение) с тем чтобы иметь не чистый пароль в обратном вызове <code>encrypt_password</code>.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.10">&uarr;</a></li>
<li id="fn:10.11">Инструменты командной строки, такие как <tt>curl</tt> (см. <a class="ref" href="static-pages?version=3.0#sidebar:response_codes">Блок&nbsp;3.2</a>) могут выдавать <tt>PUT</tt> запросы этой формы.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.11">&uarr;</a></li>
<li id="fn:10.12">Это означает, что ссылки на удаление не будут работать если у пользователя нет (или отключен) JavaScript. Если вы обязаны поддерживать браузеры без включенного JavaScript, вы можете подделать запрос <tt>DELETE</tt> используя форму и запрос <tt>POST</tt>, что будет работать даже в отсутствие JavaScript; см. об этом более подробно Railscast на &ldquo;<a href="http://railscasts.com/episodes/77-destroy-without-javascript">Destroy Without JavaScript</a>&rdquo;.&nbsp;<a class="arrow" href="?version=3.0#fnref:10.12">&uarr;</a></li>
</ol>
</div>

